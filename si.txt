package dav.pymes.moduloCrearTx;

import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.function.Supplier;

import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;
import java.io.File;
import java.io.FileInputStream;
import java.io.IOException;

import org.apache.poi.ss.usermodel.DataFormatter;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.xssf.usermodel.XSSFSheet;
import org.apache.poi.xssf.usermodel.XSSFWorkbook;

import dav.middlePymes.PageInicioMiddle;
import dav.pymes.PagePortalPymes;
import dav.transversal.DatosDavivienda;
import library.common.Util;
import library.core.BasePageWeb;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsRun;
import screens.actions.consulta.StratusProductos;

public class PageOrigen extends BasePageWeb {

    // ========================== Locators/constants ==========================
    private static final int DEFAULT_TIMEOUT = 120;
    private static final int SHORT_TIMEOUT = 30;

    private static final By LOC_PASO_PAGE = By.xpath("//td[@class='TituloRojo']/b[text()='Origen']");
    private static final By LOC_TIT_TAB_OR = By.xpath("//td[@class='TituloRojo'][text()='Producto Origen de los Fondos:']");
    private static final By LOC_TIT_TAB_OR_AUT = By.xpath("//td[@class='TituloRojo'][text()='Producto origen de los fondos:   ']");
    private static final By LOC_TIPO_PRUEBA_FIC = By.xpath("./parent::td/following-sibling::td[1]");
    private static final By LOC_BTN_SIG = By.xpath("//input[contains(@value, 'Siguiente')]");
    private static final By LOC_BTN_CONSULTAS_EXTRACTOS = By.xpath("//*[@id='lblMasterAlerta']/a[1]");
    private static final By LOC_BTN_DATOS_ADENDA = By.xpath("//*[@id='cphCuerpo_btnMostrarDatos']");
    private static final By LOC_TB_ADENDA = By.xpath("//*[@id='cphCuerpo_gvMovimientosCuentas']");
    private static final By LOC_TB_TX_ADENDA = By.xpath("//*[@id='cphCuerpo_gvTransacciones']");

    private static final String XP_LINK_SERVICIO = "//a[text()='NB_SERVICIO']";
    private static final String XP_RB_ORIGEN = "//td[contains(text(),'NUM_PROD')]//preceding-sibling::td[contains(text(),'TIPO_PROD')]//preceding-sibling::td//input";
    private static final String XP_RB_ORIGEN_AUTO = "(//span[contains(text(),'NUM_PROD')]/../../td[contains(text(),'TIPO_PROD')]/preceding-sibling::td//input)[POS]";
    private static final String XP_RB_ORIGEN_FIC = "//td[contains(text(),'NUM_PROD')]//preceding-sibling::td/input";
    private static final String XP_RB_ORIGEN_FIC_AUTO = "//span[contains(text(),'NUM_PROD')]//preceding-sibling::td/input";
    private static final String XP_SERVICIO = "//select[@id='cphCuerpo_dropEmpresaRecaudo']";
    private static final String XP_SERVICIO_AUT = "//select[@id='cphCuerpo_ddConvenioRecaudos']";
    private static final String XP_LINK_NUM_APROB = "//*[@id='cphCuerpo_gvTransacciones']/tbody/tr/td[2]/a[contains(text(), 'NUM_APROBACION')]";
    private static final String XP_LINK_NOM_PROV = "//*[@id='cphCuerpo_gvTransaccionesMasivas']/tbody/tr[NUM_REGISTRO]/td[6]/a";
    private static final String XP_DATA_NOM_PROV = "//*[@id='cphCuerpo_gvTransaccionesMasivas']/tbody/tr[NUM_REGISTRO]/td[4]";

    // Internacionales
    private static final By IF_INTERN = By.id("cphCuerpo_IframeDivisas");
    private static final By CAMP_MOD_RECIBIR = By.xpath("//li[@onclick][2]");
    private static final By TIT_MO = By.xpath("//h3[text()='Transferencias internacionales']");
    private static final By TB_ORIGEN = By.xpath("//table[@class='table  table-responsive table-condensed table-hover table-bordered mt10']");
    private static final By SEL_CONCEPTO_CAMBIARIO = By.xpath("//select[@id='ConceptoCambiario']");
    private static final By SEL_NUM_CAMBIARIO = By.xpath("//select[@id='Numerales_NumeralCambiario_0']");
    private static final By CAMP_VALOR_IN = By.xpath("//input[@id='Numerales_valor_0']");
    private static final By BTN_SIG_IN = By.xpath("//button[@class='dm-boton-proceso dm-btn-fondo-rojo']");
    private static final By TIT_MO_ABONO = By.xpath("//strong[text()='Cuenta para abono']");
    private static final By TIT_MO_COTIZAR = By.xpath("//strong[text()='Cotizar la transferencia']");
    private static final By TIT_MO_CONFIRM = By.xpath("//strong[text()='Recibir desde el exterior']");

    private static final String XP_NUM_REF_INT = "//tbody/tr[td[contains(text(), 'MONEDA_INTERNACIONAL')] and td[contains(text(), 'NUM_REF_RECI_INTERNACIONAL')]]/th/input[@type='radio']";
    private static final String XP_CTA_DEST_INT = "//tbody/tr[td[contains(text(), 'NUM_PROD')] and td[contains(text(), 'TIPO_PROD')]]/th/input[@type='radio']";

    // Saldos
    private static final String XP_SALDO_DISP_DEFAULT = "//td[contains(text(),'NUMCUENTA')]//preceding-sibling::td[contains(text(),'TIPOCUENTA')]/following-sibling::td/span";
    private static final String XP_SALDO_DISP_MISMO_NIT = "//td[contains(text(),'NUMCUENTA')]//preceding-sibling::td[contains(text(),'TIPOCUENTA')]//following::td[6]";
    private static final String XP_SALDO_DISP_SERV = "//td[contains(text(),'TIPOCUENTA')]//preceding::td[contains(text(),'NUMCUENTA')]/following-sibling::td[1]";
    private static final String XP_SALDO_DISP_SERV2 = "//tr[td[contains(text(),'TIPOCUENTA')] and td[contains(text(),'NUMCUENTA')]]//td[NUM]";

    private static final String[] ARR_TIPO_PROD_NO_FIC = { "AHORRO", "CORRIENTE", "DIPLUS", "EXPRES" };

    // Estado / proceso de pago
    private static final String XP_NUM_ESTADO_PAGO = "(//*[@id='formPincipal:tablaResultadoConsultaPagos']/tbody/tr/td[2][contains(text(),'NUM_PROCESO_PAGO')])";
    private static final By BTN_BUSCAR_ESTADO_PROC = By.xpath("//*[@id='formPincipal:buscar']");

    // ========================== State ==========================
    private static String saldoTotalInicial = null;
    private static String saldoDispoInicial = null;
    private static String saldoTotalFinal = null;
    private static String saldoDispoFinal = null;

    private final PageInicioMiddle pageInicioMiddle;
    private final PagePortalPymes pagePortalPymes;

    // ========================== Ctor ==========================
    public PageOrigen(BasePageWeb parentPage) {
        super(parentPage);
        this.pageInicioMiddle = new PageInicioMiddle(parentPage);
        this.pagePortalPymes = new PagePortalPymes(parentPage);
    }

    // ========================== Public API ==========================
    /** Navega al link del servicio. Retorna null si OK, o mensaje de error. */
    public String irAServicio(String servicio) throws Exception {
        String nbLink = mapServicioToLink(servicio);
        WebElement link = element(XP_LINK_SERVICIO.replace("NB_SERVICIO", nbLink));
        if (link == null) {
            Evidence.saveAllScreens("ErrorNoServicio", this);
            return "No se encuentra el link para el servicio [" + servicio + "] -- Se buscó [" + nbLink + "]";
        }
        click(link);
        return null;
    }

    /** Selecciona un producto origen (flujo normal) y continúa. */
    public String seleccionarOrigen(String servicio, String tipoDocumento, String numeroDoc, String tipoProducto,
                                    String numeroProducto) throws Exception {
        if (!ensureOnOrigenStep()) return failAndShot("No se detectó la pantalla 'Origen'");
        Evidence.saveFullPage("Origen", this);

        WebElement rb = findOrigenRadio(tipoProducto, numeroProducto, false, null);
        if (rb == null) return prodNoEncontrado(tipoProducto, numeroProducto);

        Util.wait(3);
        click(rb);
        Evidence.saveFullPage("ProductoOrigen", this);
        Util.wait(3);
        click(LOC_BTN_SIG);
        return null;
    }

    /** Selecciona un producto origen por posición (flujo automático). */
    public String seleccionarOrigenAutomatico(String tipoProducto, String numeroProducto, String posicion) throws Exception {
        if (!ensureOnOrigenStep()) return failAndShot("No se detectó la pantalla 'Origen' (auto)");

        WebElement rb = findOrigenRadio(tipoProducto, numeroProducto, true, posicion);
        if (rb == null) return prodNoEncontrado(tipoProducto, numeroProducto);

        click(rb);
        Evidence.saveFullPage("ProductoOrigen" + posicion, this);
        return null;
    }

    /** Selección con convenio (Servicio a pagar). */
    public String seleccionarOrigen(String servicio, String tipoDocumento, String numeroDoc, String numConvenio,
                                    String tipoProducto, String numeroProducto) throws Exception {

        if (!ensureOnOrigenStep()) return failAndShot("No se detectó la pantalla 'Origen' (con convenio)");

        String msg = null;
        if (element(XP_SERVICIO) != null) {
            String selecc = "- " + numConvenio; // así se muestra en UI
            msg = selectListContainsItems(By.xpath(XP_SERVICIO), selecc);
            // Validaciones con STRATUS si aplica (se deja igual para no romper flujo)
            if (!DatosDavivienda.IS_RISKMOTOR && DatosDavivienda.STRATUS != null) {
                DatosDavivienda.STRATUS.consultarConvenio(selecc, new String[] { "NUMERO ID", "NOMBRE CONV", "OF RADIC", "TIP REC" });
            }
        }
        if (msg == null || !msg.isEmpty()) return "Error en lista 'Servicio a pagar' : " + msg;

        // Espera tabla orígenes
        if (waitForDisplayed(LOC_TIT_TAB_OR, SHORT_TIMEOUT) == null) {
            String alert = pagePortalPymes.getMsgAlertIfExist("lblMasterAlerta");
            if (alert != null) return "Error en lista 'Servicio a pagar' : " + alert;
        }
        return seleccionarOrigen(servicio, tipoDocumento, numeroDoc, tipoProducto, numeroProducto);
    }

    /** Selección automática con convenio y opcional segundo producto. */
    public String seleccionarOrigenAuto(String numConvenio, String tipoProducto, String numeroProducto,
                                        String tipoProductoSec, String numeroProductoSec) throws Exception {

        if (!ensureOnOrigenStep()) return failAndShot("No se detectó la pantalla 'Origen' (auto+convenio)");

        String msg = null;
        if (element(XP_SERVICIO_AUT) != null) {
            msg = selectListContainsItems(By.xpath(XP_SERVICIO_AUT), numConvenio);
        }
        if (msg == null || !msg.isEmpty()) return "Error en lista 'Servicio a pagar' : " + msg;

        // esperar el título tabla “Automáticos”
        if (waitForDisplayed(LOC_TIT_TAB_OR_AUT, SHORT_TIMEOUT) == null) {
            Reporter.reportEvent(Reporter.MIC_FAIL, "TimeOut esperando tabla de orígenes automáticos");
            return "No se presentó el título de orígenes automáticos";
        }

        String err = seleccionarOrigenAutomatico(tipoProducto, numeroProducto, "1");
        Util.wait(2);

        if (err == null && !isEmpty(tipoProductoSec) && !isEmpty(numeroProductoSec)) {
            err = seleccionarOrigenAutomatico(tipoProductoSec, numeroProductoSec, "2");
        }
        click(LOC_BTN_SIG);
        return err;
    }

    // ========================== Internacionales ==========================
    public void TxInternacionalesOrigen() throws Exception {
        if (waitForDisplayed(IF_INTERN, SHORT_TIMEOUT) == null) return;

        Evidence.saveAllScreens("Transferencias Int", this);
        WebElement iframe = element(IF_INTERN);
        getDriver().switchTo().frame(iframe);

        if (waitForDisplayed(CAMP_MOD_RECIBIR, SHORT_TIMEOUT) == null) return;
        click(CAMP_MOD_RECIBIR);
        pagePortalPymes.closeActiveIntAlert();

        seleccionarOrigenInter("1707SWF584", "JPY"); // (respeta tu flujo actual)

        if (waitForEnabled(SEL_CONCEPTO_CAMBIARIO, SHORT_TIMEOUT)) {
            selectListItem(SEL_CONCEPTO_CAMBIARIO, "5 - Servicios, transferencias y otros conceptos");
        }

        // Si se selecciona 5/4 usa numeral 1070
        if (waitForEnabled(SEL_NUM_CAMBIARIO, SHORT_TIMEOUT)) {
            pagePortalPymes.seleOption(SEL_NUM_CAMBIARIO, "1070");
        }
        click(BTN_SIG_IN);
    }

    public String seleccionarOrigenInter(String numRef, String moneda) throws Exception {
        // aseguramos pantalla correcta
        if (!waitAnyDisplayed(new By[] { TIT_MO, TB_ORIGEN }, SHORT_TIMEOUT)) {
            return "No se encontró pantalla de 'Transferencias internacionales'.";
        }
        Evidence.saveAllScreens("Recibir", this);

        if (waitForDisplayed(TB_ORIGEN, DEFAULT_TIMEOUT) == null) return "No se presentó tabla de orígenes.";

        String xp = XP_NUM_REF_INT.replace("NUM_REF_RECI_INTERNACIONAL", numRef).replace("MONEDA_INTERNACIONAL", moneda);
        WebElement rb = element(By.xpath(xp));
        if (rb == null) {
            Evidence.saveFullPage("Error-ProdOrigen", this);
            return "Número de referencia externa [" + numRef + " - " + moneda + "] NO encontrado";
        }
        if (!waitFor(() -> rb.isDisplayed() && rb.isEnabled(), SHORT_TIMEOUT)) return "Radio no interactuable";
        click(rb);
        return null;
    }

    public String seleccionarCuenta(String tipoProducto, String numeroProducto) throws Exception {
        if (waitForDisplayed(TIT_MO_ABONO, SHORT_TIMEOUT) == null) return "No se detectó 'Cuenta para abono'";

        String tipo = normalizeTipoProductoCuenta(tipoProducto);
        String xp = XP_CTA_DEST_INT.replace("NUM_PROD", Util.right(numeroProducto, 4)).replace("TIPO_PROD", tipo);
        WebElement rb = element(xp);

        if (rb == null) {
            Evidence.saveFullPage("Error-ProdOrigen", this);
            return "Producto  [" + tipoProducto + " - " + numeroProducto + "] NO encontrado";
        }
        if (!waitFor(() -> rb.isDisplayed() && rb.isEnabled(), SHORT_TIMEOUT)) return "Radio no interactuable";

        click(rb);
        Evidence.saveFullPage("Producto seleccionado", this);
        Util.wait(4);
        click(BTN_SIG_IN);
        return null;
    }

    public void Cotizacion() throws Exception {
        if (waitForDisplayed(TIT_MO_COTIZAR, SHORT_TIMEOUT) == null) return;
        Evidence.saveFullPage("Cotizacion", this);
        Util.wait(1);
        click(BTN_SIG_IN);
    }

    // ========================== Adenda / Portal ==========================
    public void TransferenciaPortalDetalleReferencia(String detalleVacio) throws Exception {
        String dataDescripcion = SettingsRun.getTestData().getParameter("Descripcion").trim();
        String dataReferencia = SettingsRun.getTestData().getParameter("Referencia").trim();

        Evidence.saveAllScreens("3", this);

        String detalle;
        String referencia;

        // según servicio, cambia ids
        if (detalleVacio.equals("Pago de Nóminas") || detalleVacio.equals("Pago a Proveedores")) {
            referencia = textOrEmpty(By.xpath("//*[@id='cphCuerpo_lblEjecutadoReferencia']"));
            detalle = textOrEmpty(By.xpath("//*[@id='cphCuerpo_lblEjecutadoDescripcion']"));
        } else {
            referencia = textOrEmpty(By.xpath("//*[@id='cphCuerpo_lblERReferencia']"));
            detalle = textOrEmpty(By.xpath("//*[@id='cphCuerpo_lblERDescripcion']"));
        }

        assertEqualsOrExpectedEmpty("Descripcion", detalle, dataDescripcion, detalleVacio);
        assertEqualsOrExpectedEmpty("Referencia", referencia, dataReferencia, "000000000000000000000000");
    }

    public void NotaDebitoDetalleReferencia(String detalleVacio) throws Exception {
        String dataDescripcion = SettingsRun.getTestData().getParameter("Descripcion").trim();
        String dataReferencia  = SettingsRun.getTestData().getParameter("Referencia").trim();

        Evidence.saveAllScreens("2", this);
        Util.wait(1);

        String detalle = textOrFail(By.xpath("//*[@id='cphCuerpo_lblCDDetalle']"));
        String referencia = textOrFail(By.xpath("//*[@id='cphCuerpo_lblCDReferencia']"));

        assertEqualsOrExpectedEmpty("Descripcion", detalle, dataDescripcion, detalleVacio);
        assertEqualsOrExpectedEmpty("Referencia", referencia, dataReferencia, "000000000000000000000000");
    }

    public void TranferenciaPortalAdenda(String descripcion, String detalleVacio) throws Exception {
        String msgError = pageInicioMiddle.irAOpcion("Transacciones Realizadas en el Portal PYME", "Consultas",
                "Transacciones a Través del Portal");

        String servicio = SettingsRun.getTestData().getParameter("Servicio").trim();
        String numAprobacion = SettingsRun.getTestData().getParameter("Número Aprobación").trim();

        String xpNumAprob = XP_LINK_NUM_APROB.replace("NUM_APROBACION", numAprobacion);

        waitForDisplayed(LOC_BTN_CONSULTAS_EXTRACTOS, SHORT_TIMEOUT);
        clickSafe(LOC_BTN_CONSULTAS_EXTRACTOS);

        waitForDisplayed(LOC_BTN_DATOS_ADENDA, SHORT_TIMEOUT);
        click(LOC_BTN_DATOS_ADENDA);

        waitForDisplayed(LOC_TB_TX_ADENDA, SHORT_TIMEOUT);
        Util.wait(2);

        boolean encontrado;
        try {
            click(element(xpNumAprob));
            encontrado = true;
        } catch (Exception e) {
            encontrado = false;
            Reporter.reportEvent(Reporter.MIC_PASS, "Registro no encontrado con número de aprobación " + numAprobacion);
        }

        Evidence.saveAllScreens("1", this);
        Reporter.reportEvent(Reporter.MIC_PASS, "------Cuenta Origen------");
        Util.wait(2);

        if (encontrado && !servicio.equals("Pago a Proveedores") && !servicio.equals("Nómina")) {
            Evidence.saveAllScreens("2", this);
            TransferenciaPortalDetalleReferencia(detalleVacio);
            return;
        }

        if (encontrado) {
            // Caso nómina / proveedores: iterar filas
            int i = 2;
            while (true) {
                pageInicioMiddle.irAOpcion("Transacciones Realizadas en el Portal PYME", "Consultas",
                        "Transacciones a Través del Portal");

                waitForDisplayed(LOC_BTN_DATOS_ADENDA, SHORT_TIMEOUT);
                click(By.xpath(xpNumAprob)); // vuelve a abrir

                String xpLinkNom = XP_LINK_NOM_PROV.replace("NUM_REGISTRO", String.valueOf(i));
                String xpDataNom = XP_DATA_NOM_PROV.replace("NUM_REGISTRO", String.valueOf(i));

                Util.wait(2);

                if (element(xpLinkNom) != null) {
                    String dataNom = textOrEmpty(By.xpath(xpDataNom));
                    Reporter.reportEvent(Reporter.MIC_PASS, "......" + dataNom + "......");
                    Util.wait(2);
                    click(By.xpath(xpLinkNom));
                    Util.wait(2);
                    TransferenciaPortalDetalleReferencia(detalleVacio);
                    i++;
                } else {
                    break;
                }
            }
        } else {
            Reporter.reportEvent(Reporter.MIC_FAIL, "No se encuentra el registro de la transacción");
        }
    }

    // ========================== Proceso/Estado de Pago ==========================
    public void RevisionProOrdenesDePago(String numProcesoPago, String nomProcesoPago, String cantPagos,
                                         String valorPagos, String convenioPago) throws Exception {

        Date hoy = new Date();
        String today = Util.dateToString(Util.dateAdd(hoy, Calendar.DAY_OF_MONTH, 0), "dd/mm/yyyy");
        String manana = Util.dateToString(Util.dateAdd(hoy, Calendar.DAY_OF_MONTH, 1), "dd/mm/yyyy");

        String xpBase = "//*[@id='formPincipal:tablaResultadoConsultaProcesos']/tbody/tr[NUM]/td[1][contains(text(),'NUM_PROCESO_PAGO')]";
        xpBase = xpBase.replace("NUM_PROCESO_PAGO", numProcesoPago);

        click(By.xpath("//*[@id='formMenu:consultas']"));
        click(By.xpath("//*[@id='formMenu:conProcPago']"));
        waitForDisplayed(BTN_BUSCAR_ESTADO_PROC, SHORT_TIMEOUT);
        Util.wait(1);
        Evidence.save("Ventana de proceso de pago", this);
        click(BTN_BUSCAR_ESTADO_PROC);

        String rowPrefix = findRowPrefix(xpBase, 3);
        if (rowPrefix == null) SettingsRun.exitTestIteration();

        // Helpers de comparación
        compareEquals("Fecha Vencimiento", textOrEmpty(By.xpath(rowPrefix + "/td[3]")), manana);
        compareEquals("Fecha Creación",  textOrEmpty(By.xpath(rowPrefix + "/td[2]")), today);
        compareEquals("Fecha Aprobación",textOrEmpty(By.xpath(rowPrefix + "/td[10]")), today);
        compareEquals("Número Proceso",  textOrEmpty(By.xpath(rowPrefix + "/td[1]")), numProcesoPago);
        compareEquals("Estado",          textOrEmpty(By.xpath(rowPrefix + "/td[5]")), "No Enviado");
        compareEquals("Nombre Proceso",  textOrEmpty(By.xpath(rowPrefix + "/td[4]")), nomProcesoPago);
        compareEquals("Cantidad pagos",  textOrEmpty(By.xpath(rowPrefix + "/td[6]")), cantPagos);

        String valorUI = textOrEmpty(By.xpath(rowPrefix + "/td[7]")).replace("$", "").replace(",", "").replace(".", "");
        if (valorUI.contains(valorPagos)) {
            Reporter.write("*** PASSED :: Valor total de pago correcta");
        } else {
            Reporter.write("*** FAIL :: Valor total de pago incorrecta");
        }

        containsEquals("Convenio de pago", textOrEmpty(By.xpath(rowPrefix + "/td[8]")), convenioPago);

        Evidence.save("Registro en Proceso de Pago encontrado", this);
    }

    public void RevisionEstOrdenesDePago(String numProcesoPago, String cantidadPagos, String convenioPago) throws Exception {
        String xpBase = XP_NUM_ESTADO_PAGO.replace("NUM_PROCESO_PAGO", numProcesoPago);

        click(By.xpath("//*[@id='formMenu:consultas']"));
        click(By.xpath("//*[@id='formMenu:conEstadosPago']"));
        waitForDisplayed(BTN_BUSCAR_ESTADO_PROC, SHORT_TIMEOUT);
        Util.wait(1);
        Evidence.save("Ventana en Estado de Pago", this);

        int total = Integer.parseInt(cantidadPagos);
        DataFormatter formatter = new DataFormatter();

        for (int i = 1; i <= total; i++) {
            Reporter.write("*** WARNING ------ --------FILA " + i + " ----------");

            String[] fila = ExtraerDatosDe2doExcel(i + 1, formatter);
            click(BTN_BUSCAR_ESTADO_PROC);

            String xpItem = xpBase + "[" + i + "]";
            String xpNum = xpItem.replace("td[2]", "td[2]");

            if (!waitForDisplayed(By.xpath(xpNum), SHORT_TIMEOUT).isDisplayed()) {
                Reporter.write("No se encuentra el registro con número de proceso: " + numProcesoPago);
                SettingsRun.exitTestIteration();
            }

            compareEquals("Número de proceso", textOrEmpty(By.xpath(xpNum)), numProcesoPago);
            compareEquals("Id Beneficiario", textOrEmpty(By.xpath(xpItem.replace("td[2]", "td[3]").replace(numProcesoPago, ""))), fila[1]);
            compareEquals("Beneficiario", textOrEmpty(By.xpath(xpItem.replace("td[2]", "td[4]").replace(numProcesoPago, ""))), fila[2]);
            compareEquals("Destino", textOrEmpty(By.xpath(xpItem.replace("td[2]", "td[6]").replace(numProcesoPago, ""))), "PAGO NACIONAL");
            containsEquals("Convenio", textOrEmpty(By.xpath(xpItem.replace("td[2]", "td[7]").replace(numProcesoPago, ""))), convenioPago);

            String valorUI = textOrEmpty(By.xpath(xpItem.replace("td[2]", "td[8]").replace(numProcesoPago, "")))
                    .replace("$", "").replace(",", "").replace(".", "");
            if (valorUI.contains(fila[8])) {
                Reporter.write("*** PASSED :: Valor correcto");
            } else {
                Reporter.write("*** FAIL :: Valor incorrecto");
            }
        }
        Evidence.save("Registro en Estado de Pago encontrado", this);
    }

    // ========================== Excel ==========================
    /** Igual a tu método pero robusto: usa DataFormatter y try-with-resources. */
    public String[] ExtraerDatosDe2doExcel(int fila, DataFormatter formatter) {
        String ruta = SettingsRun.getTestData().getParameter("Archivo Destinos");
        String[] valores = new String[14];

        try (FileInputStream fis = new FileInputStream(new File(ruta));
             XSSFWorkbook wb = new XSSFWorkbook(fis)) {

            XSSFSheet sheet = wb.getSheetAt(0);
            Row row = sheet.getRow(fila - 1);
            if (row == null) return valores;

            for (int i = 0; i < 13; i++) {
                String val = formatter.formatCellValue(row.getCell(i));
                valores[i] = val != null ? val : "";
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
        return valores;
    }

    // Overload para compatibilidad con código existente
    public String[] ExtraerDatosDe2doExcel(int fila) throws Exception {
        return ExtraerDatosDe2doExcel(fila, new DataFormatter());
    }

    // ========================== Stratus (limpieza ligera, lógica intacta) ==========================
    public void validacionSaldosStratus(String servicio, String tipoDocumento, String numeroDoc,
                                        String tipoCta, String numCta, boolean saldoOrigen) throws Exception {

        String saldoDis = null;
        String saldoDisponible = null;
        List<String> saldosCredi = new ArrayList<>();

        StratusProductos stratus = new StratusProductos(SettingsRun.getGlobalData("STRATUS.usuario"),
                                                        SettingsRun.getGlobalData("STRATUS.password"));

        if (saldoOrigen) {
            if (!containsAny(servicio, "Servicios")) {
                if (!containsAny(servicio, "Mismo NIT", "TC")) {
                    saldoDis = getText(element(
                            XP_SALDO_DISP_DEFAULT.replace("NUMCUENTA", Util.right(numCta, 4)).replace("TIPOCUENTA", tipoCta)));
                } else if (!tipoCta.contains("Familiares")) {
                    saldoDis = getText(element(
                            XP_SALDO_DISP_MISMO_NIT.replace("NUMCUENTA", Util.right(numCta, 4)).replace("TIPOCUENTA", tipoCta)));
                }
                if (tipoCta.contains("Familiares")) {
                    saldoDis = getText(element(
                            XP_SALDO_DISP_SERV2.replace("NUMCUENTA", Util.right(numCta, 4)).replace("TIPOCUENTA", tipoCta).replace("NUM", "5")));
                }
                saldoDisponible = normalizeMoney(saldoDis);
            } else {
                saldoDis = getText(element(
                        XP_SALDO_DISP_SERV2.replace("NUMCUENTA", Util.right(numCta, 4)).replace("TIPOCUENTA", tipoCta).replace("NUM", "4")));
                saldoDisponible = normalizeMoney(saldoDis);
            }

            if (!tipoCta.contains("CREDITO")) {
                List<WebElement> lista = findElements(By.xpath(
                        XP_SALDO_DISP_DEFAULT.replace("NUMCUENTA", Util.right(numCta, 4)).replace("TIPOCUENTA", "Crediexpress")));
                for (WebElement el : lista) {
                    saldosCredi.add(normalizeMoney(el.getText()));
                }
            }
        }

        // Normalizaciones y consultas
        String pref = Util.left(numCta, 3);
        if ((containsAny(tipoCta, "DIPLUS", "diplus")) && pref.equals("056")) {
            tipoCta = "CREDITO";
            String[] datos = stratus.getCtaCobroCrediplus(numCta);
            tipoCta = datos[0];
            if (tipoCta.contains("AH")) tipoCta = "CC";
        } else if ((containsAny(tipoCta, "DIPLUS", "diplus")) && !pref.equals("056")) {
            tipoCta = "CREDITO";
            String[] datos = stratus.getCtaCobroCrediplus(numCta);
            tipoCta = datos[0];
            numCta = datos[1];
        }
        if (containsAny(tipoCta, "ompanita", "emp pyme 22")) tipoCta = "CREDITO";

        String[] saldos = stratus.getDatosPantallaSaldos(tipoDocumento, numeroDoc, tipoCta, numCta);
        if (saldos == null) return;

        if (saldos[0].contains("OFICINA RECAUDO O RADICACION NO EXISTE") || saldos[0].contains("TARJETA NO EXISTE")) {
            Reporter.reportEvent(Reporter.MIC_INFO, "El Número de cuenta: " + numCta + " " + saldos[0]);
            return;
        }

        if (saldoOrigen) {
            setSaldosIniciales(tipoCta, saldos);
            logSaldos("Inicial", tipoCta, saldoDisponible, saldosCredi);
        } else {
            setSaldosFinales(tipoCta, saldos);
            logSaldos("Final", tipoCta, saldoDisponible, saldosCredi);
        }
    }

    public String getSaldoTotalInicialOrigen()  { return saldoTotalInicial; }
    public String getSaldoDispoInicialOrigen()  { return saldoDispoInicial; }
    public String getSaldoTotalFinalOrigen()    { return saldoTotalFinal; }
    public String getSaldoDispoFinalOrigen()    { return saldoDispoFinal; }

    // ========================== Helpers ==========================
    private boolean ensureOnOrigenStep() {
        return waitForDisplayed(LOC_PASO_PAGE, SHORT_TIMEOUT) != null;
    }

    private String prodNoEncontrado(String tipoProducto, String numeroProducto) {
        Evidence.saveFullPage("Error-ProdOrigen", this);
        return "Producto origen [" + tipoProducto + " - " + numeroProducto + "] NO encontrado";
    }

    private WebElement findOrigenRadio(String tipoProducto, String numeroProducto, boolean automatico, String pos) {
        String upper = tipoProducto == null ? "" : tipoProducto;
        boolean isFIC = upper.toUpperCase().contains("FIC");
        String last4 = Util.right(numeroProducto, 4);
        String tipo = normalizeTipoProducto(upper);

        if (!isFIC) {
            String base = automatico ? XP_RB_ORIGEN_AUTO : XP_RB_ORIGEN;
            String xp = base.replace("NUM_PROD", last4).replace("TIPO_PROD", tipo);
            if (automatico && pos != null) xp = xp.replace("POS", pos);
            return element(xp);
        } else {
            String base = automatico ? XP_RB_ORIGEN_FIC_AUTO : XP_RB_ORIGEN_FIC;
            String xp = base.replace("NUM_PROD", last4);
            List<WebElement> radios = findElements(By.xpath(xp));
            for (WebElement el : radios) {
                String tipoTab = getText(element(el, LOC_TIPO_PRUEBA_FIC));
                if (!Util.itemContainsAnyArrayItem(tipoTab.toUpperCase(), ARR_TIPO_PROD_NO_FIC)) {
                    return el;
                }
            }
            return null;
        }
    }

    private String mapServicioToLink(String servicio) {
        String s = servicio == null ? "" : servicio;
        if (containsAny(s, "Nómi", "Nomi")) return "Nómina";
        if (containsAny(s, "Prove")) return "Proveedores";
        if (containsAny(s, "AFC")) return "Cuentas AFC";
        if (containsAny(s, "Serv", "Fact")) return "Pago de factura";
        if (containsAny(s, "Pagos Automaticos", "Automaticos")) return "Programación pagos automáticos";
        if (containsAny(s, "NIT")) return "Entre productos Davivienda del mismo NIT";
        if (containsAny(s, "Cuenta No Inscrita", "Cuenta NO Inscrita")) return "Hacia un tercero con cuenta NO inscrita";
        if (containsAny(s, "Cuenta Inscrita")) return "Hacia un tercero con cuenta inscrita";
        if (containsAny(s, "Propios")) return "Sus Productos Davivienda";
        if (containsAny(s, "Avance")) return "Avances Tarjeta de Crédito";
        if (containsAny(s, "créditos", "terceros", "Crédito.3ros", "Créditos", "Terceros")) return "Créditos de terceros";
        if (containsAny(s, "Internacionales", "internacionales", "Divisas Documentos y Formularios")) return "Transferencias Internacionales";
        if (containsAny(s, "ORPA")) return "Órdenes de Pago";
        return "NO HAY LINK DISPONIBLE";
    }

    private String normalizeTipoProducto(String tipo) {
        String up = tipo == null ? "" : tipo.trim();
        if (up.contains("AHORROS") || up.contains("ahorros")) return "ahorro";
        if (up.contains("CORRIENTE") || up.contains("corriente")) return "corriente";
        if (up.contains("DIPLUS") || up.contains("diplus")) return "diplus";
        if (up.contains("EXPRES") || up.contains("rediexpress")) {
            if (up.contains("rediexpress") && up.contains("ompanita")) return "ompanita";
            if (up.contains("rediexpress") && up.contains("emp pyme 22")) return "emp pyme 22";
            return "rediexpress";
        }
        if (up.contains("Agropecuaria") || up.contains("agropecuaria")) return "Tarjetas agropecuaria";
        if (up.contains("DINERS")) return "Tarjeta Diners Empresarial";
        if (containsAny(up, "Clásica Mastercard", "clásica mastercard", "Clasica Mastercard", "clasica mastercard")) return "Clásica Mastercard";
        if (up.contains("MASTERCARD") || up.contains("mastercard")) return "Empresarial mastercard";
        if (up.toUpperCase().contains("VISA")) return "Empresarial visa";
        if (containsAny(up, "FAMILIARES", "familiares", "Familiares")) return "Tarjeta crédito sociedades familiares";
        if (up.contains("Garantizada Platinum Visa")) return "Garantizada Platinum Visa";
        if (up.contains("Tarjeta Visa Signature")) return "Tarjeta Visa Signature";
        return " ";
    }

    private String normalizeTipoProductoCuenta(String tipo) {
        String up = tipo == null ? "" : tipo.toUpperCase();
        if (up.contains("AHORROS")) return "AHORROS";
        if (up.contains("DIPLUS")) return "diplus";
        if (up.contains("EXPRES")) return "rediexpress";
        if (up.contains("AGROPECUARIA")) return "Tarjetas agropecuaria";
        if (up.contains("DINERS")) return "Tarjeta Diners Empresarial";
        if (up.contains("MASTERCARD")) return "Empresarial mastercard";
        if (up.contains("VISA")) return "Empresarial visa";
        if (up.contains("FAMILIARES")) return "Tarjeta crédito sociedades familiares";
        return "CORRIENTE";
    }

    private WebElement waitForDisplayed(By locator, int seconds) {
        for (int i = 0; i < seconds; i++) {
            WebElement el = element(locator);
            if (el != null && el.isDisplayed()) return el;
            Util.wait(1);
        }
        return null;
    }

    private boolean waitForEnabled(By locator, int seconds) {
        for (int i = 0; i < seconds; i++) {
            WebElement el = element(locator);
            if (el != null && el.isDisplayed() && el.isEnabled()) return true;
            Util.wait(1);
        }
        return false;
    }

    private boolean waitFor(Supplier<Boolean> condition, int seconds) {
        for (int i = 0; i < seconds; i++) {
            try { if (Boolean.TRUE.equals(condition.get())) return true; } catch (Exception ignored) {}
            Util.wait(1);
        }
        return false;
    }

    private boolean waitAnyDisplayed(By[] locators, int seconds) {
        for (int i = 0; i < seconds; i++) {
            for (By by : locators) {
                WebElement el = element(by);
                if (el != null && el.isDisplayed()) return true;
            }
            Util.wait(1);
        }
        return false;
    }

    private void assertEqualsOrExpectedEmpty(String field, String actual, String expected, String emptyReplacement) {
        if (!isEmpty(expected)) {
            if (expected.equals(actual)) {
                Reporter.reportEvent(Reporter.MIC_PASS, "Adenda correcta en " + field);
            } else {
                Reporter.reportEvent(Reporter.MIC_FAIL, "Adenda incorrecta en " + field);
            }
        } else {
            if (actual.equals(emptyReplacement)) {
                Reporter.reportEvent(Reporter.MIC_PASS, "Adenda correcta en " + field);
            } else {
                Reporter.reportEvent(Reporter.MIC_FAIL, "Adenda incorrecta en " + field);
            }
        }
    }

    private String textOrEmpty(By by) {
        WebElement el = element(by);
        return el == null ? "" : el.getText();
    }

    private String textOrFail(By by) throws Exception {
        WebElement el = waitForDisplayed(by, SHORT_TIMEOUT);
        if (el == null) {
            Reporter.reportEvent(Reporter.MIC_FAIL, "No se encuentra el elemento: " + by.toString());
            throw new Exception("Elemento no encontrado: " + by);
        }
        return el.getText();
    }

    private boolean clickSafe(By by) {
        try { click(by); return true; } catch (Exception e) { return false; }
    }

    private String findRowPrefix(String xpBase, int maxRows) {
        for (int i = 1; i <= maxRows; i++) {
            String candidate = xpBase.replace("tr[NUM]", "tr[" + i + "]");
            if (element(candidate) != null) {
                return candidate.replace("/td[1][contains(text(),'", "");
            }
        }
        return null;
    }

    private void compareEquals(String label, String actual, String expected) {
        if (expected.equals(actual)) {
            Reporter.write("*** PASSED :: " + label + " correcta");
            Reporter.write("*** PASSED ------ " + actual);
            Reporter.write("*** PASSED ------ " + expected);
        } else {
            Reporter.write("*** FAIL :: " + label + " incorrecta");
            Reporter.write("*** FAIL ------ " + actual);
            Reporter.write("*** FAIL ------ " + expected);
        }
    }

    private void containsEquals(String label, String actual, String expectedPart) {
        if (actual.contains(expectedPart)) {
            Reporter.write("*** PASSED :: " + label + " correcto");
        } else {
            Reporter.write("*** FAIL :: " + label + " incorrecto");
        }
    }

    private static boolean containsAny(String s, String... needles) {
        if (s == null) return false;
        for (String n : needles) if (s.contains(n)) return true;
        return false;
    }

    private static boolean isEmpty(String s) { return s == null || s.trim().isEmpty(); }

    private static String normalizeMoney(String s) {
        if (s == null) return "";
        return s.replace("$ ", "").replace(".", "").replace(",", ".");
    }

    private void setSaldosIniciales(String tipoCta, String[] saldos) {
        if (containsAny(tipoCta, "ahorro", "AH")) {
            saldoTotalInicial = saldos[0].replace("$ ", "");
            saldoDispoInicial = saldos[1].replace("$ ", "");
        } else if (containsAny(tipoCta, "corriente", "CC")) {
            saldoTotalInicial = saldos[6].replace("$ ", "");
            saldoDispoInicial = saldos[0].replace("$ ", "");
        } else if (tipoCta.contains("CREDITO")) {
            saldoTotalInicial = saldos[7].replace("$ ", "");
            saldoDispoInicial = saldos[2].replace("$ ", "");
        } else if (tipoCta.contains("Familiares")) {
            saldoDispoInicial = saldos[0].replace("$ ", "");
            saldoTotalInicial = saldos[1].replace("$ ", "");
        }
    }

    private void setSaldosFinales(String tipoCta, String[] saldos) {
        if (containsAny(tipoCta, "ahorro", "AH")) {
            saldoTotalFinal = saldos[0].replace("$ ", "");
            saldoDispoFinal = saldos[1].replace("$ ", "");
        } else if (containsAny(tipoCta, "corriente", "CC")) {
            saldoTotalFinal = saldos[6].replace("$ ", "");
            saldoDispoFinal = saldos[0].replace("$ ", "");
        } else if (tipoCta.contains("CREDITO")) {
            saldoTotalFinal = saldos[7].replace("$ ", "");
            saldoDispoFinal = saldos[2].replace("$ ", "");
        } else if (tipoCta.contains("Familiares")) {
            saldoTotalFinal = saldos[0].replace("$ ", "");
            saldoDispoFinal = saldos[1].replace("$ ", "");
        }
    }

    private void logSaldos(String etapa, String tipoCta, String saldoDisponiblePortal, List<String> saldosCredi) {
        if (!tipoCta.contains("CREDITO")) {
            Reporter.reportEvent(Reporter.MIC_INFO,
                    "Saldo Total " + etapa + " (stratus): " + (etapa.equals("Inicial") ? saldoTotalInicial : saldoTotalFinal).replace(".", ","));
            Reporter.reportEvent(Reporter.MIC_INFO,
                    "Saldo Disponible " + etapa + " (stratus): " + (etapa.equals("Inicial") ? saldoDispoInicial : saldoDispoFinal).replace(".", ","));
        } else {
            Reporter.reportEvent(Reporter.MIC_INFO,
                    "Cupo disponible Credi " + etapa + " (stratus): " + (etapa.equals("Inicial") ? saldoTotalInicial : saldoTotalFinal).replace(".", ","));
            Reporter.reportEvent(Reporter.MIC_INFO,
                    "Saldo Credi " + etapa + " (stratus): " + (etapa.equals("Inicial") ? saldoDispoInicial : saldoDispoFinal).replace(".", ","));
        }
    }
}
