package ControllerPyme;

import java.io.File;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;
import java.util.Set;

import dav.ActualizacionDeDatos.PageActualizacionDeDatos;
import dav.CobrosMiddle.PageAdminCombosCobros;
import dav.Consultas_Y_Extractos.PageConsultasyExtractos;
import dav.TransaccionesProgramadas.PageTransaccionesProgramadas;
import dav.divisas.PageConsultatxInternacional;
import dav.library.common.DatosEmpresarial;
import dav.middlePymes.ControllerValiPymeMiddle;
import dav.middlePymes.PageUsuariosEmpresa;
import dav.pymes.PageLoginPymes;
import dav.pymes.PagePortalPymes;
import dav.pymes.moduloCrearTx.ControllerCrearTx;
import dav.pymes.moduloTx.PageAdminParametros;
import dav.pymes.moduloTx.PageOrigen;
import dav.transversal.DatosDavivienda;
import library.common.Util;
import library.core.Controller;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsRun;

public class ControllerTestNomProve implements Controller {

	PageLoginPymes pageLoginPyme;
	PagePortalPymes pagePortalPymes;
	PageOrigen pageOrigen;
	ControllerCrearTx controller;
	PageConsultasyExtractos pageConsultasyExtractos;

	String clienteEmpresarial, tipoIdentificación, idUsuario, clavePersonaloCVE, tipoToken, Semilla, tipoIDEmpresa,
			numeroIDEmpresa, nombreEmpresa, servicio, tipProductoOrigen, numeroProductoOrigen, archivoDestinostxt;

	String msgError;
	Date fechaHoraLogMR;

	@Override
	public void destroy() {
		// TODO Auto-generated method stub

	}

	public void cargarDatosNom() throws Exception {
		// Datos login
		clienteEmpresarial = SettingsRun.getTestData().getParameter("Cliente Empresarial");
		tipoIdentificación = SettingsRun.getTestData().getParameter("Tipo Identificación");
		idUsuario = SettingsRun.getTestData().getParameter("Id usuario");
		clavePersonaloCVE = SettingsRun.getTestData().getParameter("Clave personal o CVE");
		tipoToken = SettingsRun.getTestData().getParameter("Tipo Token");
		Semilla = SettingsRun.getTestData().getParameter("Semilla / Valor Estático / Celular");

		// Datos flujos
		tipoIDEmpresa = SettingsRun.getTestData().getParameter("Tipo ID Empresa");
		numeroIDEmpresa = SettingsRun.getTestData().getParameter("Numero ID Empresa");
		nombreEmpresa = SettingsRun.getTestData().getParameter("Nombre Empresa");
		servicio = SettingsRun.getTestData().getParameter("Servicio");
		tipProductoOrigen = SettingsRun.getTestData().getParameter("Tipo producto origen / Franquicia");
		numeroProductoOrigen = SettingsRun.getTestData().getParameter("Número producto origen");
		archivoDestinostxt = SettingsRun.getTestData().getParameter("Archivo Destinos txt");
		DatosEmpresarial.AMBIENTE_TEST = mapAmbiente(SettingsRun.getGlobalData("AMBIENTE_PYME"));

	}

	public void doingTest() throws Exception {
		cargarDatosNom();
		flujoSoloFront();

	}

	public void flujoSoloFront() throws Exception {

		File archivo = new File(archivoDestinostxt);
		boolean existe = false;
		// SI EXISTE, SE CORROBORA QUE SEA DIRECTORY
		if (archivo.exists())
			existe = archivo.isFile();

		loadLoginFrontDataAndReport();

		pageLoginPyme = new PageLoginPymes();
		msgError = pageLoginPyme.loginFront();
		fechaHoraLogMR = pageLoginPyme.getFechaHoraLogMR();

		if (!switchToPopupOrFail())
			return;

		flujoFrontTransaccional();

		pageLoginPyme.closeAllBrowsers();

	}

	private String[] loadLoginFrontDataAndReport() throws Exception {
		DatosEmpresarial.loadLoginData("Cliente Empresarial", "Tipo Identificación", "Id usuario",
				"Clave personal o CVE", "Tipo Token", "Semilla / Valor Estático / Celular");
		String[] datosLogin = DatosEmpresarial.getLoginData();
		Reporter.write("Datos de Logueo Front: [" + Util.arrayToString(datosLogin, " - ") + "]");
		return datosLogin;
	}

	private boolean switchToPopupOrFail() throws Exception {
		Util.wait(5);
		Set<String> handles = pageLoginPyme.getDriver().getWindowHandles();
		List<String> ventanas = new ArrayList<>(handles);
		if (ventanas.size() >= 2) {
			String first = ventanas.get(0);
			String second = ventanas.get(1);
			Reporter.write("Primera venta: " + first + "/r Segunda venta: " + second);
			pageLoginPyme.getDriver().switchTo().window(first);
			Util.wait(2);
			pageLoginPyme.getDriver().close();
			pageLoginPyme.getDriver().switchTo().window(second);
			return true;
		} else {
			Reporter.reportEvent(Reporter.MIC_FAIL, "No se abrio la segunda pestaña");
			SettingsRun.exitTestIteration();
			return false;
		}
	}

	private void flujoFrontTransaccional() throws Exception {
		pageOrigen = new PageOrigen(pageLoginPyme);
		pagePortalPymes = new PagePortalPymes(pageLoginPyme);
		String msgError = null;
		try {
			pagePortalPymes.changeToDefaultFrame();
			msgError = pagePortalPymes.seleccionarEmpresa(nombreEmpresa);
			if (msgError != null) {
				Reporter.write(msgError);
			}
		} catch (Exception e) {
			pagePortalPymes.changeToFirstFrame();
			msgError = pagePortalPymes.seleccionarEmpresa(nombreEmpresa);
			if (msgError != null) {
				Reporter.write(msgError);
			}
		}

		transar();
	}

	public void transar() throws Exception {
		controller = new ControllerCrearTx(pageLoginPyme);

		controller.crearPagoNomina_Proveedores(false);

//		horaFecha = controller.getHora();
		postAprobacionUnaFirma();

		pageLoginPyme.changeToDefaultFrame();
		pageLoginPyme.CerrarSesionFront();
		SettingsRun.exitTestIteration();
	}

	private String mapAmbiente(String raw) throws Exception {
		if (raw == null)
			return "";
		switch (raw) {
		case "1":
		case "PROYECTOS":
			return "PROYECTOS";
		case "2":
		case "CONTENCION":
			return "CONTENCION";
		case "3":
		case "OBSOLESCENCIA":
			return "OBSOLESCENCIA";
		case "4":
		case "ONPREMISE":
			return "ONPREMISE";
		case "5":
		case "POST_NUBE":
			return "POST_NUBE";
		case "6":
		case "CONTENCION_NUBE":
			return "CONTENCION_NUBE";
		case "7":
		case "PROYECTOS_NUBE":
			return "PROYECTOS_NUBE";
		case "8":
		case "PROYECTOS_SO":
			return "PROYECTOS_SO";
		case "9":
		case "MEJORAS":
			return "MEJORAS";
		default:
			Reporter.reportEvent(Reporter.MIC_FAIL, "Opción de ambiente no válida: " + raw);
			SettingsRun.exitTestIteration();
			return raw;
		}
	}

	public void postAprobacionUnaFirma() throws Exception {
		boolean internacionales = false;

		if (!servicio.contains("Internacionales") && !servicio.contains("Divisas")
				&& !servicio.contains("Pagos Automaticos") && !servicio.contains("ORPA")) {
			pageConsultasyExtractos = new PageConsultasyExtractos(pageLoginPyme);
			String tipoProduct = SettingsRun.getTestData().getParameter("Tipo producto origen / Franquicia").trim();
			String numeroProducto = SettingsRun.getTestData().getParameter("Número producto origen").trim();

			pageConsultasyExtractos.ConsultayExtractos(servicio, "CHROME", tipoIDEmpresa, numeroIDEmpresa,
					tipoIdentificación, idUsuario, tipoProduct, numeroProducto, false, null);
		}
	}
}
