package launchTest;

import java.util.*;
import org.openqa.selenium.By;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import dav.ActualizacionDeDatos.PageActualizacionDeDatos;
import dav.CobrosMiddle.ControllerMiddleCobros;
import dav.CobrosMiddle.PageAdminCombosCobros;
import dav.Consultas_Y_Extractos.PageConsultasyExtractos;
import dav.TransaccionesProgramadas.PageTransaccionesProgramadas;
import dav.application.PortalPyme;
import dav.c360.PageInicioC360;
import dav.c360.PageLogin;
import dav.divisas.PageAprobacionInter;
import dav.divisas.PageConsultatxInternacional;
import dav.divisas.PageDivisas;
import dav.divisas.PageDocumentos_Y_Formularios;
import dav.dxcStratus.DXCStratus;
import dav.transversal.DatosDavivienda;
import dav.transversal.MotorRiesgo;
import dav.transversal.MovimientosXTransaccion.ValidadorMovimientos;
import dav.library.common.DatosEmpresarial;
import dav.library.common.DavUtil;
import dav.library.reporting.EvidencePdfFile;
import dav.middlePymes.ControllerValiPymeMiddle;
import dav.middlePymes.PageUsuariosEmpresa;
import dav.pymes.PageLoginPymes;
import dav.pymes.PagePortalPymes;
import dav.pymes.moduloCrearTx.ControllerCrearTx;
import dav.pymes.moduloCrearTx.ControllerDestinosMasivos;
import dav.pymes.moduloTx.PageAdminParametros;
import dav.pymes.moduloTx.PageOrigen;

import dxc.util.DXCUtil;
import library.common.Util;
import library.core.BasePageWeb;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsResources;
import library.settings.SettingsRun;
import orquestadorBack.stratus.GestorBack;
import screens.actions.consulta.StratusProductos;

/**
 * PymeFlowController
 *
 * Implementa toda la lógica que antes vivía en LaunchTestPyme.
 * Comportamiento y efectos secundarios idénticos al original.
 */
public class PymeFlowController {

    // ============================== Constantes negocio
    private static final String TP_LOGIN = "Login";
    private static final String TP_EN_LINEA = "Tx En Línea";
    private static final String TP_PEND_APR = "Tx Pend Aprobación";

    private static final String CN_APRO_PEND = "1";
    private static final String DETALLE_SI = "SI";

    private static final Set<String> SRV_NOM_PROV = setOf("Nómina", "Pago de Nómina", "Pago de Nóminas",
            "Pago a Proveedores", "Pagos a proveedores", "Pagos proveedores", "Proveedores", "AFC",
            "Pago a Créditos de Terceros", "Pagos a créditos de terceros", "Crédito.3ros");
    private static final Set<String> SRV_INTERNACIONAL = setOf("Tx Internacionales Recibir desde el exterior",
            "Tx Internacionales Enviar al exterior", "Tx Internacionales Enviar al exterior Pendiente Aprobación",
            "Consulta Tx Internacionales Enviar al exterior Validar Estado");

    private static Set<String> setOf(String... v) {
        return new HashSet<>(Arrays.asList(v));
    }

    // ============================== Pages & Controllers (igual que original)
    PageLoginPymes pageLoginPyme;
    PagePortalPymes pagePortalPymes;
    PageOrigen pageOrigen;
    PageDivisas pageDivisas;
    PageUsuariosEmpresa pageUsuariosEmpresa;
    PageAdminParametros pageAdminParametros;
    PageConsultasyExtractos pageConsultasyExtractos;
    ControllerCrearTx controller;
    ControllerDestinosMasivos controllerDestinosMasivos;
    ControllerValiPymeMiddle controllerValiPymeMiddle;
    PageAprobacionInter pageAprobInter;
    PageConsultatxInternacional pageConsultatxInternacional;
    PageDocumentos_Y_Formularios pageDocumentos_Y_Formularios;
    PageTransaccionesProgramadas pageTransaccionesProgramadas;
    ControllerMiddleCobros controllerMiddleCobros;
    PageAdminCombosCobros pageAdminCombosCobros;
    PageActualizacionDeDatos pageActualizacionDeDatos;
    PageLogin pageLoginC360;
    PageInicioC360 pageInicioC360;
    StratusProductos instanciaStratus;
    GestorBack gestorBack;

    // ============================== Locators / By
    private static final By LOG_30 = By.xpath("/html/body/h2[1]/p");
    private static final By LOC_CERRAR = By.xpath("//*[@id='CerrarSesion']");
    private static final By LOC_CERRAR_CSS = By.cssSelector("a[id='CerrarSesion']");
    private static final By LOC_FECHA = By.xpath("//*[@id='tabla-top']/tbody/tr[1]/td[1]");
    private static final By LOC_IP = By.xpath("/html/body/pre");

    // ============================== Estado / Datos
    private String nombreAmbiente, usuario, contratacion, cobros, stratus;
    public static String realizarMR, ipPublica;
    private Date fechaHoraLogMR;

    private String tipoPrueba, desde_el_Detalle, servicio, riesgoBc, riesgoEfm, riesgo, userAgent, empresa,
            tipoIDEmpresa, numeroIDEmpresa, tipoIdentificacion, Idusuario, numAprobaciones, informe;

    private String numCliEmp, tipoDoc, numDoc, clave, tipoTok, datoTok;

    private String tipoConstaTxRealizadas, ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda, fechaTx, horaTx,
            fechaDesde, fechaHasta, valorTx, horaFecha;

    private String lastNumAprobaciones = "";
    private String lastTipoAbono = "";
    private String lastCtaInscrita = "";
    private String lastIdusuario = "";
    private String lastempresa = "";
    private String validarCliente = "";

    private List<HashMap<String, String>> resultsMiddle = new ArrayList<>();
    private HashMap<String, Double> segmentosStratus = new HashMap<>();

    private double[] validacionDescuento;
    private String[] estadotxFinal;
    private final String Motorna = "N/A";

    // ============================== Utilidad interna
    private static boolean isEmptySafe(String s) {
        return s == null || s.trim().isEmpty();
    }

    private static String requireParam(String value, String name) {
        if (isEmptySafe(value))
            throw new IllegalStateException("Falta parámetro obligatorio: " + name);
        return value.trim();
    }

    private static void reportInfo(String msg) {
        Reporter.reportEvent(Reporter.MIC_INFO, msg);
    }

    private static void reportFail(String msg) {
        Reporter.reportEvent(Reporter.MIC_FAIL, msg);
    }

    private static void reportPass(String msg) {
        Reporter.reportEvent(Reporter.MIC_PASS, msg);
    }

    // ============================== Initialize (migrado)
    public void initializeControllerAndConfiguration() throws Exception {
        Reporter.writeTitle("\n*** PRUEBAS PORTAL PYME ***");
        dxc.util.DXCUtil.startWinAppDriver();

        SettingsRun.ARRAY_DATA_PARAMS = new String[] { "Selección", "Tx Finalizada", "Tx FAIL" };

        nombreAmbiente = mapAmbiente(SettingsRun.getGlobalData("AMBIENTE_PYME"));
        if (isEmptySafe(nombreAmbiente)) {
            reportFail("Nombre del ambiente seleccionado: Portal - " + nombreAmbiente);
        } else {
            Reporter.reportEvent(Reporter.MIC_HEADER, "Nombre del ambiente seleccionado: Portal - " + nombreAmbiente);
        }
        DatosEmpresarial.AMBIENTE_TEST = nombreAmbiente;

        contratacion = SettingsRun.getGlobalData("CONTRATACION");
        realizarMR = SettingsRun.getGlobalData("MOTOR.motorDeRiesgo");
        if ("NO".equals(realizarMR)) {
            cobros = SettingsRun.getGlobalData("VALIDACION.COBROS");
            stratus = SettingsRun.getGlobalData("VALIDAR.STRATUS");
        } else {
            cobros = "NO";
            stratus = "NO";
        }

        servicio = requireParam(SettingsRun.getTestData().getParameter("Servicio"), "Servicio");
        valorTx = requireParam(SettingsRun.getTestData().getParameter("Valor a Pagar / Transferir"),
                "Valor a Pagar / Transferir");
        usuario = requireParam(SettingsRun.getTestData().getParameter("Nombre de Usuario"), "Nombre de Usuario");

        // Parametros Consulta Comprobantes (opcionales)
        loadConsultaComprobantesParams();

        // MR
        if ("SI".equals(realizarMR)) {
            riesgoBc = requireParam(SettingsRun.getTestData().getParameter("Nivel de Riesgo BC"), "Nivel de Riesgo BC");
            riesgoEfm = requireParam(SettingsRun.getTestData().getParameter("Nivel de Riesgo SAS EFM"),
                    "Nivel de Riesgo SAS EFM");
            configurarMotorRiesgoPorServicio(servicio);
        }
    }

    private void loadConsultaComprobantesParams() {
        if (SettingsRun.getTestData().parameterExist("Tiempo de Consulta"))
            tipoConstaTxRealizadas = SettingsRun.getTestData().getParameter("Tiempo de Consulta");
        if (SettingsRun.getTestData().parameterExist("Ordenante / Nombre del beneficiario en el exterior"))
            ordenanteBeneficiario = SettingsRun.getTestData()
                    .getParameter("Ordenante / Nombre del beneficiario en el exterior");
        if (SettingsRun.getTestData().parameterExist("Tipo de Transferencia"))
            tipoTranferencia = SettingsRun.getTestData().getParameter("Tipo de Transferencia");
        if (SettingsRun.getTestData().parameterExist("Estado"))
            estado = SettingsRun.getTestData().getParameter("Estado");
        if (SettingsRun.getTestData().parameterExist("Tipo Moneda"))
            tipoMoneda = SettingsRun.getTestData().getParameter("Tipo Moneda");
        if (SettingsRun.getTestData().parameterExist("Fecha tx"))
            fechaTx = SettingsRun.getTestData().getParameter("Fecha tx");
        if (SettingsRun.getTestData().parameterExist("Hora tx"))
            horaTx = SettingsRun.getTestData().getParameter("Hora tx");
    }

    private void configurarMotorRiesgoPorServicio(String srv) throws Exception {
        DatosDavivienda.IS_RISKMOTOR = true;

        String nbArchivo = MotorRiesgo.preguntarPorArchivoMR();
        boolean esDivisas = srv.equals("Tx Internacionales Recibir desde el exterior")
                || srv.equals("Tx Internacionales Enviar al exterior");

        if (!esDivisas) {
            DatosDavivienda.RISKMOTOR = (nbArchivo == null) ? new MotorRiesgo(DatosDavivienda.CANAL_PYME_FRONT)
                    : new MotorRiesgo(DatosDavivienda.CANAL_PYME_FRONT, nbArchivo);
        } else {
            DatosDavivienda.RISKMOTOR = (nbArchivo == null) ? new MotorRiesgo(DatosDavivienda.CANAL_PYME_FRONT_DIVISAS)
                    : new MotorRiesgo(DatosDavivienda.CANAL_PYME_FRONT_DIVISAS, nbArchivo);
        }
    }

    private String mapAmbiente(String raw) {
        if (raw == null)
            return "";
        switch (raw) {
        case "1":
        case "PROYECTOS":
            return "PROYECTOS";
        case "2":
        case "CONTENCION":
            return "CONTENCION";
        case "3":
        case "OBSOLESCENCIA":
            return "OBSOLESCENCIA";
        case "4":
        case "ONPREMISE":
            return "ONPREMISE";
        case "5":
        case "POST_NUBE":
            return "POST_NUBE";
        case "6":
        case "CONTENCION_NUBE":
            return "CONTENCION_NUBE";
        case "7":
        case "PROYECTOS_NUBE":
            return "PROYECTOS_NUBE";
        case "8":
        case "MEJORAS":
            return "MEJORAS";
        default:
            reportFail("Opción de ambiente no válida: " + raw);
            return raw;
        }
    }

    // ============================== Doing Test (migrado)
    public void doingTest() throws Exception {
        // Riesgo activo: seleccionar fuente de riesgo (EFM/BC)
        if ("SI".equals(realizarMR)) {
            if (!SRV_INTERNACIONAL.contains(servicio)) {
                riesgoBc = requireParam(SettingsRun.getTestData().getParameter("Nivel de Riesgo BC"),
                        "Nivel de Riesgo BC");
                riesgoEfm = requireParam(SettingsRun.getTestData().getParameter("Nivel de Riesgo SAS EFM"),
                        "Nivel de Riesgo SAS EFM");
                riesgo = SettingsRun.getGlobalData("MOTOR.tipoMotor").contains("EFM") ? riesgoEfm : riesgoBc;
            } else {
                riesgoBc = requireParam(SettingsRun.getTestData().getParameter("Nivel de Riesgo BC"),
                        "Nivel de Riesgo BC");
                riesgo = riesgoBc;
            }
        }

        // Cargar credenciales Middle fijas
        DatosEmpresarial.loadLoginDataFija("0", SettingsRun.getGlobalData("MIDDLE.tipoDoc"),
                SettingsRun.getGlobalData("MIDDLE.numeroDeId"), SettingsRun.getGlobalData("MIDDLE.clavePersonal"),
                SettingsRun.getGlobalData("MIDDLE.tipoToken"), SettingsRun.getGlobalData("MIDDLE.numeroToken"));

        String[] datosLoginMiddle = DatosEmpresarial.getLoginData();
        if ("SI".equals(contratacion) || "SOLO".equals(contratacion)) {
            reportInfo("*** Datos de Logueo Middle: [" + Util.arrayToString(datosLoginMiddle, " - ") + "]");
        }

        // map credenciales a variables
        numCliEmp = datosLoginMiddle[0];
        tipoDoc = datosLoginMiddle[1];
        numDoc = datosLoginMiddle[2];
        clave = datosLoginMiddle[3];
        tipoTok = datosLoginMiddle[4];
        datoTok = datosLoginMiddle[5];

        PageLoginPymes.datosMidell(numCliEmp, tipoDoc, numDoc, clave, tipoTok, datoTok);
        PageUsuariosEmpresa.datosMidellToke(datoTok);

        // Parámetros excel comunes
        servicio = requireParam(SettingsRun.getTestData().getParameter("Servicio"), "Servicio");
        tipoPrueba = requireParam(SettingsRun.getTestData().getParameter("Tipo prueba"), "Tipo prueba");
        desde_el_Detalle = requireParam(SettingsRun.getTestData().getParameter("Desde_el_Detalle"),
                "Desde_el_Detalle");
        empresa = requireParam(SettingsRun.getTestData().getParameter("Nombre Empresa"), "Nombre Empresa");
        Idusuario = requireParam(SettingsRun.getTestData().getParameter("Id usuario"), "Id usuario");
        tipoIdentificacion = requireParam(SettingsRun.getTestData().getParameter("Tipo Identificación"),
                "Tipo Identificación");
        tipoIDEmpresa = requireParam(SettingsRun.getTestData().getParameter("Tipo ID Empresa"), "Tipo ID Empresa");
        numeroIDEmpresa = requireParam(SettingsRun.getTestData().getParameter("Numero ID Empresa"),
                "Numero ID Empresa");

        if ("SI".equals(contratacion)) {
            flujoContratacionCompleta();
        } else if ("SOLO".equals(contratacion)) {
            flujoSoloContratar();
        } else if ("NO".equals(contratacion)) {
            flujoSoloFront();
        } else if ("Informe".equals(contratacion)) {
            flujoInforme();
        }

        if (SettingsRun.esIteracionFinal()) {
            // no-op: igual que el original
        }
    }

    // ============================== Flujos Middle/Front (migrados tal cual)
    private void flujoContratacionCompleta() throws Exception {
        String msgError = loginMiddleAndMarkAmbiente();
        if (msgError != null)
            return;

        controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);

        // firmas en middle
        numAprobaciones = requireParam(SettingsRun.getTestData().getParameter("Números de Aprobaciones"),
                "Números de Aprobaciones");
        ejecutarValidacionFirmasMiddle(Integer.parseInt(numAprobaciones));

        // Cobros Middle -> Stratus
        if ("SI".equals(cobros)) {
            controllerMiddleCobros = new ControllerMiddleCobros(pageLoginPyme);
            resultsMiddle = controllerMiddleCobros.consultarCombos();
        }

        pageLoginPyme.CerrarSesionMiddle();

        if ("SI".equals(cobros) && "NO".equals(realizarMR)) {
            LoginStratus();
        }

        Front();
    }

    private void flujoSoloContratar() throws Exception {
        String msgError = loginMiddleAndMarkAmbiente();
        if (msgError != null)
            return;

        controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);

        numAprobaciones = requireParam(SettingsRun.getTestData().getParameter("Números de Aprobaciones"),
                "Números de Aprobaciones");
        ejecutarValidacionFirmasMiddle(Integer.parseInt(numAprobaciones));

        pageLoginPyme.CerrarSesionMiddle();
    }

    private void flujoSoloFront() throws Exception {
        if ("NO".equals(realizarMR) && "SI".equals(this.cobros)) {
            LoginStratus();
            PageLoginPymes tmp = new PageLoginPymes();
            String msgError = tmp.loginMiddle();
            PageLoginPymes.selecionambienteClose("SI");
            if (msgError == null) {
                this.controllerValiPymeMiddle = new ControllerValiPymeMiddle((BasePageWeb) tmp);
                this.controllerMiddleCobros = new ControllerMiddleCobros(tmp);
                this.resultsMiddle = this.controllerMiddleCobros.consultarCombos();
                tmp.CerrarSesionMiddle();
                DXCStratus instCobros = new DXCStratus(this.instanciaStratus);
                this.segmentosStratus = instCobros
                        .irTablaValores((String) ((HashMap) this.resultsMiddle.get(0)).get("Segmento"));
            }
        }
        Front();
    }

    private void flujoInforme() throws Exception {
        String msgError = loginMiddleAndMarkAmbiente();
        if (msgError != null)
            return;

        controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);
        numAprobaciones = requireParam(SettingsRun.getTestData().getParameter("Números de Aprobaciones"),
                "Números de Aprobaciones");
        controllerValiPymeMiddle.ValidacionInformeTransInternacional();
        // Cierre ocurre en launchClose()
    }

    private String loginMiddleAndMarkAmbiente() throws Exception {
        pageLoginPyme = new PageLoginPymes();
        String msgError = pageLoginPyme.loginMiddle();
        pageLoginPyme.selecionambienteClose("SI");
        return msgError;
    }

    private void ejecutarValidacionFirmasMiddle(int numFirmas) throws Exception {
        boolean unaFirma = String.valueOf(numFirmas).equals(CN_APRO_PEND);
        if (unaFirma) {
            controllerValiPymeMiddle.ValidacionMiddlefirmas(1);
            return;
        }
        controllerValiPymeMiddle.ValidacionMiddlefirmas(1);
        for (int i = 2; i <= numFirmas; i++) {
            controllerValiPymeMiddle.ValidacionMiddlefirmas(i);
        }
    }

    // ============================== Front (migrado)
    public void Front() throws Exception {
        validarArchivosPreviosPorServicio(servicio);

        if ("NO".equals(realizarMR)) {
            instanciaStratus = LoginStratus();
            if ("SI".equals(this.cobros))
                cargarSegmentosStratusSiNoExisten();
        }

        DXCUtil.Movercursor();

        String[] datosLogin = loadLoginFrontDataAndReport();
        numAprobaciones = requireParam(SettingsRun.getTestData().getParameter("Números de Aprobaciones"),
                "Números de Aprobaciones");
        reportInfo("*** Números de firmas: [" + numAprobaciones + "]");

        if ("SI".equals(realizarMR)) {
            reportInfoRiesgo();
        }
        reportTipoPruebaYContexto();

        String msgError;
        int intento = 0;

        do {
            pageLoginPyme = servicio.equals("Consulta Tx Internacionales Enviar al exterior Validar Estado")
                        ? new PageLoginPymes(Evidence.getNbEvidenceDirectory())
                    : new PageLoginPymes();

            msgError = pageLoginPyme.loginFront();
            fechaHoraLogMR = pageLoginPyme.getFechaHoraLogMR();
            pageLoginPyme.selecionambienteClose("NO");

            if (DatosDavivienda.IS_RISKMOTOR && msgError != null && !TP_LOGIN.equals(tipoPrueba)) {
                reportFail(" *** No se adiciona a MR >>>" + msgError);
            }

            // Reintento por mensaje “h2/p” (ambiente inestable)
            if (pageLoginPyme.element(LOG_30) != null) {
                pageLoginPyme.NavegadorFront(pageLoginPyme.URL_FRONT);
                intento++;
            }

            if ("SI".equals(realizarMR)) {
                manejarLoginConMR(msgError);
            }

        } while (pageLoginPyme.element(LOG_30) != null && intento < 3);

        if (msgError != null)
            return;

        // Cerrar primera pestaña y dejar la emergente
        if (!switchToPopupOrFail())
            return;

        if (TP_EN_LINEA.equals(tipoPrueba) || TP_PEND_APR.equals(tipoPrueba)) {
            flujoFrontTransaccional();
        } else if (TP_LOGIN.equals(tipoPrueba)) {
            flujoFrontSoloLogin();
        }

        pageLoginPyme.closeAllBrowsers();
    }

    private void validarArchivosPreviosPorServicio(String srv) throws Exception {
        if (SRV_NOM_PROV.contains(srv)) {
            String archivoDest = SettingsRun.getTestData().getParameter("Archivo Destinos");
            if (!DXCUtil.ArchivoExist(archivoDest)) {
                Reporter.reportEvent(Reporter.MIC_NOEXEC, "No se encuentra el archivo destino: " + archivoDest);
                safeCloseAndExit();
            }
        } else if (SRV_INTERNACIONAL.contains(srv) || "Divisas Documentos y Formularios".equals(srv)) {
            String cargueDocu = SettingsRun.getTestData().getParameter("Cargue Archivo Documentos");
            if (!isEmptySafe(cargueDocu)) {
                boolean ok = true;
                for (String path : cargueDocu.split(",")) {
                    if (!DXCUtil.ArchivoExist(path)) {
                        reportInfo("No se encuentra archivo de cargue: " + path);
                        ok = false;
                    }
                }
                if (!ok) {
                    Reporter.reportEvent(Reporter.MIC_NOEXEC, "No se encuentra archivo(s) de cargue: " + cargueDocu);
                    safeCloseAndExit();
                }
            }
        }
    }

    private void cargarSegmentosStratusSiNoExisten() throws Exception {
        String plano = SettingsRun.getParentResultDir() + "Archivo_Segmentos.txt";
        if (DXCUtil.ArchivoExist(plano) && DXCUtil.archivoCreadoOModificadoHoy(plano)) {
            if (controllerDestinosMasivos == null)
                controllerDestinosMasivos = new ControllerDestinosMasivos(null);
            segmentosStratus = controllerDestinosMasivos.LeerArchivoPlano();
            return;
        }
        reportInfo("Validacion Segmento en Stratus");
        DXCStratus inst = new DXCStratus(instanciaStratus);
        HashMap<String, Double> segs = inst.irTablaValores("PYMES");
        if (controllerDestinosMasivos == null)
            controllerDestinosMasivos = new ControllerDestinosMasivos(null);
        controllerDestinosMasivos.CrearArchivoPlano_Segmentos(segs);
        segmentosStratus = segs;
    }

    private String[] loadLoginFrontDataAndReport() throws Exception {
        DatosEmpresarial.loadLoginData("Cliente Empresarial", "Tipo Identificación", "Id usuario",
                "Clave personal o CVE", "Tipo Token", "Semilla / Valor Estático / Celular");
        String[] datosLogin = DatosEmpresarial.getLoginData();
        reportInfo("*** Navegador: [" + SettingsRun.getTestData().getParameter("Navegador").trim() + "]");
        reportInfo("*** Datos de Logueo Front: [" + Util.arrayToString(datosLogin, " - ") + "]");
        return datosLogin;
    }

    private void reportInfoRiesgo() {
        if (!isEmptySafe(riesgoBc) || !isEmptySafe(riesgoEfm)) {
            if (SettingsRun.getGlobalData("MOTOR.tipoMotor").contains("EFM")) {
                reportInfo("*** Tipo de Motor de riesgo : [SAS " + SettingsRun.getGlobalData("MOTOR.tipoMotor") + "]");
            } else {
                reportInfo("*** Motor de riesgo : [" + SettingsRun.getGlobalData("tipoMotor") + "]");
            }
            reportInfo("*** Riesgo BC: [" + riesgoBc + "]");
            if (!SRV_INTERNACIONAL.contains(servicio)) {
                reportInfo("*** Riesgo EFM: [" + riesgoEfm + "]");
            }
        }
    }

    private void reportTipoPruebaYContexto() {
        if (TP_EN_LINEA.equals(tipoPrueba) || TP_PEND_APR.equals(tipoPrueba)) {
            if (!"SOLO".equals(contratacion)) {
                reportInfo("*** Tipo Prueba: [" + tipoPrueba + "]");
                reportInfo("*** Tipo transaccion: [" + servicio + "]");
                reportInfo("*** Empresa: [" + empresa + "]");
                reportInfo("*** Aprobar Desde el detalle: [" + desde_el_Detalle + "]");
            }
        } else if (TP_LOGIN.equals(tipoPrueba) && !"SOLO".equals(contratacion)) {
            reportInfo("*** Tipo Prueba: " + tipoPrueba);
        }
    }

    private void manejarLoginConMR(String msgError) throws Exception {
        if (isEmptySafe(riesgoBc) && isEmptySafe(riesgoEfm))
            return;

        if (tipoPrueba.contains("Login") && msgError != null && msgError.contains("Acceso denegado.En un momento")) {
            DatosDavivienda.RISKMOTOR.setTemporalTime(pageLoginPyme.getFechaHoraLogMR());
            DatosDavivienda.RISKMOTOR.setTemporalMonto("0");

            if (riesgo.equals("Bajo") || riesgo.equals("Medio")) {
                reportFail("Se esperaba Ingreso al portal");
            }
            adicionarRegistroMR("Error en Login");

            pageLoginPyme.closeAllBrowsers();
            SettingsRun.exitTestIteration();
        }
    }

    private boolean switchToPopupOrFail() throws Exception {
        Util.wait(5);
        Set<String> handles = pageLoginPyme.getDriver().getWindowHandles();
        List<String> ventanas = new ArrayList<>(handles);
        if (ventanas.size() >= 2) {
            String first = ventanas.get(0);
            String second = ventanas.get(1);
            Reporter.write("Primera venta: " + first + "/r Segunda venta: " + second);
            pageLoginPyme.getDriver().switchTo().window(first);
            Util.wait(2);
            pageLoginPyme.getDriver().close();
            pageLoginPyme.getDriver().switchTo().window(second);
            return true;
        } else {
            reportFail("No se abrio la segunda pestaña");
            SettingsRun.exitTestIteration();
            return false;
        }
    }

    private void flujoFrontTransaccional() throws Exception {
        pageOrigen = new PageOrigen(pageLoginPyme);
        pagePortalPymes = new PagePortalPymes(pageLoginPyme);
        String msgError = null;
        try {
            pagePortalPymes.changeToDefaultFrame();
            msgError = pagePortalPymes.seleccionarEmpresa(empresa);
            if (msgError != null) {
                Reporter.write(msgError);
            }
        } catch (Exception e) {
            pagePortalPymes.changeToFirstFrame();
            msgError = pagePortalPymes.seleccionarEmpresa(empresa);
            if (msgError != null) {
                Reporter.write(msgError);
            }
        }

        // Configuración Parámetros Generales si cambian
        String tipoAbono = SettingsRun.getTestData().getParameter("Tipo de abono").trim();
        String ctaInscrita = SettingsRun.getTestData().getParameter("Cuentas Inscriptas").trim();
        numAprobaciones = SettingsRun.getTestData().getParameter("Números de Aprobaciones").trim();
        String idUsuarioData = SettingsRun.getTestData().getParameter("Id usuario").trim();

        if (requiereReconfig(idUsuarioData, empresa, numAprobaciones, tipoAbono, ctaInscrita)) {
            if (!"Divisas Documentos y Formularios".equals(servicio)
                    && !"Consulta Tx Internacionales Enviar al exterior Validar Estado".equals(servicio)) {
                pageAdminParametros = new PageAdminParametros(pageLoginPyme);
                msgError = pageAdminParametros.hacerConfiguracion(numAprobaciones, tipoAbono, ctaInscrita);
            } else {
                msgError = "Divisas";
            }
            snapshotConfigKeys(idUsuarioData, empresa, numAprobaciones, tipoAbono, ctaInscrita);
        } else {
            msgError = "Ya se configuro los Parámetros Generales";
        }

        if (SRV_INTERNACIONAL.contains(servicio)) {
            String codigoCIIU = SettingsRun.getTestData().getParameter("Validar CIIU").trim();
            if ("SI".equals(codigoCIIU)) {
                Util.wait(3);
                pageActualizacionDeDatos = new PageActualizacionDeDatos(pageLoginPyme);
                String msg = pageActualizacionDeDatos.InicioActualizacionDatos(false);
                if (msg != null && !msg.equals("Se actualizaron exitosamente los datos de su empresa")) {
                    msg = pageActualizacionDeDatos.MsgAlertaActualizacionDatos();
                    pagePortalPymes.terminarIteracion(Reporter.MIC_FAIL, msg);
                    return;
                } else {
                    reportPass("Se actualizaron exitosamente los datos de su empresa");
                }
            }

            validarCliente = SettingsRun.getTestData().getParameter("ValidarC360");
            if ("SI".equals(validarCliente)) {
                pageInicioC360 = logueoC360();
                pageConsultatxInternacional = new PageConsultatxInternacional(pageInicioC360);
                pageConsultatxInternacional.ValidarCCIU(numeroIDEmpresa);
                Reporter.write("*** Termina la Validación CLIENTE 360 ***");
            }
        }

        if (msgError == null) {
            reportFail("Error de configuración de Parámetros Generales");
            pagePortalPymes.terminarIteracion();
            return;
        }

        transar();
    }

    private boolean requiereReconfig(String idUsuarioData, String empresaData, String numAprob, String tipoAb,
            String ctaIns) {
        return !Objects.equals(idUsuarioData, lastIdusuario) || !Objects.equals(empresaData, lastempresa)
                || !Objects.equals(numAprob, lastNumAprobaciones) || !Objects.equals(tipoAb, lastTipoAbono)
                || !Objects.equals(ctaIns, lastCtaInscrita);
    }

    private void snapshotConfigKeys(String idUsuarioData, String empresaData, String numAprob, String tipoAb,
            String ctaIns) {
        lastIdusuario = idUsuarioData;
        lastempresa = empresaData;
        lastNumAprobaciones = numAprob;
        lastTipoAbono = tipoAb;
        lastCtaInscrita = ctaIns;
    }

    private void flujoFrontSoloLogin() throws Exception {
        // Espera estable de home y cerrar sesión con JS
        waitHomeStable();
        if (pageLoginPyme.isDisplayed(LOC_CERRAR) && pageLoginPyme.isDisplayed(LOC_FECHA)
                && pageLoginPyme.isDisplayed(LOC_CERRAR_CSS)) {
            String script = "document.querySelector('a[id=\"CerrarSesion\"').click();";
            pageLoginPyme.getJse().executeScript(script);
            if ("SI".equals(realizarMR)) {
                DatosDavivienda.RISKMOTOR.setTemporalResultado("Exitosa");
                adicionarRegistroMR("Login");
            }
        }
    }

    private void waitHomeStable() {
        do {
            pageLoginPyme.isDisplayed(LOC_CERRAR_CSS);
            pageLoginPyme.isDisplayed(LOC_CERRAR);
            pageLoginPyme.isDisplayed(LOC_FECHA);
            Util.wait(1);
        } while (pageLoginPyme.element(LOC_FECHA) == null);
    }

    private void safeCloseAndExit() throws Exception {
        if (pageLoginPyme != null && ThereareOpenWindows()) {
            pageLoginPyme.closeAllBrowsers();
        }
        SettingsRun.exitTestIteration();
    }

    // ============================== Front Doble Firma
    public void Frontfirmas(int firmas) throws Exception {
        String msgError;
        int intento = 0;

        DatosEmpresarial.loadLoginData("Cliente Empresarial", "Tipo Identificación " + firmas, "Id usuario " + firmas,
                "Clave personal o CVE " + firmas, "Tipo Token " + firmas,
                "Semilla / Valor Estático / Celular " + firmas);

        do {
            pageLoginPyme = new PageLoginPymes();
            msgError = pageLoginPyme.loginFrontFirmas();
            pageLoginPyme.selecionambienteClose("NO");

            if (pageLoginPyme.element(LOG_30) != null) {
                pageLoginPyme.NavegadorFront(pageLoginPyme.URL_FRONT);
                intento++;
            }
        } while (pageLoginPyme.element(LOG_30) != null && intento < 2);

        if (msgError != null)
            return;

        Util.wait(7);
        if (WaitForNumberOfWindos()) {
            reportPass("La ventana emergente se abrió correctamente");
        } else {
            reportFail("No se abrió La ventana emergente");
            pagePortalPymes.terminarIteracion();
        }

        pageLoginPyme.closeCurrentBrowser();
        pageLoginPyme.changeWindow(pageLoginPyme.accedioAlPortal());
        pageLoginPyme.maximizeBrowser();

        pageOrigen = new PageOrigen(pageLoginPyme);
        pagePortalPymes = new PagePortalPymes(pageLoginPyme);
        msgError = pagePortalPymes.seleccionarEmpresa(empresa);
        if (msgError != null) {
            reportFail(msgError);
            pagePortalPymes.terminarIteracion();
        }
    }

    // ============================== Transaccional
    public void transar() throws Exception {
        controller = (instanciaStratus != null) ? new ControllerCrearTx(pageLoginPyme, instanciaStratus)
                : new ControllerCrearTx(pageLoginPyme);

        if ("SI".equals(realizarMR)) {
            controller.SetPrioridaMr(riesgo);
            userAgent = (String) pageLoginPyme.getJse().executeScript("return navigator.userAgent;");
        }

        boolean primeroGuardar = TP_PEND_APR.equals(tipoPrueba);

        // Router por servicio
        if (SRV_NOM_PROV.contains(servicio)) {
            controller.crearPagoNomina_Proveedores(primeroGuardar);
        } else
            switch (servicio) {
            case "Pago de Servicios":
            case "Servicios":
                controller.crearPagoServicios(primeroGuardar);
                break;
            case "Pagos Automaticos":
                controller.crearPagosAutomaticos(primeroGuardar);
                break;
            case "Transferencias Mismo NIT":
            case "Transferencia NIT Propio":
            case "Mismo NIT":
                controller.crearTranferenciaMismoNit(primeroGuardar);
                break;
            case "Transferencias Cuenta Inscrita":
            case "Cuenta Inscrita":
                controller.crearTransferenciaCtaInscrita(primeroGuardar);
                break;
            case "Transferencias Cuenta No Inscrita":
            case "Transferencias Cuenta NO Inscrita":
            case "Cuenta No Inscrita":
                controller.crearTransferenciaCtaNoInscrita(primeroGuardar);
                break;
            case "ORPA":
                controller.OrdenesDePago();
                break;
            case "Pagos Propios":
                controller.crearPagosPropios(primeroGuardar);
                break;
            case "Avances Tarjeta de Crédito":
            case "Avance TC":
                controller.crearAvanceTC(primeroGuardar);
                break;

            case "Tx Internacionales Recibir desde el exterior":
                controller.Recibirdinerodelexterior(primeroGuardar);
                break;

            case "Tx Internacionales Enviar al exterior":
                controller.EnviarTransferenciasInternacionales(primeroGuardar);
                break;

            case "Tx Internacionales Enviar al exterior Pendiente Aprobación":
                controller.inicioCrearTx();
                controller.EnviarTransferenciasInternacionalesPendAprobacion();
                break;

            case "Divisas Documentos y Formularios":
                flujoDivisasDocumentosYFormularios(primeroGuardar);
                break;

            case "Consulta Tx Internacionales Validar Estado":
                controller.inicioCrearTx();
                pageConsultatxInternacional = new PageConsultatxInternacional(pageLoginPyme);
                pageConsultatxInternacional.ConsultaNumtx(tipoPrueba, empresa, servicio, usuario,
                        tipoConstaTxRealizadas, ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda, fechaTx,
                        horaTx, fechaDesde, fechaHasta, valorTx);
                break;
            }

        horaFecha = controller.getHora();
        boolean desdeDetalle = DETALLE_SI.equals(desde_el_Detalle);

        // Aprobación PENDIENTE (no internacionales)
        if (primeroGuardar && !servicio.contains("Internacionales")
                || (primeroGuardar && !servicio.contains("Internacionales") && DatosDavivienda.IS_RISKMOTOR)) {
            controller.aprobarTxPendiente(desdeDetalle);
        }

        // Aprobación PENDIENTE internacionales
        if (primeroGuardar && servicio.contains("Internacionales") && !servicio.contains("Aprobación")
                || (primeroGuardar && servicio.contains("Internacionales") && DatosDavivienda.IS_RISKMOTOR)) {
            controller.aprobarTxPendienteIntern(desdeDetalle);
        }

        // Firmas y consultas post
        numAprobaciones = requireParam(SettingsRun.getTestData().getParameter("Números de Aprobaciones"),
                "Números de Aprobaciones");
        informe = SettingsRun.getTestData().getParameter("Informes");
        int firmas = Integer.parseInt(numAprobaciones);

        pageConsultasyExtractos = new PageConsultasyExtractos(pageLoginPyme);

        if (!CN_APRO_PEND.equals(numAprobaciones)) {
            // varias firmas
            aprobarConFirmasRestantes(firmas, desdeDetalle);
        } else {
            // una firma
            postAprobacionUnaFirma();
        }

        // Cobros
        if ("SI".equals(cobros)) {
            pageAdminCombosCobros = new PageAdminCombosCobros(pageLoginPyme);
            validacionDescuento = controller.validacionDescuentoTx(resultsMiddle, segmentosStratus, estadotxFinal,
                    PageAdminCombosCobros.getInformacionConsultada());
            procesarCobrosYContadores();
        }

        pageLoginPyme.changeToDefaultFrame();
        pageLoginPyme.CerrarSesionFront();
        SettingsRun.exitTestIteration();
    }

    private void flujoDivisasDocumentosYFormularios(boolean primeroGuardar) throws Exception {
        controller.inicioCrearTx();
        pageDocumentos_Y_Formularios = new PageDocumentos_Y_Formularios(pageLoginPyme);
        pageDivisas = new PageDivisas(pageLoginPyme);

        if (pageDivisas.switchToFrameDivisas()) {
            String msg = pageDocumentos_Y_Formularios.IralModuloDocumetosYFormularios(tipoPrueba, servicio, fechaTx,
                    horaTx, tipoMoneda);
            if (msg != null && !msg.isEmpty()) {
                reportFail(msg);
                pagePortalPymes.terminarIteracion();
                return;
            }

            // Datos – idénticos a tu implementación
            String concepTx = SettingsRun.getTestData().getParameter("Concepto de la transferencia").trim();
            String numCambiario1 = Util.left(SettingsRun.getTestData().getParameter("Numeral cambiario 1"), 4);
            String valorNumeral1 = SettingsRun.getTestData().getParameter("Valor numeral cambiario 1");
            String numCambiario2 = Util.left(SettingsRun.getTestData().getParameter("Numeral cambiario 2"), 4);
            String valorNumeral2 = SettingsRun.getTestData().getParameter("Valor numeral cambiario 2");
            String tipoOperacion = SettingsRun.getTestData().getParameter("Tipo de operación");
            String desInversion = SettingsRun.getTestData().getParameter("Destino de la inversión");
            String opciondeinversion = SettingsRun.getTestData().getParameter("Opción de inversión");
            String deducciones = SettingsRun.getTestData().getParameter("Deducciones");

            String cambiarConcepto = SettingsRun.getTestData().getParameter("Cambiar Concepto de la transferencia");
            String conceptoAcambiar = SettingsRun.getTestData().getParameter("Concepto de la transferencia A Cambiar");
            String numeroDeposito = SettingsRun.getTestData().getParameter("Número de depósito 1");
            String numeroDeclaracion = SettingsRun.getTestData().getParameter("Número de declaración 1");
            String cambiarNumeral1 = SettingsRun.getTestData().getParameter("Cambiar Numeral cambiario 1");
            String numeral1Acambiar = SettingsRun.getTestData().getParameter("Numeral cambiario A Cambiar 1");
            String cambiarDescOp = SettingsRun.getTestData().getParameter("Cambiar Datos Descripción de la operación");

            // Empresa Receptora
            String tipIdRec = SettingsRun.getTestData().getParameter("Empresa receptora - Tipo de identificación");
            String numIdRec = SettingsRun.getTestData().getParameter("Empresa receptora - Número de identificación");
            String dvRec = SettingsRun.getTestData().getParameter("Empresa receptora - Dígito de verificación");
            String nombreRec = SettingsRun.getTestData().getParameter("Empresa receptora - Nombre o razón social");
            String paisRec = SettingsRun.getTestData().getParameter("Empresa receptora - Código país");
            String depRec = SettingsRun.getTestData().getParameter("Empresa receptora - Código departamento");
            String ciudadRec = SettingsRun.getTestData().getParameter("Empresa receptora - Código ciudad");
            String ciiuRec = SettingsRun.getTestData().getParameter("Empresa receptora - Código CIIU");
            String telRec = SettingsRun.getTestData().getParameter("Empresa receptora - Teléfono");
            String dirRec = SettingsRun.getTestData().getParameter("Empresa receptora - Dirección");
            String mailRec = SettingsRun.getTestData().getParameter("Empresa receptora - Correo electrónico");
            String sectorRec = SettingsRun.getTestData().getParameter("Empresa receptora - Sector");
            String tipoEmpRec = SettingsRun.getTestData().getParameter("Empresa receptora - Tipo de empresa");
            String supRec = SettingsRun.getTestData()
                    .getParameter("Empresa receptora - Superintendencia de vigilancia");
            String actRec = SettingsRun.getTestData().getParameter("Empresa receptora - Actividad");
            String regRec = SettingsRun.getTestData().getParameter("Empresa receptora - Tipo de régimen");
            String natRec = SettingsRun.getTestData().getParameter("Empresa receptora  - Naturaleza");

            pageDocumentos_Y_Formularios.EmpresaReceptora(tipIdRec, numIdRec, dvRec, nombreRec, paisRec, depRec,
                    ciudadRec, ciiuRec, telRec, dirRec, mailRec, sectorRec, tipoEmpRec, supRec, actRec, regRec, natRec);

            // Inversionista
            String tipIdInv = SettingsRun.getTestData()
                    .getParameter("Identificación del inversionista - Tipo de identificación");
            String numIdInv = SettingsRun.getTestData()
                    .getParameter("Identificación del inversionista - Número de identificación");
            String dvInv = SettingsRun.getTestData()
                    .getParameter("Identificación del inversionista - Dígito de verificación");
            String nomInv = SettingsRun.getTestData()
                    .getParameter("Identificación del inversionista - Nombre o razón social");
            String paisInv = SettingsRun.getTestData().getParameter("Identificación del inversionista - Código país");
            String depInv = SettingsRun.getTestData()
                    .getParameter("Identificación del inversionista - Código departamento");
            String ciuInv = SettingsRun.getTestData().getParameter("Identificación del inversionista - Código ciudad");
            String ciiuInv = SettingsRun.getTestData().getParameter("Identificación del inversionista - Código CIIU");
            String mailInv = SettingsRun.getTestData()
                    .getParameter("Identificación del inversionista - Correo electrónico");
            String sectorInv = SettingsRun.getTestData().getParameter("Identificación del inversionista - Sector");
            String tipoEmpInv = SettingsRun.getTestData()
                    .getParameter("Identificación del inversionista - Tipo de empresa");
            String supInv = SettingsRun.getTestData()
                    .getParameter("Identificación del inversionista - Superintendencia de vigilancia");
            String natInv = SettingsRun.getTestData().getParameter("Identificación del inversionista - Naturaleza");
            String telInv = SettingsRun.getTestData().parameterExist("Identificación del inversionista - Teléfono")
                    ? SettingsRun.getTestData().getParameter("Identificación del inversionista - Teléfono")
                    : "";
            String dirInv = SettingsRun.getTestData().parameterExist("Identificación del inversionista - Dirección")
                    ? SettingsRun.getTestData().getParameter("Identificación del inversionista - Dirección")
                    : "";

            pageDocumentos_Y_Formularios.Inversionista(tipIdInv, numIdInv, dvInv, nomInv, paisInv, depInv, ciuInv,
                    ciiuInv, mailInv, sectorInv, tipoEmpInv, supInv, natInv, telInv, dirInv);

            // Otros datos + cargue
            String numPrestamoAval = SettingsRun.getTestData().getParameter("Número del préstamo o aval");
            String nombreAcreedor = SettingsRun.getTestData()
                    .getParameter("Nombre del acreedor o el deudor o avalista");
            String nombreDeudorBenef = SettingsRun.getTestData()
                    .getParameter("Nombre del deudor o acreedor / Avalado o beneficiario residente");
            String tipIdDeudor = SettingsRun.getTestData().getParameter("Tipo de identificación del deudor");
            String numIdDeudor = SettingsRun.getTestData().getParameter("Número de identificación del deudor");
            String dvDeudor = SettingsRun.getTestData().getParameter("Dígito de verificación");
            String monedaEst = SettingsRun.getTestData().getParameter("Moneda estipulada");
            String valMonEst = SettingsRun.getTestData().getParameter("Valor moneda estipulada");
            String tasaCambio = SettingsRun.getTestData().getParameter("Tasa de cambio moneda");
            String cambiarValNum1 = SettingsRun.getTestData().getParameter("Cambiar Valor numeral cambiario 1");
            String valNum1Camb = SettingsRun.getTestData().getParameter("Valor numeral cambiario A Cambiar 1");
            String validacionAdicionar = SettingsRun.getTestData().getParameter("Validar Numerales");
            String validacionDian = SettingsRun.getTestData().getParameter("Validacion - DIAN");

            String cargueDocu = SettingsRun.getTestData().getParameter("Cargue Archivo Documentos");
            String[] rutas = isEmptySafe(cargueDocu) ? new String[0] : cargueDocu.split(",");

            String res = pageDocumentos_Y_Formularios.DatosDocumetosYFormularios(concepTx, tipoOperacion, desInversion,
                    opciondeinversion, valorTx, numCambiario1, valorNumeral1, numCambiario2, valorNumeral2, deducciones,
                    cambiarConcepto, conceptoAcambiar, numeroDeposito, numeroDeclaracion, cambiarNumeral1,
                    numeral1Acambiar, cambiarDescOp, numPrestamoAval, nombreAcreedor, nombreDeudorBenef, tipIdDeudor,
                    numIdDeudor, dvDeudor, monedaEst, valMonEst, tasaCambio, cambiarValNum1, valNum1Camb,
                    validacionAdicionar, validacionDian, rutas);

            if (res != null && !res.contains("Documentos enviados exitosamente.")) {
                reportFail(res);
                pagePortalPymes.terminarIteracion();
            }
        }
    }

    private void aprobarConFirmasRestantes(int numFirmas, boolean desdeDetalle) throws Exception {
        pageLoginPyme.CerrarSesionFront();

        for (int i = 2; i <= numFirmas; i++) {
            Frontfirmas(i);
            if (!servicio.contains("Internacionales") && !servicio.contains("Pagos Automaticos")) {
                controller = new ControllerCrearTx(pageLoginPyme);
                if ("SI".equals(realizarMR))
                    controller.SetPrioridaMr(riesgo);
                Util.wait(10);
                controller.aprobarTxPendiente(desdeDetalle);
                if (i == numFirmas)
                    controller.validacionSaldosStratus();

                if (i == numFirmas) {
                    pageConsultasyExtractos = new PageConsultasyExtractos(pageLoginPyme);
                    String tipoProduct = SettingsRun.getTestData().getParameter("Tipo producto origen / Franquicia")
                            .trim();
                    String numeroProducto = SettingsRun.getTestData().getParameter("Número producto origen").trim();
                    pageConsultasyExtractos.ConsultayExtractos(servicio,
                            SettingsRun.getTestData().getParameter("Navegador").trim(), tipoIDEmpresa, numeroIDEmpresa,
                            tipoIdentificacion, Idusuario, tipoProduct, numeroProducto, true, instanciaStratus);
                }
            } else if (servicio.contains("Pagos Automaticos")) {
                pageTransaccionesProgramadas = new PageTransaccionesProgramadas(pageLoginPyme);
                pageTransaccionesProgramadas.ConsultaPagosAutomatico();
            } else { // internacionales
                Util.wait(10);
                controller.aprobarTxPendienteIntern(true);
                if (i == numFirmas) {
                    pageConsultatxInternacional = new PageConsultatxInternacional(pageLoginPyme);
                    if (isEmptySafe(fechaTx) || isEmptySafe(horaTx)) {
                        fechaTx = SettingsRun.getTestData().getParameter("Fecha tx");
                        horaTx = SettingsRun.getTestData().getParameter("Hora tx");
                    }
                    estado = SettingsRun.getTestData().getParameter("Estado");
                    pageConsultatxInternacional.ConsultaNumtx(tipoPrueba, empresa, servicio, usuario,
                            tipoConstaTxRealizadas, ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda,
                            fechaTx, horaTx, fechaDesde, fechaHasta, valorTx);
                    pageConsultatxInternacional.getDriver().switchTo().defaultContent();
                }
            }

            pageLoginPyme.CerrarSesionFront();

            if (i == numFirmas && DatosDavivienda.IS_RISKMOTOR) {
                if (SRV_NOM_PROV.contains(servicio)) {
                    controller.validarIngresoMRDestinosMasivo();
                } else {
                    controller.validarIngresoMR();
                }
            }
        }
    }

    public void postAprobacionUnaFirma() throws Exception {
        boolean internacionales = false;

        if (!servicio.contains("Internacionales") && !servicio.contains("Divisas")
                && !servicio.contains("Pagos Automaticos") && !servicio.contains("ORPA")) {
            pageConsultasyExtractos = new PageConsultasyExtractos(pageLoginPyme);
            String tipoProduct = SettingsRun.getTestData().getParameter("Tipo producto origen / Franquicia").trim();
            String numeroProducto = SettingsRun.getTestData().getParameter("Número producto origen").trim();

            String estadoRet = pageConsultasyExtractos.ConsultayExtractos(servicio,
                    SettingsRun.getTestData().getParameter("Navegador").trim(), tipoIDEmpresa, numeroIDEmpresa,
                    tipoIdentificacion, Idusuario, tipoProduct, numeroProducto, TP_PEND_APR.equals(tipoPrueba), instanciaStratus);

            if ("NO SE ENCONTRARON DATOS".equals(estadoRet)) {
                if (DatosDavivienda.IS_RISKMOTOR) {
                    if (SRV_NOM_PROV.contains(servicio))
                        controller.validarIngresoMRDestinosMasivo();
                    else
                        controller.validarIngresoMR();
                }
                pagePortalPymes.terminarIteracion();
            }
            estadotxFinal = pageConsultasyExtractos.estadoFinalTx();
            if (SRV_NOM_PROV.contains(servicio) && pagePortalPymes.CuentaDesMotor() != null) {
                controller.cuentasDesMotor = pagePortalPymes.CuentaDesMotor();
            }
        } else if (servicio.contains("Pagos Automaticos")) {
            pageTransaccionesProgramadas = new PageTransaccionesProgramadas(pageLoginPyme);
            pageTransaccionesProgramadas.ConsultaPagosAutomatico();

        } else if ((servicio.contains("Internacionales") || servicio.contains("Divisas"))
                && !servicio.contains("Aprobación") && !servicio.contains("Validar")) {

            pageConsultatxInternacional = new PageConsultatxInternacional(pageLoginPyme);
            if (isEmptySafe(fechaTx) || isEmptySafe(horaTx)) {
                fechaTx = SettingsRun.getTestData().getParameter("Fecha tx");
                horaTx = SettingsRun.getTestData().getParameter("Hora tx");
            }
            estado = SettingsRun.getTestData().getParameter("Estado");

            pageConsultatxInternacional.ConsultaNumtx(tipoPrueba, empresa, servicio, usuario, tipoConstaTxRealizadas,
                    ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda, fechaTx, horaTx, fechaDesde,
                    fechaHasta, valorTx);

            if ("SI".equals(stratus))
                pageConsultatxInternacional.ValidacionesStratusConsulta();
            pageConsultatxInternacional.getDriver().switchTo().defaultContent();

            if ("SI".equals(informe)) {
                // Revalida informe en middle (idéntico a tu flujo original)
                reportPass("");
                DatosEmpresarial.loadLoginDataFija("0", numCliEmp, tipoDoc, numDoc, clave, datoTok);
                String[] datosLogin = DatosEmpresarial.getLoginData();
                Reporter.write("Datos de Logueo [" + Util.arrayToString(datosLogin, " - ") + "]");

                pageLoginPyme = new PageLoginPymes();
                String msgError = pageLoginPyme.loginMiddle();
                pageLoginPyme.selecionambienteClose("SI");
                if (msgError == null) {
                    controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);
                    numAprobaciones = SettingsRun.getTestData().getParameter("Números de Aprobaciones").trim();
                    controllerValiPymeMiddle.ValidacionInformeTransInternacional();
                }
            } else {
                pageOrigen.getDriver().switchTo().defaultContent();
                internacionales = true;
            }

        } else if ((servicio.contains("Internacionales") || servicio.contains("Divisas"))
                && servicio.contains("Aprobación") && !servicio.contains("Validar Estado")) {
            pageConsultatxInternacional = new PageConsultatxInternacional(pageLoginPyme);
            if (isEmptySafe(fechaTx) || isEmptySafe(horaTx)) {
                fechaTx = SettingsRun.getTestData().getParameter("Fecha tx");
                horaTx = SettingsRun.getTestData().getParameter("Hora tx");
            }
            estado = SettingsRun.getTestData().getParameter("Estado");
            pageConsultatxInternacional.ConsultaNumtx(tipoPrueba, empresa, servicio, usuario, tipoConstaTxRealizadas,
                    ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda, fechaTx, horaTx, fechaDesde,
                    fechaHasta, valorTx);
        }

        if (DatosDavivienda.IS_RISKMOTOR) {
            if (SRV_NOM_PROV.contains(servicio))
                controller.validarIngresoMRDestinosMasivo();
            else
                controller.validarIngresoMR();
        }
    }

    private void procesarCobrosYContadores() throws Exception {
        double sumaCobros = 0d;
        String tipoCobro = SettingsRun.getTestData().getParameter("Tipo Prueba Cobros");
        String verificarCombo = resultsMiddle.get(0).get("Verificacion Combo");

        boolean tieneCombo = verificarCombo != null && verificarCombo.contains("Empresa tiene combo");

        if ((tipoCobro.equals("COBROS CON COMBOS") && tieneCombo)
                || (tipoCobro.equals("COBROS SIN COMBOS") && tieneCombo)) {

            int totalCantidadTx = Integer.parseInt(resultsMiddle.get(0).get("Cantidad Tx Acumuladas"));
            if (totalCantidadTx > 0) {
                // revalida contadores en middle
                DatosEmpresarial.loadLoginDataFija("0", SettingsRun.getGlobalData("MIDDLE.tipoDoc"),
                        SettingsRun.getGlobalData("MIDDLE.numeroDeId"),
                        SettingsRun.getGlobalData("MIDDLE.clavePersonal"),
                        SettingsRun.getGlobalData("MIDDLE.tipoToken"), SettingsRun.getGlobalData("MIDDLE.numeroToken"));

                pageLoginPyme = new PageLoginPymes();
                String msgError = pageLoginPyme.loginMiddle();
                pageLoginPyme.selecionambienteClose("SI");
                controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);
                controllerMiddleCobros = new ControllerMiddleCobros(pageLoginPyme);

                int[] infoCnt = ControllerCrearTx.getTotalContador();
                controllerMiddleCobros.contadorFinal(infoCnt, verificarCombo);
                pageLoginPyme.CerrarSesionMiddle();

                reportInfo("*** Cobros realizados en esta transacción");
                for (int i = 0; i < validacionDescuento.length; i++) {
                    double valor = validacionDescuento[i];
                    reportInfo("Valor de cobro " + (i + 1) + ": " + valor);
                    sumaCobros += valor;
                }
                reportInfo("*** Total cobros realizados: " + sumaCobros);
            } else {
                reportInfo("No se ha aplicado sumatoria de tx porque no se aplicó ningún descuento");
            }
        } else {
            reportInfo("*** Cobros realizados en esta transacción - Los cobros sin combos no aplican contador");
            for (int i = 0; i < validacionDescuento.length; i++) {
                double valor = validacionDescuento[i];
                reportInfo("Valor de cobro " + (i + 1) + ": " + valor);
                sumaCobros += valor;
            }
            reportInfo("*** Total cobros realizados: " + sumaCobros);
            SettingsRun.exitTestIteration();
        }
    }

    // ============================== MR (API pública intacta)
    public void adicionarRegistroMR(String tx) throws Exception {
        DatosDavivienda.RISKMOTOR.adicionarRegistro();

        DatosDavivienda.RISKMOTOR.setTemporalTime(fechaHoraLogMR);
        DatosDavivienda.RISKMOTOR.setTime();
        DatosDavivienda.RISKMOTOR.setCanal("WEB_PYME");
        DatosDavivienda.RISKMOTOR.setAmbienteDePruebas(nombreAmbiente);

        DatosDavivienda.RISKMOTOR.setMonto();
        DatosDavivienda.RISKMOTOR.setNumeroTx();
        DatosDavivienda.RISKMOTOR.setResultado();
        DatosDavivienda.RISKMOTOR.setObservacion();
        String observa = SettingsRun.getTestData().getParameter("Desde_el_Detalle").trim();
        DatosDavivienda.RISKMOTOR.setObservacion(observa);

        String uuid = SettingsRun.getTestData().getParameter("Hash").trim();
        DatosDavivienda.RISKMOTOR.setHash(uuid);

        if (controller == null && !TP_LOGIN.equals(tipoPrueba)) {
            controller = new ControllerCrearTx(pageLoginPyme);
        }

        servicio = SettingsRun.getTestData().getParameter("Servicio").trim();

        if (!TP_LOGIN.equals(tipoPrueba)) {
            DatosDavivienda.RISKMOTOR.setTransaccion(controller.getTransaccion(tipoPrueba, servicio));
        } else {
            DatosDavivienda.RISKMOTOR.setTransaccion("Login Exitoso");
        }

        String userType = DatosEmpresarial.TIPO_TOKEN.equals(DatosEmpresarial.TOKEN_OTP) ? "Virtual" : "Token";
        String intentos = SettingsRun.getTestData().getParameter("Ingresos Fallidos").trim();
        int intentosFall = Util.isInteger(intentos) ? Integer.parseInt(intentos) : 0;

        DatosDavivienda.RISKMOTOR.setUserType(userType);
        DatosDavivienda.RISKMOTOR.setRisk(riesgoBc);
        if (!servicio.equals("Tx Internacionales Recibir desde el exterior")
                && !servicio.equals("Tx Internacionales Enviar al exterior")) {
            DatosDavivienda.RISKMOTOR.setRiskEFM(riesgoEfm);
        }

        DatosDavivienda.RISKMOTOR.setNumRetosFallidos(intentosFall);
        DatosDavivienda.RISKMOTOR
                .setNavegador_SistemaOperativo(SettingsRun.getTestData().getParameter("Navegador").trim());
        DatosDavivienda.RISKMOTOR.setCliente(DatosEmpresarial.CLI_EMPRESAR);
        DatosDavivienda.RISKMOTOR.setDocumento(DatosEmpresarial.TIPO_ID_LOGUEO, DatosEmpresarial.NUM_ID_LOGUEO);

        if ("Login".equals(tx)) {
            DatosDavivienda.RISKMOTOR.setCuentaOrigen(Motorna);
            DatosDavivienda.RISKMOTOR.setCuentaDestino(Motorna);
            DatosDavivienda.RISKMOTOR.setNumCuentaOrigen(Motorna);
            DatosDavivienda.RISKMOTOR.setNumCuentaDestino(Motorna);
            DatosDavivienda.RISKMOTOR.set_CtaOrigenODestMIGRADA(Motorna);
            DatosDavivienda.RISKMOTOR.setNumTxCanal(Motorna);
            DatosDavivienda.RISKMOTOR.setNumIdEmpresa(Motorna);
        }

        if ("Error en Login".equals(tx)) {
            if ("Bajo".equals(riesgo) || "Medio".equals(riesgo)) {
                DatosDavivienda.RISKMOTOR.setObservacion(
                        "El comportamiento de la prueba no es correcto para el tipo de riesgo - error en login");
            }
            DatosDavivienda.RISKMOTOR.setTemporalResultado("Declinada");
            DatosDavivienda.RISKMOTOR.setResultado();
        }

        reportPass("*** Se adiciona al MR");
    }

    // ============================== Stratus (API pública intacta)
    public StratusProductos LoginStratus() throws Exception {
        if (!"SI".equals(stratus))
            return null;
        if (instanciaStratus == null) {
            instanciaStratus = new StratusProductos(SettingsRun.getGlobalData("STRATUS.usuario"),
                    SettingsRun.getGlobalData("STRATUS.password"));
            reportInfo("Se cargan datos para logueo de Stratus");
        }
        return instanciaStratus;
    }

    // ============================== C360 (API pública intacta)
    public PageInicioC360 logueoC360() throws Exception {
        Reporter.write("*** Validar CLIENTE 360 ***");
        pageLoginC360 = new PageLogin(BasePageWeb.CHROME);
        pageInicioC360 = new PageInicioC360(pageLoginC360);
        pageLoginC360.login360(SettingsRun.getGlobalData("data.c360User"), SettingsRun.getGlobalData("data.c360Pwd"));
        return pageInicioC360;
    }

    // ============================== Utils públicas
    public boolean ThereareOpenWindows() {
        try {
            Set<String> wh = pageLoginPyme.getDriver().getWindowHandles();
            return !wh.isEmpty();
        } catch (Exception e) {
            return false;
        }
    }

    public Boolean WaitForNumberOfWindos() {
        WebDriverWait wait = new WebDriverWait(pageLoginPyme.getDriver(), 30);
        return wait.until(ExpectedConditions.numberOfWindowsToBe(2));
    }

    // ============================== Cierre (migrado)
    public void launchClose() {
        try {
            SettingsRun.CREATE_FINAL_EVIDENCES_WHEN_NOPDF = false;
            if (DatosDavivienda.RISKMOTOR != null && SettingsRun.esIteracionFinal())
                DatosDavivienda.RISKMOTOR.cerrarMotorRiesgo();

            if (pageLoginPyme != null && ThereareOpenWindows())
                pageLoginPyme.closeAllBrowsers();

            if (instanciaStratus != null)
                instanciaStratus.closeStratus();
        } catch (Exception e) {
            Reporter.reportEvent(Reporter.MIC_FAIL, "Error en cierre: " + e.getMessage());
        }
    }
}
