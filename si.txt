package launchTest;

import java.util.Date;
import java.util.Properties;

import org.openqa.selenium.By;

import dav.Consultas_Y_Extractos.PageConsultasyExtractos;
import dav.TransaccionesProgramadas.PageTransaccionesProgramadas;
import dav.inscripciones.PageInscripcionesCuenta;
import dav.middlePymes.*;
import dav.pymes.PageLoginPymes;
import dav.pymes.moduloCrearTx.ControllerCrearTx;
import dav.pymes.moduloTx.PageAdminParametros;
import dav.pymes.moduloTx.PageOrigen;
import dav.transversal.DatosDavivienda;
import dav.transversal.DatosEmpresarial;
import dav.transversal.MotorRiesgo;

import dxc.dav.library.reporting.EvidencePdfFile;
import dxc.execution.BaseTestNG;
import dxc.library.reporting.Reporter;
import dxc.library.settings.SettingsRun;
import dxc.util.DXCUtil;

public class Launch_Inscripciones extends BaseTestNG {

    // ======================= PAGES & CONTROLLERS =======================
    private PageLoginPymes pageLogin;
    private PageOrigen pageOrigen;
    private PageUsuariosEmpresa pageUsuariosEmpresa;
    private PageAdminParametros pageAdminParametros;
    private PageConsultasyExtractos pageConsultasyExtractos;
    private PageTransaccionesProgramadas pageTransaccionesProgramadas;
    private PageInscripcionesCuenta pageInscripcionCuenta;

    private ControllerCrearTx controller;
    private ControllerValiPymeMiddle controllerValiPymeMiddle;

    private Properties info;

    // ======================= CONSTANTES =======================
    private static final String TP_LOGIN = "Login";
    private static final String TP_EN_LINEA = "Tx En Linea";
    private static final String TP_PEND_APR = "Tx Pend Aprobación";
    private static final String CN_APRO_PEND = "1";
    private static final String DE_EL_DETALLE = "SI";

    // ======================= VARIABLES GLOBALES =======================
    private String transaccion = MotorRiesgo.TX_EMP_LOGIN_SUCC;
    private String contratacion;
    public static String realizarMR;
    private Date fechaHoraLogMR;

    private String navegador;
    private String empresa;

    private String numCliEmp;
    private String tipoDoc;
    private String numDoc;
    private String clave;
    private String tipoTok;
    private String datoTok;

    // ======================= LOCATORS =======================
    private final By log30 = By.xpath("/html/body/h2[1]/p");
    private final By cerrarSesion = By.xpath("//*[@id='CerrarSesion']");
    private final By fecha = By.xpath("//*[@id='tabla-top']/tbody/tr[1]/td[1]");

    // ======================= LAUNCH DATA =======================
    public void launchData() {
        Reporter.initializeEvidenceType(new EvidencePdfFile());
        SettingsRun.DEFAULT_HEADER = 4;
        SettingsRun.ARRAY_DATA_PARAMS = new String[] { "Selección" };
    }

    // ======================= LAUNCH CLOSE =======================
    public void launchClose() {
        if (DatosDavivienda.RISKMOTOR != null) {
            DatosDavivienda.RISKMOTOR.cerrarMotorRiesgo();
        }

        if (pageLogin != null) {
            pageLogin.closeAllBrowsers();
        }
    }

    // ======================= CONFIGURACIONES =======================
    public void doingConfigurations() throws Exception {
        String ambiente = SettingsRun.getGlobalData("AMBIENTE_PYME");

        switch (ambiente) {
            case "1":
            case "PROYECTOS": ambiente = "PROYECTOS"; break;
            case "2":
            case "CONTENCION": ambiente = "CONTENCION"; break;
            case "3":
            case "OBSOLESCENCIA": ambiente = "OBSOLESCENCIA"; break;
            case "4":
            case "ONPREMISE": ambiente = "ONPREMISE"; break;
            case "5":
            case "POST_NUBE": ambiente = "POST_NUBE"; break;
            case "6":
            case "CONTENCION_NUBE": ambiente = "CONTENCION_NUBE"; break;
            case "7":
            case "PROYECTOS_NUBE": ambiente = "PROYECTOS_NUBE"; break;
            case "8":
            case "MEJORAS": ambiente = "MEJORAS"; break;
            default:
                Reporter.reportEvent(Reporter.MIC_FAIL, "Opción no válida");
                return;
        }

        Reporter.reportEvent(Reporter.MIC_HEADER, "Nombre del ambiente seleccionado: " + ambiente);
        DatosEmpresarial.AMBIENTE_TEST = ambiente;

        contratacion = SettingsRun.getGlobalData("CONTRATACION");
        realizarMR = SettingsRun.getGlobalData("MOTOR.motorDeRiesgo");
    }

    // ======================= TEST PRINCIPAL =======================
    public void doingTest() throws Exception {

        DatosEmpresarial.loadLoginDataFija(
                "0",
                SettingsRun.getGlobalData("MIDDLE.tipoDoc"),
                SettingsRun.getGlobalData("MIDDLE.numeroDeId"),
                SettingsRun.getGlobalData("MIDDLE.clavePersonal"),
                SettingsRun.getGlobalData("MIDDLE.tipoToken"),
                SettingsRun.getGlobalData("MIDDLE.numeroToken")
        );

        String[] datosLogin = DatosEmpresarial.getLoginData();

        if ("SI".equals(contratacion) || "SOLO".equals(contratacion)) {
            Reporter.reportEvent(
                    Reporter.MIC_INFO,
                    "*** Datos de Logueo Middle: [" + DXCUtil.arrayToString(datosLogin, " - ") + "]"
            );
        }

        numCliEmp = datosLogin[0];
        tipoDoc = datosLogin[1];
        numDoc = datosLogin[2];
        clave = datosLogin[3];
        tipoTok = datosLogin[4];
        datoTok = datosLogin[5];

        PageLoginPymes.datosMidell(numCliEmp, tipoDoc, numDoc, clave, tipoTok, datoTok);
        PageUsuariosEmpresa.datosMidellToke(datoTok);

        navegador = SettingsRun.getTestData().getParameter("Navegador").trim();

        if ("NO".equals(contratacion)) {
            Front();
        }
    }

    // ======================= FRONT =======================
    public void Front() throws Exception {

        DXCUtil.Movercursor();

        DatosEmpresarial.loadLoginData(
                "Cliente Empresarial",
                "Tipo Identificación",
                "Id usuario",
                "Clave personal o CVE",
                "Tipo Token",
                "Semilla / Valor Estático / Celular"
        );

        String[] datosLogin = DatosEmpresarial.getLoginData();
        Reporter.reportEvent(
                Reporter.MIC_INFO,
                "*** Datos de Logueo Front: [" + DXCUtil.arrayToString(datosLogin, " - ") + "]"
        );

        int intento = 0;
        String msgError;

        do {
            pageLogin = new PageLoginPymes(navegador);
            msgError = pageLogin.loginFront();
            fechaHoraLogMR = pageLogin.getFechaHoraLogMR();
            pageLogin.selecionambienteClose("NO");

            if (pageLogin.element(log30) != null) {
                pageLogin.NavegadorFront(pageLogin.URL_FRONT);
                intento++;
            }

        } while (pageLogin.element(log30) != null && intento < 3);

        if (msgError == null) {
            DXCUtil.wait(3);

            if (!pageLogin.WaitForNumberOfWindos()) {
                Reporter.reportEvent(Reporter.MIC_FAIL, "No se abrió la ventana emergente");
                return;
            }

            pageLogin.closeCurrentBrowser();
            DXCUtil.wait(3);

            pageLogin.changeWindow(pageLogin.accedioAlPortal());

            empresa = SettingsRun.getTestData().getParameter("Nombre Empresa").trim();
            pageOrigen = new PageOrigen(pageLogin);
            msgError = pageOrigen.seleccionarEmpresa(empresa);

            if (msgError == null) {
                pageInscripcionCuenta = new PageInscripcionesCuenta(pageLogin);
                pageInscripcionCuenta.Inscripcion();
            } else {
                Reporter.reportEvent(Reporter.MIC_FAIL, msgError);
                pageOrigen.terminarIteracion();
            }
        }
    }
}
