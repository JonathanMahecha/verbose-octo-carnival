package dav.Consultas_Y_Extractos;

import java.io.FileInputStream;
import java.math.BigDecimal;
import java.text.ParseException;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Calendar;
import java.util.Date;
import java.util.List;
import java.util.Locale;

import org.apache.poi.ss.usermodel.Cell;
import org.apache.poi.ss.usermodel.Row;
import org.apache.poi.ss.usermodel.Sheet;
import org.apache.poi.ss.usermodel.Workbook;
import org.apache.poi.ss.usermodel.WorkbookFactory;
import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;

import dav.pymes.PagePortalPymes;
import dav.pymes.moduloCrearTx.ControllerCrearTx;
import dav.pymes.moduloCrearTx.PageOrigen;
import dav.transversal.DatosDavivienda;
import dxc.util.DXCUtil;
import library.common.Util;
import library.core.BasePageWeb;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsRun;
import screens.actions.consulta.StratusProductos;
import stratus.library.common.MovimientoStratus;

public class PageConsultasyExtractos extends BasePageWeb {

	ControllerCrearTx controller = null;
	PageOrigen pageOrigen = null;

	// Mensajes de éxito
	public static final String MSG_EXITO_GUARD = "Esta transacción"; // Falta firma
	public static final String MSG_EXITO_PAGO = "Su transacción ha sido recibida por el Portal"; // 1 firma / aprobación
	public static final String MSG_EXITO_APROB = "Usted aprobó"; // Aprobación desde caja
	public static final String MSG_EXITO_SER = "Su transacción ha sido recibida por el Portal PYME. Programe el pago automatico de este servicio, dando click aquí";

	// Locators principales
	By locPasoPageTxEnviada = By.xpath("//div[@id='UpMasterTitulo']/span[text()='Transacciones Realizadas en el Portal PYME']");
	By locPasoPageTxReali = By.xpath("//div[@id='UpMasterTitulo']/span[text()='Transacciones Realizadas en el Portal PYME']");
	By locLinkTxAprob = By.xpath(
			"//span[@id='lblMasterAlerta' or @id='lblMasterTransaccionExitosaAlerta']/a[@cssclass='LetraHypervinculoAzul' or @href]");
	By locPasoPage = By.xpath("//div[@id='UpMasterTitulo']/span[text()='Transacciones Realizadas en el Portal PYME']");
	String docuDetalle = "//table[@id='cphCuerpo_gvTransacciones']//a[contains(text(),'NUM_TX')]";
	By lblMasterTitulo = By.xpath("//*[@id='lblMasterTitulo']");
	By table = By.xpath(
			"//*[@id='cphCuerpo_gvFondosDaviplus']/tbody | //table[@id='cphCuerpo_gvMovimientosCuentas']//tbody | //*[@id='cphCuerpo_gvMovimientosTarjetaDeCredito']/tbody | //*[@id='cphCuerpo_gvMovimientosCredito']");

	By tbDestinoFina = By.xpath("//*[@id='cphCuerpo_gvTransaccionesMasivas']/tbody");
	By tipoDestinoFondosMismoNit = By.id("cphCuerpo_lblERTipoProductoDestino");
	// Referencia para cuenta inscrita y no inscrita
	By tipoDestinoFondosCta = By.xpath(
			"//*[@id='cphCuerpo_lblERCUTipoProductoDestino' or @id='cphCuerpo_lblTipoProductoDestinoPAGP']");
	By tipoDestinoServicios = By.id("cphCuerpo_lblTipoPase");

	// Saldos consolidados
	By TitulosaldosConsolidados = By.xpath("//*[@id='lblMasterTitulo']");
	String saldosConsolidadosFinanciacion = "//tr[td[contains(text(), 'TIPO_PROD')] and td[contains(text(), 'NUM_PROD')]]/td/select";

	// Controles de UI
	By MenuModu = By.id("mnMenu");
	By ListProduc = By.id("cphCuerpo_ddlproducto");
	By ListProduc2 = By.id("cphCuerpo_ddlBusAvanzadaProducto");
	By btnBusqAvanzada = By.id("cphCuerpo_lnkBusquedaAvanzada");
	By btnMostDatos = By.id("cphCuerpo_btnMostrarDatos");
	By btn48 = By.id("cphCuerpo_rdbUltimas48Horas");
	By btn7 = By.id("cphCuerpo_rdbUltimos7dias");
	By btn30 = By.id("cphCuerpo_rdbUltimos30dias");

	By btnDesArch = By.cssSelector("#cphCuerpo_ddlDescargaMasiva, #cphCuerpo_BtDaviplus");
	By btnseleArch = By.cssSelector("#cphCuerpo_ddlDescargaMasiva, #cphCuerpo_DropDafuturo");
	By btnDescargaMasiva = By.cssSelector("#cphCuerpo_btnDescargaMasiva,#cphCuerpo_BtDaviplus");

	By nomArchDes = By.id("cphCuerpo_txtNombreArchivo");
	By cmpFechadesde = By.id("cphCuerpo_txtFechaDesde");
	By cmpFechaInicio = By.id("cphCuerpo_txtFechaHasta");
	By btnSiguiente = By.id("cphCuerpo_lnkSiguiente_cuentas");

	// Tablas saldos consolidados
	By tabla1ahorroeinversiones = By.xpath("//*[@id='cphCuerpo_gvSaldosConsolidados']//tbody");
	By tabla2financiación = By.xpath("//*[@id='cphCuerpo_gvSaldosConsolidadosFinanciacion']//tbody");
	By tabla3ahorroeinversiones = By.xpath("//*[@id='cphCuerpo_gvahorroinversiones']//tbody");
	By tabla4financiación = By.xpath("//*[@id='cphCuerpo_gvFinanciacion']//tbody");

	// Totales
	By total1 = By.xpath(
			"//*[@id='cphCuerpo_gvSaldosConsolidados']//tbody//tr//td[@align='right']//b[contains(text(),'Total')]//parent::td//parent::tr//td[3]");
	By total2 = By.xpath(
			"//*[@id='cphCuerpo_gvSaldosConsolidadosFinanciacion']//tbody//tr//td[@align='right']//b[contains(text(),'Total')]//parent::td//parent::tr//td[3]");
	By total3 = By.xpath(
			"//*[@id='cphCuerpo_gvahorroinversiones']//tbody//tr//td[@align='right']//b[contains(text(),'Total')]//parent::td//parent::tr//td[4]");
	By total4 = By.xpath(
			"//*[@id='cphCuerpo_gvFinanciacion']//tbody//tr//td[@align='right']//b[contains(text(),'Total')]//parent::td//parent::tr//td[4]");

	// Detalle Tx
	By montoTx = By.id("cphCuerpo_lblMasivoMonto");
	By fechaTx = By.xpath(
			"//span[@id='cphCuerpo_lblFechaPase' or @id='cphCuerpo_lblMasivoFecha' or @id='cphCuerpo_lblERFecha' or @id='cphCuerpo_lblFecEjecPAGP' or @id='cphCuerpo_lblFICFecha']");
	By horaTx = By.xpath(
			"//span[@id='cphCuerpo_lblHoraPase' or @id='cphCuerpo_lblMasivoHora'or @id='cphCuerpo_lblERHora'or @id='cphCuerpo_lblHoraEjecPAGP' or @id='cphCuerpo_lblFICHora']");

	String todaydesde = null;
	String fechahasta = null;

	static String saldoTotalInicial = null;
	static String saldoDisInicial = null;
	static String saldoTotalFinal = null;
	static String saldoDisponibleFinal = null;

	static String numAprova = null;

	static String tipoDes = null;
	static String estadoDes = null;
	static String[] registrosmov = null;

	PagePortalPymes pagePortalPymes = null;
	StratusProductos instanciaStratus;

	public PageConsultasyExtractos(BasePageWeb parentPage) {
		super(parentPage);
		pagePortalPymes = new PagePortalPymes(parentPage);
	}

	public PageConsultasyExtractos(BasePageWeb parentPage, StratusProductos instanciaStra) {
		super(parentPage);
		pagePortalPymes = new PagePortalPymes(parentPage);
		this.instanciaStratus = instanciaStra;
	}

	// =======================================================================================================================================

	public void SetNumApr(String numAproTx) {
		numAprova = numAproTx;
	}

	public void setSaldoTotalInicial(String saldo) {
		saldoTotalInicial = saldo;
	}

	public void setSaldoDisInicial(String saldo) {
		saldoDisInicial = saldo;
	}

	public void setSaldoTotalFinal(String saldo) {
		saldoTotalFinal = saldo;
	}

	public void setSaldoDisponibleFinal(String saldo) {
		saldoDisponibleFinal = saldo;
	}

	// =======================================================================================================================================
	/**
	 * Realiza la consulta de las tx realizadas. Si es de 1 firma da clic en el
	 * link Consulta y Extractos. Si es de más firmas busca el menú.
	 */
	public String ConsultayExtractos(String servicio, String navegador, String tipoIDEmpresa, String numIdEmpresa,
			String tipoDocumento, String numeroDoc, String tipoProduct, String numeroProducto, boolean primeroGuardar)
			throws Exception {

		String msgResp = null;
		String texto;
		Util.wait(5);

		texto = this.getText(this.element(MenuModu));

		if (texto.contains("Consultas y Extractos")) {
			texto = "Consultas y Extractos";
		} else if (texto.contains("Consultas")) {
			texto = "Consultas";
		}

		this.pageOrigen = new PageOrigen(this);
		String msgError = pagePortalPymes.getMsgAlertIfExist("lblMasterAlerta");

		if (msgError == null) {
			msgError = pagePortalPymes.getMsgAlertIfExist("lblMasterTransaccionExitosaAlerta");
		}

		if (primeroGuardar) {
			if (msgError.contains(MSG_EXITO_PAGO)) {
				pagePortalPymes.waitIngresoModulo("Transacción Enviada");
				WebElement objLinkConsulta = this.element(locLinkTxAprob);
				if (objLinkConsulta != null) {
					this.click(objLinkConsulta);
				}
			} else if (msgError.contains(MSG_EXITO_GUARD)) {
				pagePortalPymes.waitIngresoModulo("Detalle de Transacción");
				if (navegador.contains("CHROME")) {
					this.pagePortalPymes.irAOpcion("Transacciones Realizadas en el Portal PYME", texto,
							"Transacciones a Través del Portal", null);
				} else {
					this.pagePortalPymes.irAOpcionMoZilla("Transacciones Realizadas en el Portal PYME", texto,
							"Transacciones a Través del Portal", null, null);
				}
			} else if (msgError.contains(MSG_EXITO_APROB)) {
				WebElement objLinkConsulta = this.element(locLinkTxAprob);
				if (objLinkConsulta != null) {
					this.click(objLinkConsulta);
				}
			}
		} else if (msgError.contains(MSG_EXITO_PAGO) && !msgError.contains(MSG_EXITO_SER)) {
			pagePortalPymes.waitIngresoModulo("Transacción Enviada");
			WebElement objLinkConsulta = this.element(By.xpath(
					"//span[@id='lblMasterAlerta' or @id='lblMasterTransaccionExitosaAlerta']/a[@cssclass='LetraHypervinculoAzul' or @href]"));
			if (objLinkConsulta != null) {
				this.click(objLinkConsulta);
			}
		} else if (msgError.contains(MSG_EXITO_GUARD)) {
			pagePortalPymes.waitIngresoModulo("Transacción Pendiente");

			if (navegador.contains("CHROME")) {
				this.pagePortalPymes.irAOpcion("Transacciones Realizadas en el Portal PYME", texto,
						"Transacciones a Través del Portal", null);
			} else {
				this.pagePortalPymes.irAOpcionMoZilla("Transacciones Realizadas en el Portal PYME", texto,
						"Transacciones a Través del Portal", null, null);
			}
		} else if (msgError.contains(MSG_EXITO_SER)) {
			pagePortalPymes.waitIngresoModulo("Transacción Enviada");

			if (navegador.contains("CHROME")) {
				this.pagePortalPymes.irAOpcion("Transacciones Realizadas en el Portal PYME", texto,
						"Transacciones a Través del Portal", null);
			} else {
				this.pagePortalPymes.irAOpcionMoZilla("Transacciones Realizadas en el Portal PYME", texto,
						"Transacciones a Través del Portal", null, null);
			}
		}

		boolean tituloesperado = pagePortalPymes.waitEspetaTitulo("Transacciones Realizadas en el Portal PYME");

		if (!tituloesperado) {
			if (navegador.contains("CHROME")) {
				this.pagePortalPymes.irAOpcion("Transacciones Realizadas en el Portal PYME", texto,
						"Transacciones a Través del Portal", null);
			} else {
				this.pagePortalPymes.irAOpcionMoZilla("Transacciones Realizadas en el Portal PYME", texto,
						"Transacciones a Través del Portal", null, null);
			}
		}

		pagePortalPymes.waitIngresoModulo("Transacciones Realizadas en el Portal PYME");
		Evidence.saveFullPage("Consulta de tx", this);

		msgResp = pagePortalPymes.getMsgAlertIfExist("lblMasterAlerta");
		if (msgResp != null) {
			if (msgResp.equals("NO SE ENCONTRARON DATOS")) {
				Reporter.reportEvent(Reporter.MIC_FAIL, msgResp);
				return msgResp;
			} else {
				Reporter.reportEvent(Reporter.MIC_FAIL, "No se encontró el saldo inicial en los movimientos.");
				this.pagePortalPymes.terminarIteracion();
			}
		}

		String numAptx = docuDetalle.replace("NUM_TX", numAprova);

		Util.wait(1);
		WebElement getexto = this.element(numAptx);
		texto = this.getText(getexto);
		Util.wait(4);

		if (texto != null && texto.equals(numAprova)) {

			if (getexto != null) {
				this.click(getexto);
			}

			int contador = 0;
			do {
				contador++;
				Util.wait(1);
				if (contador == 60) {
					Reporter.reportEvent(Reporter.MIC_FAIL, "TimeOut no se presento el Titulo");
					this.pagePortalPymes.terminarIteracion();
				}
				try {
					if (isDisplayed(By.xpath("//*[@id='lblMasterAlerta']//b"))) {
						String tecto3 = getText(By.xpath("//*[@id='lblMasterAlerta']//b"));
						if (tecto3.contains("Transacción rechazada")) {
							Reporter.reportEvent(Reporter.MIC_FAIL, tecto3);
							SettingsRun.exitTestIteration();
						}
					}
				} catch (Exception e) {
					System.out.println("");
				}
			} while (this.element(lblMasterTitulo) == null);

			WebElement getextoTitulo = this.element(lblMasterTitulo);
			String titulo = this.getText(getextoTitulo);

			if (!DatosDavivienda.IS_RISKMOTOR) {
				WebElement getextoMontoTx = this.element(montoTx);
				String montoTxMov = this.getText(getextoMontoTx);

				int contador2 = 0;
				do {
					contador2++;
					Util.wait(1);
					if (contador2 == 60) {
						Reporter.reportEvent(Reporter.MIC_FAIL, "TimeOut no se presento La fecha de la tx");
						this.pagePortalPymes.terminarIteracion();
					}
				} while (this.element(fechaTx) == null);

				this.registrosmov = RegistrosMovimientos();

				for (String remov : this.registrosmov) {
					String[] registoDestinos = remov.split("\\|");
					if (registoDestinos.length > 2) {
						tipoDes = registoDestinos[1];
						estadoDes = registoDestinos[3];
					} else {
						tipoDes = registoDestinos[0];
						estadoDes = registoDestinos[1];
					}
				}
			}

			Util.wait(3);
			if (titulo == null || titulo.isEmpty()) {
				titulo = "Consultas y Extratos";
			}
			Evidence.saveFullPage(titulo, this);

			if (!DatosDavivienda.IS_RISKMOTOR) {
				Util.wait(5);
				ValidacionMovimientoStratus(servicio, tipoIDEmpresa, numIdEmpresa, tipoDocumento, numeroDoc,
						tipoProduct, numeroProducto);
			}

			int contador3 = 1;
			do {
				Util.wait(1);
				contador3++;
				msgResp = pagePortalPymes.getMsgAlertIfExist("lblMasterAlerta");
			} while (msgResp == null && contador3 < 10);

		} else {
			return "Transacción [" + texto + "] NO se encuentra en el listado";
		}

		return msgResp;
	}

	public void ValidacionMovimientoStratus(String servicio, String tipoIDEmpresa, String numIdEmpresa,
			String tipoDocumento, String numeroDoc, String tipoProduct, String numeroProducto) throws Exception {

		WebElement getextoFecha = this.element(fechaTx);
		String FechaTx = this.getText(getextoFecha);

		Date fechaConsulta = DXCUtil.stringToDate(FechaTx, "dd/MM/yyyy");
		Date FechaConsultaStratus = DXCUtil.dateAdd(fechaConsulta, Calendar.MINUTE, -2);

		Reporter.reportEvent(Reporter.MIC_INFO, "Fecha y hora de la tx: " + FechaConsultaStratus);

		WebElement getextoHora = this.element(horaTx);
		String horaTxMov = this.getText(getextoHora);

		String fechaHora = FechaTx + horaTxMov;

		String fecha = DXCUtil.dateToString("MMDD");

		horaTxMov = DXCUtil.hourToStringFormat(horaTxMov, "HHmm");

		String[] datosTitular = new String[2];

		String tipoProd = instanciaStratus.getTipoCuenta(tipoProduct);

		if (tipoProd.contains("AH") || tipoProduct.contains("CC")) {
			datosTitular[0] = tipoIDEmpresa;
			datosTitular[1] = numIdEmpresa;
		} else if (tipoProduct.contains("CREDITO") || tipoProduct.contains("CRED")
				|| tipoProduct.contains("ompanita")) {
			datosTitular[0] = tipoIDEmpresa;
			datosTitular[1] = numIdEmpresa;
		} else {
			datosTitular[0] = tipoDocumento;
			datosTitular[1] = numeroDoc;
		}

		String[] arrayVents = { MovimientoStratus.VENT_UNID, MovimientoStratus.VENT_IVA, MovimientoStratus.VENT_SALDO,
				MovimientoStratus.VENT_EMERG };

		if (instanciaStratus == null) {
			instanciaStratus = new StratusProductos(SettingsRun.getGlobalData("STRATUS.usuario"),
					SettingsRun.getGlobalData("STRATUS.password"));
		}

		if (instanciaStratus != null) {

			List<MovimientoStratus> datosCtadh2 = instanciaStratus.getMovimientosEnRango(tipoProd, numeroProducto,
					arrayVents, FechaConsultaStratus, 1, datosTitular);

			if (datosCtadh2 != null) {
				List<String[]> movimientosStratus = new ArrayList<>();

				String saldoinicialstra = saldoTotalInicial;
				String saldoDislstra = saldoDisInicial;

				String saldofinal = saldoTotalFinal;
				String saldoDisponiblefinal = saldoDisponibleFinal;

				double saldoTotalInicial = 0.0;
				double saldoDisponible = 0.0;
				saldoTotalInicial = Double.parseDouble(saldoinicialstra);
				String saldoPos = String.format("%.1f", saldoTotalInicial);
				saldoDisponible = Double.parseDouble(saldoDislstra);

				double saldoTotalFinal = 0.0;
				double saldoDisponibleFinal = 0.0;
				saldoTotalFinal = Double.parseDouble(saldofinal);
				saldoDisponibleFinal = Double.parseDouble(saldoDisponiblefinal);
				String saldoPosFinal = String.format("%.2f", saldoTotalFinal);

				Reporter.write(" ");
				Reporter.write("*** CONSULTA DE MOVIMIENTOS EN STRATUS");
				Reporter.write(" ");
				Reporter.write(
						"           FECHA | HORA |   TALON  | TIPO  |  OFRE | VALOR TOTAL | MTVO  |  UNIDAD  |  VALOR CHEQUE  |  VALOR IVA  |  SALDO ANTERIOR  |  GMF | IND");
				Reporter.write(" ");

				for (MovimientoStratus movimiento : datosCtadh2) {
					DXCUtil.waitMilisegundos(125);
					String oficinaStratus = null, tipoStratus = null, mtvoStratus = null, talon = null;
					double ValorTotalMov = 0.0, ValorChequeMovStartus = 0.0;
					double saldoAnteriorStratus = 0.0;
					double unidad = 0.0;

					String movToString = movimiento.toString().replace("[INDIC:", "").replace("]", "")
							.replace("SALDO:", "|").replace("UNID :", "|").replace("EMERG:", "|").replace("IVA  :", "|")
							.replace(" ", "").replace("  ", "");

					String[] datos = movToString.split("\\|");

					fecha = datos[0].trim();
					String hora = datos[1].trim();
					String term = datos[2].trim();
					talon = datos[3].trim();
					tipoStratus = datos[4].trim();
					oficinaStratus = datos[5].trim();
					String valorStratus = datos[6].trim();
					ValorTotalMov = Double.parseDouble(valorStratus);
					mtvoStratus = datos[7].trim();
					String FechaMovStratus = datos[8].trim();
					String saldoAnterior = datos[9].trim();
					if (!saldoAnterior.isEmpty()) {
						saldoAnteriorStratus = Double.parseDouble(saldoAnterior);
					}
					String saldoUnidad = datos[10].trim();
					unidad = Double.parseDouble(saldoUnidad);
					String chequeStratus = datos[11];
					String in = datos[12];
					String valorEmerg = datos[13];

					if (!oficinaStratus.contains("4636") && !oficinaStratus.contains("4522")
							&& !oficinaStratus.contains("4863")) {
						String indCancelado = datos[14];
						String ivam = datos[15];

						String msgcancelado = " ";

						if (indCancelado != null && indCancelado.equals("true")) {
							msgcancelado = "Cancelado";
						}

						Reporter.write("Movimiento: " + fecha + " | " + hora + " | " + talon + " | " + tipoStratus
								+ "  |  " + oficinaStratus + " | " + BigDecimal.valueOf(ValorTotalMov) + " | "
								+ mtvoStratus + "  |  " + BigDecimal.valueOf(unidad) + "  |  "
								+ BigDecimal.valueOf(ValorChequeMovStartus) + "  |  " + ivam + "  |  " + saldoAnterior
								+ "  |  " + valorEmerg + " | " + msgcancelado);

						String movr = fecha + " " + hora + " " + talon + " " + tipoStratus + " " + oficinaStratus + " "
								+ BigDecimal.valueOf(ValorTotalMov) + " " + mtvoStratus + " "
								+ BigDecimal.valueOf(unidad) + " " + BigDecimal.valueOf(ValorChequeMovStartus) + " "
								+ ivam + " " + saldoAnterior + " " + valorEmerg + " " + indCancelado;

						if (movr.contains("0034") || movr.contains("0055") || movr.contains("0041")) {
							movimientosStratus.add(movr.split(","));
						}
					}

				}

				double sumaMovimientos = 0.0;
				double sumaunida = 0.0;
				double sumaCheque = 0.0;
				double sumaIva = 0.0;
				double sumaGmf = 0.0;
				double saldoTotalFinalEsperado = 0.0;

				int posicionSaldoInicialpos = -1;
				int posicionSaldoInicialpos2 = -1;

				switch (servicio) {

				case "Nómina":
				case "Pago de Nómina":
				case "Pago de Nóminas":
				case "Pago a Proveedores":
				case "Pagos a proveedores":
				case "Pagos proveedores":
				case "Proveedores":
				case "AFC":
				case "Pago a Créditos de Terceros":
				case "Pagos a créditos de terceros":
				case "Crédito.3ros":
				case "Pago de Servicios":
				case "Servicios":
				case "Transferencias Cuenta Inscrita":
				case "Cuenta Inscrita":
				case "Transferencias Cuenta No Inscrita":
				case "Transferencias Cuenta NO Inscrita":
				case "Cuenta No Inscrita":
				case "Transferencias Mismo NIT":
				case "Transferencia NIT Propio":
				case "Mismo NIT":

					double saldoInipo = 0.0;
					for (int i = 0; i < movimientosStratus.size(); i++) {
						String[] movimiento = movimientosStratus.get(i);
						String[] datosMovIni = movimiento[0].split(" ");

						if (movimiento[movimiento.length - 1].contains(saldoPos.substring(0, saldoPos.length() - 3))) {
							posicionSaldoInicialpos = i;
							saldoInipo = Double.parseDouble(datosMovIni[10].trim().replace(",", ""));
							break;
						}
					}

					for (int j = 0; j < movimientosStratus.size(); j++) {
						String[] movimiento = movimientosStratus.get(j);
						if (movimiento.length > 1) {
							if (movimiento[movimiento.length - 1]
									.contains(saldoPosFinal.substring(0, saldoPosFinal.length() - 3))) {
								posicionSaldoInicialpos2 = j;
								break;
							}

							if (posicionSaldoInicialpos2 != -1 && posicionSaldoInicialpos < posicionSaldoInicialpos2) {
								posicionSaldoInicialpos = posicionSaldoInicialpos2;
							}

							if (posicionSaldoInicialpos2 == -1) {
								double saldoFinalPo = 0.0;
								posicionSaldoInicialpos2 = movimientosStratus.size() - 2;

								if (posicionSaldoInicialpos2 > 0) {
									String[] movimiento1 = movimientosStratus.get(posicionSaldoInicialpos2);
									if (movimiento1.length > 0) {
										String[] datosMov = movimiento1[0].split(" ");
										if (datosMov.length > 0) {
											saldoFinalPo = Double.parseDouble(datosMov[10].trim().replace(",", ""));
											if (saldoFinalPo < saldoInipo) {
												posicionSaldoInicialpos = posicionSaldoInicialpos2;
											}
										}
									}
								}
							}
						}
					}

					break;

				case "Pagos Propios":
					break;
				}

				Reporter.write(" ");
				Reporter.write("*** Valores Cobros, IVA y GMF");
				Reporter.write(" ");

				String porGmf = DatosDavivienda.STRATUS.getGMF();

				if (porGmf == null) {
					porGmf = "1.0040";
				}
