package Divisas;

import java.util.Random;
import java.util.Set;
import java.util.List;
import java.util.ArrayList;

import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.PageFactory;
import org.openqa.selenium.support.pagefactory.AjaxElementLocatorFactory;

import library.catalogue.ProjectUrls;
import library.common.Util;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsRun;

public class FrontDivisas {

    private final Page_Divisas parent;
    private final Locators_Divisas loc;
    private final String urlFront;
    private static final Random RAND = new Random();

    public FrontDivisas(Page_Divisas parent, boolean middles) throws Exception {
        this.parent = parent;
        this.loc = new Locators_Divisas();
        AjaxElementLocatorFactory factory = new AjaxElementLocatorFactory(parent.getDriver(), 0);
        PageFactory.initElements(factory, this.loc);

        if (!middles) {
            this.urlFront = loadFrontUrl();
        } else {
            this.urlFront = loadMiddletUrl();
        }
    }

    private String loadFrontUrl() throws Exception {
        ProjectUrls datosUrl = new ProjectUrls();
        return datosUrl.getSiteUrl(SettingsRun.getGlobalData("env.front.pyme"), "PROYECTOS_NUBE");
    }

    private String loadMiddletUrl() throws Exception {
        ProjectUrls datosUrl = new ProjectUrls();
        return datosUrl.getSiteUrl(SettingsRun.getGlobalData("env.middle.pyme"), "PROYECTOS_NUBE");
    }

    /**
     * Flujo principal: login + seleccionar empresa + parametros + crear transaccion
     */
    public void mainFront(String[] datosLoginGlob) throws Exception {
        String validate = loginFront(datosLoginGlob);
        if (!validate.isEmpty()) {
            SettingsRun.exitTestIteration();
            return;
        }

        // Manejo de ventanas (similar al original)
        Set<String> handles = parent.getDriver().getWindowHandles();
        List<String> ventanas = new ArrayList<>(handles);

        if (ventanas.size() >= 2) {
            String primera = ventanas.get(0);
            String segundo = ventanas.get(1);
            if (!SettingsRun.esIteracionInicial()) {
                parent.getDriver().switchTo().window(primera);
                parent.getDriver().close();
            }
            parent.getDriver().switchTo().window(segundo);
        } else {
            Reporter.reportEvent(Reporter.MIC_FAIL, "No se abrio la segunda pestaña");
            SettingsRun.exitTestIteration();
            return;
        }

        validate = seleccionEmpresa(datosLoginGlob);
        if (!validate.isEmpty()) {
            SettingsRun.exitTestIteration();
            return;
        }

        validate = parametrosGenerales(datosLoginGlob);
        if (!validate.isEmpty()) {
            SettingsRun.exitTestIteration();
            return;
        }

        validate = crearTransaccion(datosLoginGlob);
        if (!validate.isEmpty()) {
            SettingsRun.exitTestIteration();
        }
    }

    /** Login: "" si ok, "Error" si falla */
    private String loginFront(String[] getLoginData) throws Exception {
        final String numCliEmp = getLoginData[0];
        final String tipoDoc = getLoginData[1];
        final String numDoc = getLoginData[2];
        final String clave = getLoginData[3];
        final String tipoTok = getLoginData[5];

        parent.maximizeBrowser();
        parent.navigate(urlFront);

        if (!parent.waitForElement(loc.numeroClienteLogin, 5, "loc.numeroClienteLogin"))
            return "Error";

        parent.write(loc.numeroClienteLogin, numCliEmp);
        parent.selectListItem(loc.tipoIdLogin, tipoDoc);
        parent.write(loc.NumeroIdLogin, numDoc);
        parent.click(loc.botonSubmit);
        Evidence.save("Login", parent);

        if (!parent.waitForElement(loc.clavePersonLogin, 5, "loc.clavePersonLogin"))
            return "Error";

        if (!parent.isDisplayed(loc.clavePersonLogin)) {
            Evidence.save("La consulta no retorno registros", parent);
            Reporter.reportEvent(Reporter.MIC_FAIL, "La consulta no retorno registros");
            return "Error";
        }

        parent.write(loc.clavePersonLogin, clave);
        parent.write(loc.tokePersonLogin, tipoTok);
        if (!parent.waitForElement(loc.botonSubmit, 10, "loc.botonSubmit"))
            return "Error";
        parent.click(loc.botonSubmit);

        if (parent.isDisplayed(loc.lBMensaje)) {
            Evidence.save("Login falla", parent);
            Reporter.reportEvent(Reporter.MIC_FAIL, parent.getText(loc.lBMensaje));
            parent.click(loc.botonAceptar2);
            return "Error";
        } else {
            Evidence.save("Login", parent);
        }

        return "";
    }

    private String seleccionEmpresa(String[] getLoginData) throws Exception {
        final String nombreEmpresa = getLoginData[30];

        if (!parent.waitForElement(loc.listaEmpresas, 10, "loc.listaEmpresas"))
            return "Error";

        String empresaNo = parent.selectListContainsItems(loc.listaEmpresas, nombreEmpresa);
        if (empresaNo != null) {
            Reporter.reportEvent(Reporter.MIC_FAIL, empresaNo);
            return "Error";
        }
        Evidence.save("Seleccion empresa: ", parent);

        if (!parent.waitForElement(loc.textResumProductos, 20, "loc.textResumProductos"))
            return "Error";
        return "";
    }

    private String parametrosGenerales(String[] getLoginData) {
        Util.wait(2);
        parent.mouseOver(loc.adminisDespleg);
        parent.waitClickable(loc.adminisPortal, 5);
        parent.mouseOver(loc.adminisPortal);
        parent.waitClickable(loc.parametGene, 5);
        parent.click(loc.parametGene);
        Evidence.save("Parametros generales: ", parent);
        parent.waitClickable(loc.botonGuarCambios, 5);
        parent.click(loc.botonGuarCambios);
        if (!parent.waitForElement(loc.textActExit, 20, "loc.textActExit"))
            return "Error";
        return "";
    }

    private String crearTransaccion(String[] getLoginData) throws Exception {
        Util.wait(3);
        if (!parent.isDisplayed(loc.pagosTrsDespleg)) {
            parent.mouseOver(loc.pagosTrsDesplegPost);
        } else {
            parent.mouseOver(loc.pagosTrsDespleg);
        }
        if (!parent.waitForElement(loc.crearTransc, 10, "loc.crearTransc"))
            return "Error";
        parent.click(loc.crearTransc);

        if (!parent.waitForElement(loc.transfIntern, 10, "loc.transfIntern"))
            return "Error";
        parent.click(loc.transfIntern);
        Evidence.save("Crear transacciones", parent);

        String opcion = getLoginData[31];
        if ("Enviar hacia el exterior".equals(opcion)) {
            return enviarAlExte(getLoginData);
        } else if ("Recibir del exterior".equals(opcion)) {
            return recibirAlExte();
        } else if ("Aprobaciones".equals(opcion)) {
            return aprobaciones();
        } else if ("Consultas".equals(opcion)) {
            return consultas();
        } else if ("Documentos y Formularios".equals(opcion)) {
            return docYForm();
        } else {
            return "";
        }
    }

    private String enviarAlExte(String[] getLoginData) throws Exception {
        // cambiar a frame de divisas
        if (!parent.switchToFrameDivisas())
            return "Error";
        Util.wait(2);

        if (parent.isDisplayed(loc.txtInactividad)) {
            Reporter.reportEvent(Reporter.MIC_FAIL, parent.getText(loc.txtInactividad));
            return "Error";
        }
        if (!parent.waitForElement(loc.enviarExt, 20, "loc.enviarExt"))
            return "Error";
        parent.click(loc.enviarExt);
        Util.wait(2);

        Evidence.save("Enviar al exterior: ", parent);

        if (parent.isDisplayed(loc.mensajeError)) {
            String textoError = null;
            for (int i = 0; i < 2; i++) {
                textoError = parent.getText(loc.textoError);
                Util.wait(1);
                parent.click(loc.botonAceptar);
                Reporter.reportEvent(Reporter.MIC_INFO, textoError);
                Evidence.save("Enviar al exterior: ", parent);
                parent.waitClickable(loc.enviarExt, 10);
                Evidence.save("Enviar al exterior: ", parent);
                parent.click(loc.enviarExt);
            }
            if (textoError != null && textoError.contains(
                    "¡Recuerde...! Este servicio está disponible los días hábiles entre las 8:00 a.m. y la 1:00 p.m.")) {
                Reporter.reportEvent(Reporter.MIC_FAIL, textoError);
                return "Error";
            }
        }

        if (!parent.waitForElement(loc.botonAceptar, 10, "loc.botonAceptar"))
            return "Error";
        parent.click(loc.botonAceptar);

        // seleccionar cuenta (reusa el util público en Page_Divisas)
        getLoginData[33] = Util.right(getLoginData[33], 4);
        if (!parent.seleccionarCuenta(parent.getDriver(), getLoginData[32], getLoginData[33])) {
            return "Error";
        }

        Evidence.save("Enviar al exterior: ", parent);
        parent.click(loc.botonSiguien);
        parent.waitClickable(loc.botonSiguien, 10);

        // moneda y monto
        getLoginData[34] = Util.left(getLoginData[34], 3);
        parent.waitClickable(loc.listaMoneda, 10);
        parent.selectListItem(loc.listaMoneda, getLoginData[34]);
        parent.clearInputbox(loc.campoMonto);
        parent.write(loc.campoMonto, getLoginData[35]);
        parent.selectListItem(loc.listaConceptoCambiario, getLoginData[36]);

        // cálculo de campos opcionales (mantener intención original)
        String val39 = getLoginData[39];
        if (!getLoginData[39].isEmpty() || getLoginData[39] != null && getLoginData[39].isEmpty()
                || getLoginData[39] == null) {
            try {
                int mnto = Integer.parseInt(getLoginData[35]);
                int valr1 = Integer.parseInt(getLoginData[38]);
                int calc = mnto - valr1;
                getLoginData[40] = String.valueOf(calc);
            } catch (Exception e) {
                // mantener funcionalidad, no fallar si parse falla
            }
        }

        parent.waitClickable(loc.numeralCambiario1, 10);
        parent.selectListItem(loc.numeralCambiario1, getLoginData[37]);

        if (val39 != null && !val39.isEmpty()) {
            if (!parent.waitForElement(loc.adicionarNumCamb, 10, "loc.adicionarNumCamb"))
                return "Error";
            parent.click(loc.adicionarNumCamb);
            parent.waitClickable(loc.numeralCambiario2, 10);
            parent.selectListItem(loc.numeralCambiario2, getLoginData[39]);
            if (!parent.waitForElement(loc.valor1, 20, "loc.valor1"))
                return "Error";
            parent.write(loc.valor1, getLoginData[38]);
            parent.write(loc.valor2, getLoginData[40]);
        }

        // envío nuevo o frecuente
        if ("Nuevo envío".equals(getLoginData[41])) {
            parent.click(loc.tipoEnvioNuevo);
            Evidence.save("Enviar al exterior: ", parent);
            parent.click(loc.botonSiguien);

            if (!parent.waitForElement(loc.nombreBenefi, 20, "loc.nombreBenefi"))
                return "Error";
            parent.write(loc.nombreBenefi, getLoginData[42]);
            if (!parent.waitForElement(loc.paisBenefi, 10, "loc.paisBenefi"))
                return "Error";
            parent.write(loc.paisBenefi, getLoginData[43].toUpperCase());
            parent.waitForElement(loc.listaPais, 5, "loc.listaPais");
            if (parent.isDisplayed(loc.listaPais)) {
                Util.wait(2);
                parent.click(loc.listaPais);
            }
            parent.write(loc.ciudadBene, getLoginData[44]);
            parent.write(loc.direccionBene, generarDireccion());
            parent.write(loc.ibanCabeBene, getLoginData[45]);
            parent.selectListItem(loc.tipoInfoBene, getLoginData[46]);
            parent.write(loc.InfoBene, getLoginData[47]);
            Evidence.save("Enviar al exterior: ", parent);
            parent.click(loc.botonSiguien);

            if (!parent.waitForElement(loc.tipoCodBanBene, 20, "loc.tipoCodBanBene"))
                return "Error";
            parent.selectListItem(loc.tipoCodBanBene, getLoginData[48]);
            parent.write(loc.numCodBene, getLoginData[49]);
            Util.wait(3);

            if (parent.isDisplayed(loc.listaBenef))
                parent.click(loc.listaBenef);
            Util.wait(3);
            String banco = parent.getText(loc.bancoValidate);
            if (banco == null || banco.isEmpty()) {
                Reporter.reportEvent(Reporter.MIC_FAIL, "El numero del codigo del banco beneficiario no existe.");
                return "Error";
            }

            String val51 = getLoginData[51];
            if (val51 != null && !val51.isEmpty()) {
                parent.click(loc.tienBancoInterm);
                parent.waitClickable(loc.numCodBene, 10);
                parent.selectListItem(loc.tipoInteInfoBene, getLoginData[50]);
                parent.write(loc.numCodInterBene, getLoginData[51]);
                Util.wait(2);
                if (parent.isDisplayed(loc.listaBenefInterme)) {
                    Util.wait(4);
                    parent.click(loc.listaBenefInterme);
                }
                Util.wait(1);
                String banco1 = parent.getText(loc.bancoInterValidate);
                if (banco1 == null || banco1.isEmpty()) {
                    Reporter.reportEvent(Reporter.MIC_FAIL,
                            "El numero del codigo del banco intermedio beneficiario no existe.");
                    return "Error";
                }
            }

            Evidence.save("Enviar al exterior: ", parent);
            parent.click(loc.botonSiguien);
            Util.wait(2);
            if (parent.isDisplayed(loc.mensajeError)) {
                String textoError = parent.getText(loc.textoError);
                Util.wait(1);
                Evidence.save("Enviar al exterior Error: ", parent);
                parent.click(loc.botonAceptar);
                Reporter.reportEvent(Reporter.MIC_FAIL, textoError);
                return "Error";
            }

            if (!parent.waitForElement(loc.txtCotizacion, 20, "loc.txtCotizacion"))
                return "Error";
            Evidence.save("Enviar al exterior: ", parent);
            Util.wait(1);

            // lectura de cotizacion (como en original)
            String moneda = parent.getText(loc.txtMoneda);
            Util.wait(1);
            String monto = parent.getText(loc.txtMonto);
            Util.wait(1);
            String tipoCambio = parent.getText(loc.txtTipoCambio);
            Util.wait(1);
            String montoCambio = parent.getText(loc.txtMontoCambio);
            Util.wait(1);
            String valorPesos = parent.getText(loc.txtValorPesos);
            Util.wait(1);
            String costoServicio = parent.getText(loc.txtCostoServicio);
            Util.wait(1);
            String iva = parent.getText(loc.txtIVA);
            Util.wait(1);
            String descontarCuent = parent.getText(loc.txtDescontarCuenta);
            Util.wait(1);

            Reporter.reportEvent(Reporter.MIC_INFO,
                    "Moneda: " + moneda + System.lineSeparator() + "Monto: " + monto + System.lineSeparator()
                            + "Tipo de cambio a la otra moneda: " + tipoCambio + System.lineSeparator()
                            + "Monto en la otra moneda: " + montoCambio + System.lineSeparator() + "Tasa de cambio: "
                            + montoCambio + System.lineSeparator() + "Valor de la operacion en pesos colombianos: "
                            + valorPesos + System.lineSeparator() + "Costo del servicio: " + costoServicio
                            + System.lineSeparator() + "IVA sobre costo del servicio: " + iva + System.lineSeparator()
                            + "Valor total a descontar de la cuenta: " + descontarCuent);

            parent.click(loc.botonSiguien);
            if (!parent.waitForElement(loc.mensajeInfo, 20, "loc.mensajeInfo"))
                return "Error";
            parent.click(loc.botonAceptar);
            if (!parent.waitForElement(loc.txtConfirmacion, 20, "loc.txtConfirmacion"))
                return "Error";
            Util.wait(1);
            Evidence.saveAllScreens("Confirmacion Envio Exterior", parent);
            Util.wait(1);
            parent.click(loc.btnAprobar);
            Util.wait(2);
            parent.write(loc.tokenInput, getLoginData[5]);
            parent.click(loc.btnConfTr);
            if (!parent.waitForElement(loc.mensajeInfo, 20, "loc.mensajeInfo"))
                return "Error";
            Evidence.save("Numero de consulta", parent);
            String numeroDeConsulta = parent.getText(loc.txtAzul);
            Util.wait(1);
            parent.click(loc.botonAceptar);
            if (!parent.waitForElement(loc.consultas, 20, "loc.consultas"))
                return "Error";
            parent.click(loc.consultas);
            Util.wait(3);
            parent.write(loc.documentBene, getLoginData[42]);
            Util.wait(1);
            parent.click(loc.botonBuscar);
            Util.wait(5);
            String pagTotales = parent.getText(loc.paginTotale);
            String cantiRegis = parent.getText(loc.cantRegist);
            Reporter.reportEvent(Reporter.MIC_INFO, "Páginas Totales: " + pagTotales + System.lineSeparator()
                    + "Cantidad Registros: " + cantiRegis + System.lineSeparator());
            Util.wait(1);
            parent.clickDocumentSimple(numeroDeConsulta);
            if (!parent.waitForElement(loc.txtNumDocum, 20, "loc.consultas"))
                return "Error";
            Evidence.save("Comprobante de transaccion", parent);
        } else {
            parent.click(loc.tipoEnvioFrecuente);
        }

        return "";
    }

    private String recibirAlExte() {
        if (!parent.waitForElement(loc.recibirExt, 20, "loc.recibirExt"))
            return "Error";
        parent.click(loc.recibirExt);
        return "";
    }

    private String aprobaciones() {
        if (!parent.waitForElement(loc.aprobaciones, 20, "loc.aprobaciones"))
            return "Error";
        parent.click(loc.aprobaciones);
        return "";
    }

    private String consultas() {
        if (!parent.waitForElement(loc.consultas, 20, "loc.consultas"))
            return "Error";
        parent.click(loc.consultas);
        return "";
    }

    private String docYForm() {
        if (!parent.waitForElement(loc.DocumYForm, 20, "loc.DocumYForm"))
            return "Error";
        parent.click(loc.DocumYForm);
        return "";
    }

    /* ---------------------- Utilitarios mínimos ---------------------- */
    private static String generarDireccion() {
        int a = RAND.nextInt(200) + 1;
        int b = RAND.nextInt(100);
        int c = RAND.nextInt(100);
        return "KR " + a + " " + String.format("%02d", b) + " " + String.format("%02d", c);
    }
}








package Divisas;

import java.util.ArrayList;
import java.util.List;
import java.util.Random;
import java.util.Set;

import org.openqa.selenium.By;
import org.openqa.selenium.JavascriptExecutor;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.WebElement;
import org.openqa.selenium.support.PageFactory;
import org.openqa.selenium.support.pagefactory.AjaxElementLocatorFactory;

import library.catalogue.ProjectUrls;
import library.common.Util;
import library.core.BasePageWeb;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsRun;

public class Page_Divisas extends BasePageWeb {

    private Locators_Divisas loc;
    private String urlFront;
    private static final Random RAND = new Random();
    private FrontDivisas front; // nuevo campo

    public Page_Divisas(String navegador, boolean middles) throws Exception {
        super(navegador);
        this.loc = new Locators_Divisas();
        AjaxElementLocatorFactory factory = new AjaxElementLocatorFactory(getDriver(), 0);
        PageFactory.initElements(factory, this.loc);

        // inicializa front (delegación)
        this.front = new FrontDivisas(this, middles);
    }

    /**
     * delega el flujo completo al front
     */
    public void mainfront(String[] datosLoginGlob) throws Exception {
        front.mainFront(datosLoginGlob);
    }

    /* ------------------- Mantengo utilitarios que usa FrontDivisas ------------------- */

    /**
     * Seleccionar cuenta: devuelve true si seleccionó, false si no.
     */
    public boolean seleccionarCuenta(WebDriver driver, String tipoCuenta, String numeroCuenta) {
        if (driver == null || tipoCuenta == null || numeroCuenta == null)
            return false;

        try {
            waitElement(By.xpath("//table[contains(@class,'table')]"));
            String xpathFila = "//table[contains(@class,'table')]//tbody//tr[" + "td[contains(normalize-space(.),'"
                    + tipoCuenta + "')] and " + "td[contains(normalize-space(.),'" + numeroCuenta + "')]" + "]";

            List<WebElement> filas = driver.findElements(By.xpath(xpathFila));
            if (filas == null || filas.isEmpty())
                return false;

            for (WebElement fila : filas) {
                try {
                    List<WebElement> radios = fila.findElements(
                            By.xpath(".//input[@name='ProductoSeleccionado' and (@type='radio' or not(@type))]"));
                    if (radios == null || radios.isEmpty())
                        continue;

                    WebElement radio = radios.get(0);
                    ((JavascriptExecutor) driver)
                            .executeScript("arguments[0].scrollIntoView({block: 'center', inline: 'nearest'});", radio);

                    if (!radio.isEnabled())
                        continue;

                    if (!radio.isSelected()) {
                        try {
                            radio.click();
                        } catch (Exception clickEx) {
                            ((JavascriptExecutor) driver).executeScript("arguments[0].this.click();", radio);
                        }
                    }
                    return true;
                } catch (Exception e) {
                    continue;
                }
            }
            return false;
        } catch (Exception e) {
            return false;
        }
    }

    public boolean clickDocumentSimple(String docNumber) {
        try {
            By locator = By
                    .xpath("//table[contains(@class,'table')]//tbody//a[normalize-space(text())='" + docNumber + "']");
            this.click(locator); // tu método de click existente
            return true;
        } catch (Exception e) {
            Reporter.reportEvent(Reporter.MIC_FAIL, "No se encontro el documento en la tabla");
            return false;
        }
    }

    /* ---------------------- Utilitarios mínimos ---------------------- */

    protected static String generarDireccion() {
        int a = RAND.nextInt(200) + 1;
        int b = RAND.nextInt(100);
        int c = RAND.nextInt(100);
        return "KR " + a + " " + String.format("%02d", b) + " " + String.format("%02d", c);
    }

    /**
     * Versión simple del waitForElement: intenta 'seconds' veces con wait(1)
     * Devuelve true si visible, false si no.
     * <-- CAMBIO: visibilidad protected para que FrontDivisas pueda reusar -->
     */
    protected boolean waitForElement(WebElement locator, int seconds, String elemento) {
        for (int i = 0; i < seconds; i++) {
            try {
                if (locator != null && locator.isDisplayed())
                    return true;
            } catch (org.openqa.selenium.NoSuchElementException
                    | org.openqa.selenium.StaleElementReferenceException ex) {
                // reintentar
            } catch (Exception ex) {
                Evidence.save("Excepción esperando elemento", this);
                Reporter.reportEvent(Reporter.MIC_FAIL, "Excepción al verificar elemento: " + ex.getMessage());
                Reporter.write("Excepción en waitForElement: " + ex.toString());
                return false;
            }
            Util.wait(1);
        }
        Evidence.save("Elemento no encontrado", this);
        Reporter.reportEvent(Reporter.MIC_FAIL, "Elemento no encontrado tras " + seconds + " segundos");
        Reporter.write("waitForElement: elemento no encontrado " + elemento);
        return false;
    }

    /**
     * Busca y cambia al iframe correcto de divisas (mantiene lógica original).
     */
    public boolean switchToFrameDivisas() throws Exception {
        int contador = 0;
        while (contador <= 30) {
            Util.wait(1);
            WebElement iframe = this.element(loc.iframeIdDivisas);
            if (iframe != null) {
                this.getDriver().switchTo().frame(iframe);
                this.getJse().executeScript("document.body.style.zoom ='90%';");
                return true;
            }

            iframe = this.element(loc.iframeIdDivisasEmpresarial);
            if (iframe != null) {
                this.getDriver().switchTo().frame(iframe);
                return true;
            }

            contador++;
            if (isElementInteractable(loc.sesionEx)) {
                String msg = this.element(loc.sesionEx).getText();
                Reporter.reportEvent(Reporter.MIC_FAIL, msg);
            }
            this.getDriver().switchTo().defaultContent();
        }
        this.getDriver().switchTo().defaultContent();
        Reporter.reportEvent(Reporter.MIC_FAIL, "TimeOut: No se presentá el módulo de divisas");
        return false;
    }

    protected boolean isElementInteractable(String xpath) {
        WebElement element = this.element(xpath);
        return element != null && this.isDisplayed(element) && this.isEnabled(element);
    }

    public void cerrarTodasVentanas() {
        Set<String> handles = getDriver().getWindowHandles();
        List<String> ventanas = new ArrayList<String>(handles);

        for (String ventana : ventanas) {
            getDriver().switchTo().window(ventana);
            getDriver().close();
        }
    }
}
