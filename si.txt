package ControllerPyme;

import java.util.Date;
import java.util.List;
import java.util.Properties;

import org.openqa.selenium.By;
import org.openqa.selenium.WebElement;

import dav.Consultas_Y_Extractos.PageConsultasyExtractos;
import dav.TransaccionesProgramadas.PageTransaccionesProgramadas;
import dav.inscripciones.PageInscripcionesCuenta;
import dav.library.reporting.EvidencePdfFile;
import dav.middlePymes.*;
import dav.pymes.PageLoginPymes;
import dav.pymes.PagePortalPymes;
import dav.pymes.moduloCrearTx.ControllerCrearTx;
import dav.pymes.moduloTx.PageAdminParametros;
import dav.pymes.moduloTx.PageOrigen;
import dav.transversal.DatosDavivienda;
import dav.transversal.DatosEmpresarial;
import dav.transversal.MotorRiesgo;
import library.common.Util;
import library.core.BasePageWeb;
import library.reporting.Reporter;
import library.settings.SettingsRun;

/**
 * Controller que encapsula la lógica de "Inscripciones".
 * Mantiene la misma lógica del Launch original: carga datos, login FRONT, selección
 * de empresa y ejecución del flujo de inscripción.
 */
public class ControllerInscripciones {

    // ======================= PAGES & CONTROLLERS =======================
    private PageLoginPymes pageLogin;
    private PageOrigen pageOrigen;
    
	private PagePortalPymes pagePortalPymes;
    
    private PageUsuariosEmpresa pageUsuariosEmpresa;
    private PageAdminParametros pageAdminParametros;
    private PageConsultasyExtractos pageConsultasyExtractos;
    private PageTransaccionesProgramadas pageTransaccionesProgramadas;
    private PageInscripcionesCuenta pageInscripcionCuenta;

    private ControllerCrearTx controllerCrearTx;
    private ControllerValiPymeMiddle controllerValiPymeMiddle;

    private Properties info;

    // ======================= CONSTANTES =======================
    private static final String TP_LOGIN = "Login";
    private static final String TP_EN_LINEA = "Tx En Linea";
    private static final String TP_PEND_APR = "Tx Pend Aprobación";
    private static final String CN_APRO_PEND = "1";
    private static final String DE_EL_DETALLE = "SI";

    // ======================= VARIABLES GLOBALES =======================
    private String transaccion = MotorRiesgo.TX_EMP_LOGIN_SUCC;
    private String contratacion;
    public static String realizarMR;
    private Date fechaHoraLogMR;

    private String navegador;
    private String empresa;

    private String numCliEmp;
    private String tipoDoc;
    private String numDoc;
    private String clave;
    private String tipoTok;
    private String datoTok;

    // ======================= LOCATORS =======================
    private final By log30 = By.xpath("/html/body/h2[1]/p");
    private final By cerrarSesion = By.xpath("//*[@id='CerrarSesion']");
    private final By fecha = By.xpath("//*[@id='tabla-top']/tbody/tr[1]/td[1]");

    // ======================= CONSTRUCTOR =======================
    public ControllerInscripciones() {
        // constructor ligero; inicializaciones pesadas se hacen en initConfig/doTest
    }

    // Inicializa configuración global (equivalente a doingConfigurations / initializeControllerAndConfiguration)
    public void initConfig() throws Exception {
        String ambiente = SettingsRun.getGlobalData("AMBIENTE_PYME");

        switch (ambiente) {
            case "1":
            case "PROYECTOS":
                ambiente = "PROYECTOS";
                break;
            case "2":
            case "CONTENCION":
                ambiente = "CONTENCION";
                break;
            case "3":
            case "OBSOLESCENCIA":
                ambiente = "OBSOLESCENCIA";
                break;
            case "4":
            case "ONPREMISE":
                ambiente = "ONPREMISE";
                break;
            case "5":
            case "POST_NUBE":
                ambiente = "POST_NUBE";
                break;
            case "6":
            case "CONTENCION_NUBE":
                ambiente = "CONTENCION_NUBE";
                break;
            case "7":
            case "PROYECTOS_NUBE":
                ambiente = "PROYECTOS_NUBE";
                break;
            case "8":
            case "MEJORAS":
                ambiente = "MEJORAS";
                break;
            default:
                Reporter.reportEvent(Reporter.MIC_FAIL, "Opción no válida");
                return;
        }

        Reporter.reportEvent(Reporter.MIC_HEADER, "Nombre del ambiente seleccionado: " + ambiente);
        DatosEmpresarial.AMBIENTE_TEST = ambiente;

        contratacion = SettingsRun.getGlobalData("CONTRATACION");
        realizarMR = SettingsRun.getGlobalData("MOTOR.motorDeRiesgo");
    }

    /**
     * Método principal que contiene la lógica del test (equivalente a doingTest())
     */
    public void doTest() throws Exception {

        // Cargar datos fijos de login middle (desde global data)
        DatosEmpresarial.loadLoginDataFija("0",
                SettingsRun.getGlobalData("MIDDLE.tipoDoc"),
                SettingsRun.getGlobalData("MIDDLE.numeroDeId"),
                SettingsRun.getGlobalData("MIDDLE.clavePersonal"),
                SettingsRun.getGlobalData("MIDDLE.tipoToken"),
                SettingsRun.getGlobalData("MIDDLE.numeroToken"));

        String[] datosLogin = DatosEmpresarial.getLoginData();

        if ("SI".equals(contratacion) || "SOLO".equals(contratacion)) {
            Reporter.reportEvent(Reporter.MIC_INFO,
                    "*** Datos de Logueo Middle: [" + Util.arrayToString(datosLogin, " - ") + "]");
        }

        numCliEmp = datosLogin[0];
        tipoDoc = datosLogin[1];
        numDoc = datosLogin[2];
        clave = datosLogin[3];
        tipoTok = datosLogin[4];
        datoTok = datosLogin[5];

        // Propagar datos a páginas/estáticos que los requieren
        PageLoginPymes.datosMidell(numCliEmp, tipoDoc, numDoc, clave, tipoTok, datoTok);
        PageUsuariosEmpresa.datosMidellToke(datoTok);

        navegador = SettingsRun.getTestData().getParameter("Navegador").trim();

        // Si la contratación es NO, ejecuta el flujo desde FRONT
        if ("NO".equals(contratacion)) {
            this.Front();
        }
    }
    
    
	private void inicializarPagesTransaccionales() {
	}

    /**
     * Flujo FRONT: inicia PageLoginPymes, realiza login, abre popup, selecciona empresa
     * y ejecuta inscripción.
     */
    public void Front() throws Exception {

        // Carga datos del excel / data sheet para login FRONT
        DatosEmpresarial.loadLoginData("Cliente Empresarial", "Tipo Identificación", "Id usuario",
                "Clave personal o CVE", "Tipo Token", "Semilla / Valor Estático / Celular");

        String[] datosLogin = DatosEmpresarial.getLoginData();
        Reporter.reportEvent(Reporter.MIC_INFO,
                "*** Datos de Logueo Front: [" + Util.arrayToString(datosLogin, " - ") + "]");

        int intento = 0;
        String msgError;

        do {
            pageLogin = new PageLoginPymes(navegador);
            msgError = pageLogin.loginFront();
            fechaHoraLogMR = pageLogin.getFechaHoraLogMR();
            pageLogin.selecionambienteClose("NO");

            if (pageLogin.element(log30) != null) {
                pageLogin.NavegadorFront(pageLogin.URL_FRONT);
                intento++;
            }
        } while (pageLogin.element(log30) != null && intento < 3);

        if (msgError == null) {
            Util.wait(3);

            // cerrar ventana actual y cambiar a la emergente
            pageLogin.closeCurrentBrowser();
            Util.wait(3);

            pageLogin.changeWindow(pageLogin.accedioAlPortal());

            empresa = SettingsRun.getTestData().getParameter("Nombre Empresa").trim();
            pageOrigen = new PageOrigen(pageLogin);

            if (pageOrigen == null) {
                Reporter.reportEvent(Reporter.MIC_FAIL, "No fue posible inicializar PageOrigen");
                return;
            }
    
    		pageOrigen = new PageOrigen(pageLogin);
    		pagePortalPymes = new PagePortalPymes(pageLogin);

            // si el mensaje de selección retorna null, se continúa con la inscripción
            // (en el código original se delegaba a pageInscripcionCuenta)
//            msgError = pageOrigen.seleccionarEmpresa(empresa);
			msgError = pagePortalPymes.seleccionarEmpresa(empresa);

            if (msgError == null) {
//                pageInscripcionCuenta = new PageInscripcionesCuenta();
                pageInscripcionCuenta.Inscripcion();
            } else {
                Reporter.reportEvent(Reporter.MIC_FAIL, msgError);
            }
        } else {
            Reporter.reportEvent(Reporter.MIC_FAIL, msgError);
        }
    }

    /**
     * Limpieza / cierre de recursos (equivalente a launchClose internamente).
     */
    public void close() {
        if (DatosDavivienda.RISKMOTOR != null) {
            try {
                DatosDavivienda.RISKMOTOR.cerrarMotorRiesgo();
            } catch (Exception e) {
                Reporter.reportEvent(Reporter.MIC_WARNING, "Error cerrando MotorRiesgo: " + e.getMessage());
            }
        }

        if (this.pageLogin != null) {
            try {
                this.pageLogin.closeAllBrowsers();
            } catch (Exception e) {
                Reporter.reportEvent(Reporter.MIC_WARNING, "Error cerrando navegadores: " + e.getMessage());
            }
        }
    }

    // Getter / Setters si necesitas exponer data al launcher (opcional)
    public Date getFechaHoraLogMR() {
        return fechaHoraLogMR;
    }
}
