package ControllerPyme;

import java.io.File;
import java.io.IOException;
import java.io.PrintWriter;
import java.io.StringWriter;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import org.openqa.selenium.NoSuchSessionException;
import org.openqa.selenium.NoSuchWindowException;
import org.openqa.selenium.WebDriverException;

import dav.Consultas_Y_Extractos.PageConsultasyExtractos;
import dav.library.common.DatosEmpresarial;
import dav.pymes.PageLoginPymes;
import dav.pymes.PagePortalPymes;
import dav.pymes.moduloCrearTx.ControllerCrearTx;
import dav.pymes.moduloTx.PageOrigen;
import library.common.Util;
import library.core.Controller;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsRun;

public class ControllerTestNomProve implements Controller {

	private PageLoginPymes pageLoginPyme;
	private PagePortalPymes pagePortalPymes;
	private PageOrigen pageOrigen;
	private ControllerCrearTx controller;
	private PageConsultasyExtractos pageConsultasyExtractos;

	private String clienteEmpresarial, tipoIdentificación, idUsuario, clavePersonaloCVE, tipoToken, Semilla,
			tipoIDEmpresa, numeroIDEmpresa, nombreEmpresa, servicio, tipProductoOrigen, numeroProductoOrigen,
			archivoDestinostxt;

	private String msgError, ruta;
	private boolean sessionActive = false;
	private boolean testFailed = false;
	private String threadName;

	private static final String[] LOGIN_KEYS = { "Cliente Empresarial", "Tipo Identificación", "Id usuario",
			"Clave personal o CVE", "Tipo Token", "Semilla / Valor Estático / Celular" };

	private static final String[] FLUJO_KEYS = { "Tipo ID Empresa", "Numero ID Empresa", "Nombre Empresa", "Servicio",
			"Tipo producto origen / Franquicia", "Número producto origen", "Archivo Destinos txt" };

	public ControllerTestNomProve() {
		this.threadName = Thread.currentThread().getName();
		Reporter.write("[" + threadName + "] Controller inicializado");
	}

	@Override
	public void destroy() {
		safeCleanup();
	}

	public void cargarDatosNom() throws Exception {
		ruta = Evidence.getNbEvidenceDirectory() + File.separator + "ArchPlanoClone.txt";
		clienteEmpresarial = getParameter(LOGIN_KEYS[0]);
		tipoIdentificación = getParameter(LOGIN_KEYS[1]);
		idUsuario = getParameter(LOGIN_KEYS[2]);
		clavePersonaloCVE = getParameter(LOGIN_KEYS[3]);
		tipoToken = getParameter(LOGIN_KEYS[4]);
		Semilla = getParameter(LOGIN_KEYS[5]);

		tipoIDEmpresa = getParameter(FLUJO_KEYS[0]);
		numeroIDEmpresa = getParameter(FLUJO_KEYS[1]);
		nombreEmpresa = getParameter(FLUJO_KEYS[2]);
		servicio = getParameter(FLUJO_KEYS[3]);
		tipProductoOrigen = getParameter(FLUJO_KEYS[4]);
		numeroProductoOrigen = getParameter(FLUJO_KEYS[5]);
		archivoDestinostxt = getParameter(FLUJO_KEYS[6]);

		DatosEmpresarial.AMBIENTE_TEST = mapAmbiente(SettingsRun.getGlobalData("AMBIENTE_PYME"));
	}

	public void doingTest() {
		// CRÍTICO: Resetear la bandera al inicio de cada iteración
		testFailed = false;
		sessionActive = false;
		
		try {
			Reporter.write("[" + threadName + "] === INICIANDO TEST ===");
			cargarDatosNom();
			File archivo = new File(archivoDestinostxt);
			generarPlanoRCModificado(archivo);
			flujoSoloFront();

			if (!testFailed) {
				Reporter.write("[" + threadName + "] === TEST COMPLETADO EXITOSAMENTE ===");
			} else {
				Reporter.write("[" + threadName + "] === TEST COMPLETADO CON ERRORES ===");
			}
		} catch (NoSuchSessionException e) {
			handleSessionLost("doingTest", e);
		} catch (NoSuchWindowException e) {
			handleWindowClosed("doingTest", e);
		} catch (WebDriverException e) {
			handleDriverException("doingTest", e);
		} catch (NullPointerException e) {
			handleNullPointer("doingTest", e);
		} catch (IOException e) {
			handleIOException("doingTest", e);
		} catch (InterruptedException e) {
			handleInterrupted("doingTest", e);
		} catch (Throwable t) {
			handleUnexpected("doingTest", t);
		} finally {
			safeCleanup();
		}
	}

	public void flujoSoloFront() {
		if (testFailed) {
			Reporter.write("[" + threadName + "] Saltando flujoSoloFront - test ya falló");
			return;
		}

		try {
			loadLoginFrontDataAndReport();

			if (!safeCreateLoginPage()) {
				return;
			}

			if (!safeLogin()) {
				return;
			}

			if (!validateSessionOrFail("post-login")) {
				return;
			}

			if (!switchToCorrectWindow()) {
				return;
			}

			if (!validateSessionOrFail("pre-transaccional")) {
				return;
			}

			flujoFrontTransaccional();

		} catch (NoSuchSessionException e) {
			handleSessionLost("flujoSoloFront", e);
		} catch (NoSuchWindowException e) {
			handleWindowClosed("flujoSoloFront", e);
		} catch (WebDriverException e) {
			handleDriverException("flujoSoloFront", e);
		} catch (Exception e) {
			handleCriticalError("flujoSoloFront", e);
		}
	}

	private boolean safeCreateLoginPage() {
		try {
			Reporter.write("[" + threadName + "] Creando PageLoginPymes");
			pageLoginPyme = new PageLoginPymes();
			sessionActive = true;
			Reporter.write("[" + threadName + "] PageLoginPymes creado exitosamente");
			return true;
		} catch (Exception e) {
			handleCriticalError("Error al crear PageLoginPymes", e);
			return false;
		}
	}

	private boolean safeLogin() {
		try {
			Reporter.write("[" + threadName + "] Ejecutando login");
			msgError = pageLoginPyme.loginFront();

			if (msgError != null && !msgError.isEmpty()) {
				handleError("Error en login: " + msgError);
				return false;
			}

			Reporter.write("[" + threadName + "] Login ejecutado exitosamente");
			return true;
		} catch (NoSuchSessionException e) {
			handleSessionLost("safeLogin", e);
			return false;
		} catch (NoSuchWindowException e) {
			handleWindowClosed("safeLogin", e);
			return false;
		} catch (WebDriverException e) {
			handleDriverException("safeLogin", e);
			return false;
		} catch (Exception e) {
			handleCriticalError("safeLogin", e);
			return false;
		}
	}

	private boolean validateSessionOrFail(String context) {
		if (!isSessionValid()) {
			handleError("Sesión inválida en contexto: " + context);
			return false;
		}
		Reporter.write("[" + threadName + "] Sesión válida en: " + context);
		return true;
	}

	private String[] loadLoginFrontDataAndReport() throws Exception {
		DatosEmpresarial.loadLoginData(LOGIN_KEYS[0], LOGIN_KEYS[1], LOGIN_KEYS[2], LOGIN_KEYS[3], LOGIN_KEYS[4],
				LOGIN_KEYS[5]);
		String[] datosLogin = DatosEmpresarial.getLoginData();
		Reporter.write("[" + threadName + "] Datos de login: [" + Util.arrayToString(datosLogin, " - ") + "]");
		return datosLogin;
	}

	private boolean isSessionValid() {
		try {
			if (pageLoginPyme == null) {
				return false;
			}

			if (pageLoginPyme.getDriver() == null) {
				return false;
			}

			String titulo = pageLoginPyme.getDriver().getTitle();
			Reporter.write("[" + threadName + "] Validación exitosa - Título: " + titulo);
			return true;
		} catch (NoSuchSessionException e) {
			return false;
		} catch (WebDriverException e) {
			return false;
		} catch (Exception e) {
			return false;
		}
	}

	private boolean switchToCorrectWindow() {
		try {
			Util.wait(5);

			if (!validateSessionOrFail("switchToCorrectWindow-inicio")) {
				return false;
			}

			Set<String> handles = null;
			try {
				handles = pageLoginPyme.getDriver().getWindowHandles();
			} catch (NoSuchSessionException e) {
				handleSessionLost("getWindowHandles", e);
				return false;
			} catch (WebDriverException e) {
				handleDriverException("getWindowHandles", e);
				return false;
			}

			List<String> ventanas = new ArrayList<>(handles);
			Reporter.write("[" + threadName + "] Ventanas detectadas: " + ventanas.size());

			if (ventanas.size() >= 2) {
				return switchToSecondWindowAndCloseFirst(ventanas);
			} else if (ventanas.size() == 1) {
				return switchToSingleWindow(ventanas);
			} else {
				handleError("No se detectaron ventanas del navegador");
				return false;
			}
		} catch (NoSuchSessionException e) {
			handleSessionLost("switchToCorrectWindow", e);
			return false;
		} catch (NoSuchWindowException e) {
			handleWindowClosed("switchToCorrectWindow", e);
			return false;
		} catch (WebDriverException e) {
			handleDriverException("switchToCorrectWindow", e);
			return false;
		} catch (Exception e) {
			handleCriticalError("switchToCorrectWindow", e);
			return false;
		}
	}

	private boolean switchToSecondWindowAndCloseFirst(List<String> ventanas) {
		try {
			String firstWindow = ventanas.get(0);
			String secondWindow = ventanas.get(1);

			Reporter.write("[" + threadName + "] Primera: " + firstWindow + " | Segunda: " + secondWindow);

			try {
				pageLoginPyme.getDriver().switchTo().window(secondWindow);
				Util.wait(2);
			} catch (NoSuchWindowException e) {
				handleWindowClosed("switchTo secondWindow", e);
				return false;
			}

			try {
				pageLoginPyme.getDriver().switchTo().window(firstWindow);
				pageLoginPyme.getDriver().close();
				pageLoginPyme.getDriver().switchTo().window(secondWindow);
				Reporter.write("[" + threadName + "] Primera ventana cerrada, usando segunda");
			} catch (NoSuchWindowException e) {
				Reporter.write("[" + threadName + "] Primera ventana ya cerrada, continuando con segunda");
				try {
					pageLoginPyme.getDriver().switchTo().window(secondWindow);
				} catch (Exception ex) {
					handleWindowClosed("switchTo secondWindow after close attempt", ex);
					return false;
				}
			} catch (Exception e) {
				Reporter.write("[" + threadName + "] Error al cerrar primera ventana: " + e.getMessage());
				try {
					pageLoginPyme.getDriver().switchTo().window(secondWindow);
				} catch (Exception ex) {
					handleCriticalError("switchTo secondWindow after error", ex);
					return false;
				}
			}

			return true;
		} catch (Exception e) {
			handleCriticalError("switchToSecondWindowAndCloseFirst", e);
			return false;
		}
	}

	private boolean switchToSingleWindow(List<String> ventanas) {
		try {
			Reporter.write("[" + threadName + "] Solo una ventana, continuando");
			pageLoginPyme.getDriver().switchTo().window(ventanas.get(0));
			return true;
		} catch (NoSuchWindowException e) {
			handleWindowClosed("switchToSingleWindow", e);
			return false;
		} catch (Exception e) {
			handleCriticalError("switchToSingleWindow", e);
			return false;
		}
	}

	private void flujoFrontTransaccional() {
		if (testFailed) {
			Reporter.write("[" + threadName + "] Saltando flujoFrontTransaccional - test ya falló");
			return;
		}

		try {
			if (!validateSessionOrFail("flujoFrontTransaccional-inicio")) {
				return;
			}

			pageOrigen = new PageOrigen(pageLoginPyme);
			pagePortalPymes = new PagePortalPymes(pageLoginPyme);
			String localMsgError = null;

			try {
				pagePortalPymes.changeToDefaultFrame();
				localMsgError = pagePortalPymes.seleccionarEmpresa(nombreEmpresa);
				if (localMsgError != null) {
					Reporter.write("[" + threadName + "] " + localMsgError);
				}
			} catch (NoSuchSessionException e) {
				handleSessionLost("seleccionarEmpresa intento 1", e);
				return;
			} catch (Exception e) {
				Reporter.write("[" + threadName + "] Intento alternativo de selección de empresa");

				try {
					pagePortalPymes.changeToFirstFrame();
					localMsgError = pagePortalPymes.seleccionarEmpresa(nombreEmpresa);
					if (localMsgError != null) {
						Reporter.write("[" + threadName + "] " + localMsgError);
					}
				} catch (NoSuchSessionException ex) {
					handleSessionLost("seleccionarEmpresa intento 2", ex);
					return;
				} catch (Exception ex) {
					handleCriticalError("seleccionarEmpresa", ex);
					return;
				}
			}

			if (!validateSessionOrFail("pre-transar")) {
				return;
			}

			transar();
		} catch (NoSuchSessionException e) {
			handleSessionLost("flujoFrontTransaccional", e);
		} catch (NoSuchWindowException e) {
			handleWindowClosed("flujoFrontTransaccional", e);
		} catch (WebDriverException e) {
			handleDriverException("flujoFrontTransaccional", e);
		} catch (Exception e) {
			handleCriticalError("flujoFrontTransaccional", e);
		}
	}

	public void transar() {
		if (testFailed) {
			Reporter.write("[" + threadName + "] Saltando transar - test ya falló");
			return;
		}

		try {
			if (!validateSessionOrFail("transar-inicio")) {
				return;
			}

			controller = new ControllerCrearTx(pageLoginPyme);

			try {
				controller.crearPagoNomina_Proveedores(false);
			} catch (NoSuchSessionException e) {
				handleSessionLost("crearPagoNomina_Proveedores", e);
				return;
			} catch (NoSuchWindowException e) {
				handleWindowClosed("crearPagoNomina_Proveedores", e);
				return;
			} catch (WebDriverException e) {
				handleDriverException("crearPagoNomina_Proveedores", e);
				return;
			}

			if (isSessionValid()) {
				try {
					pageLoginPyme.changeToDefaultFrame();
					pageLoginPyme.CerrarSesionFront();
					sessionActive = false;
					Reporter.write("[" + threadName + "] Sesión cerrada exitosamente");
				} catch (NoSuchSessionException e) {
					Reporter.write("[" + threadName + "] Sesión ya cerrada al intentar cerrar");
					sessionActive = false;
				} catch (Exception e) {
					Reporter.write("[" + threadName + "] Error al cerrar sesión: " + e.getMessage());
				}
			}

			Reporter.write("[" + threadName + "] Transacción completada");
		} catch (NoSuchSessionException e) {
			handleSessionLost("transar", e);
		} catch (NoSuchWindowException e) {
			handleWindowClosed("transar", e);
		} catch (WebDriverException e) {
			handleDriverException("transar", e);
		} catch (Exception e) {
			handleCriticalError("transar", e);
		}
	}

	// ========== MANEJADORES DE EXCEPCIONES ==========

	private void handleSessionLost(String context, Throwable e) {
		testFailed = true;
		String msg = "[" + threadName + "] Sesión perdida en " + context + ": " + e.getMessage();
		Reporter.reportEvent(Reporter.MIC_FAIL, msg);
		Reporter.write("La sesión del navegador fue cerrada o perdida");
		logStackTrace(e);
		sessionActive = false;
	}

	private void handleWindowClosed(String context, Throwable e) {
		testFailed = true;
		String msg = "[" + threadName + "] Ventana cerrada en " + context + ": " + e.getMessage();
		Reporter.reportEvent(Reporter.MIC_FAIL, msg);
		Reporter.write("La ventana del navegador fue cerrada inesperadamente");
		logStackTrace(e);
		sessionActive = false;
	}

	private void handleDriverException(String context, Throwable e) {
		testFailed = true;
		String msg = "[" + threadName + "] WebDriverException en " + context + ": " + e.getMessage();
		Reporter.reportEvent(Reporter.MIC_FAIL, msg);
		logStackTrace(e);
	}

	private void handleNullPointer(String context, Throwable e) {
		testFailed = true;
		String msg = "[" + threadName + "] NullPointerException en " + context + ": " + e.getMessage();
		Reporter.reportEvent(Reporter.MIC_FAIL, msg);
		logStackTrace(e);
	}

	private void handleIOException(String context, Throwable e) {
		testFailed = true;
		String msg = "[" + threadName + "] IOException en " + context + ": " + e.getMessage();
		Reporter.reportEvent(Reporter.MIC_FAIL, msg);
		logStackTrace(e);
	}

	private void handleInterrupted(String context, Throwable e) {
		testFailed = true;
		String msg = "[" + threadName + "] Hilo interrumpido en " + context;
		Reporter.reportEvent(Reporter.MIC_FAIL, msg);
		Thread.currentThread().interrupt();
	}

	private void handleUnexpected(String context, Throwable t) {
		testFailed = true;
		String msg = "[" + threadName + "] Error inesperado (" + t.getClass().getSimpleName() + ") en " + context + ": "
				+ t.getMessage();
		Reporter.reportEvent(Reporter.MIC_FAIL, msg);
		logStackTrace(t);
	}

	private void handleError(String mensaje) {
		testFailed = true;
		Reporter.reportEvent(Reporter.MIC_FAIL, "[" + threadName + "] " + mensaje);
	}

	private void handleCriticalError(String context, Throwable t) {
		testFailed = true;
		String msg = "[" + threadName + "] Error crítico en " + context + ": " + t.getClass().getSimpleName() + " - "
				+ t.getMessage();
		Reporter.reportEvent(Reporter.MIC_FAIL, msg);
		logStackTrace(t);
	}

	private void logStackTrace(Throwable t) {
		try {
			StringWriter sw = new StringWriter();
			PrintWriter pw = new PrintWriter(sw);
			t.printStackTrace(pw);
			Reporter.write("Stack Trace:");
			Reporter.write(sw.toString());
		} catch (Exception e) {
			Reporter.write("No se pudo registrar stack trace");
		}
	}

	// ========== LIMPIEZA ==========

	private void safeCleanup() {
		Reporter.write("[" + threadName + "] >>> Iniciando limpieza de recursos <<<");

		if (sessionActive) {
			try {
				if (pageLoginPyme != null && isSessionValid()) {
					pageLoginPyme.changeToDefaultFrame();
					pageLoginPyme.CerrarSesionFront();
					Reporter.write("[" + threadName + "] Sesión cerrada en cleanup");
				}
			} catch (NoSuchSessionException e) {
				Reporter.write("[" + threadName + "] Sesión ya cerrada en cleanup");
			} catch (Exception e) {
				Reporter.write("[" + threadName + "] Error al cerrar sesión en cleanup: " + e.getMessage());
			}
		}

		try {
			if (pageLoginPyme != null && pageLoginPyme.getDriver() != null) {
				try {
					Set<String> handles = pageLoginPyme.getDriver().getWindowHandles();
					Reporter.write("[" + threadName + "] Cerrando " + handles.size() + " ventana(s)");

					for (String handle : handles) {
						try {
							pageLoginPyme.getDriver().switchTo().window(handle);
							pageLoginPyme.getDriver().close();
						} catch (NoSuchWindowException | NoSuchSessionException e) {
							break;
						} catch (Exception e) {
							// Continuar
						}
					}
				} catch (NoSuchSessionException e) {
					Reporter.write("[" + threadName + "] Sesión ya terminada al intentar cerrar ventanas");
				} catch (Exception e) {
					Reporter.write("[" + threadName + "] Error al enumerar ventanas: " + e.getMessage());
				}
			}
		} catch (Exception e) {
			Reporter.write("[" + threadName + "] Error al cerrar ventanas: " + e.getMessage());
		}

		try {
			if (pageLoginPyme != null && pageLoginPyme.getDriver() != null) {
				try {
					pageLoginPyme.getDriver().quit();
					Reporter.write("[" + threadName + "] Driver cerrado exitosamente");
				} catch (Exception e) {
					Reporter.write("[" + threadName + "] Error al cerrar driver: " + e.getMessage());
				}
			}
		} catch (Exception e) {
			Reporter.write("[" + threadName + "] Error al acceder al driver: " + e.getMessage());
		}

		sessionActive = false;
		Reporter.write("[" + threadName + "] >>> Limpieza completada <<<");
	}

	// ========== MÉTODOS AUXILIARES ==========

	private String mapAmbiente(String raw) throws Exception {
		if (raw == null)
			return "";
		switch (raw) {
		case "1":
		case "PROYECTOS":
			return "PROYECTOS";
		case "2":
		case "CONTENCION":
			return "CONTENCION";
		case "3":
		case "OBSOLESCENCIA":
			return "OBSOLESCENCIA";
		case "4":
		case "ONPREMISE":
			return "ONPREMISE";
		case "5":
		case "POST_NUBE":
			return "POST_NUBE";
		case "6":
		case "CONTENCION_NUBE":
			return "CONTENCION_NUBE";
		case "7":
		case "PROYECTOS_NUBE":
			return "PROYECTOS_NUBE";
		case "8":
		case "PROYECTOS_SO":
			return "PROYECTOS_SO";
		case "9":
		case "MEJORAS":
			return "MEJORAS";
		default:
			throw new IllegalArgumentException("Ambiente no válido: " + raw);
		}
	}

	public void postAprobacionUnaFirma() {
		if (testFailed || !isSessionValid()) {
			Reporter.write("[" + threadName + "] Saltando post-aprobación");
			return;
		}

		try {
			if (!servicio.contains("Internacionales") && !servicio.contains("Divisas")
					&& !servicio.contains("Pagos Automaticos") && !servicio.contains("ORPA")) {
				pageConsultasyExtractos = new PageConsultasyExtractos(pageLoginPyme);
				String tipoProduct = SettingsRun.getTestData().getParameter("Tipo producto origen / Franquicia").trim();
				String numeroProducto = SettingsRun.getTestData().getParameter("Número producto origen").trim();

				pageConsultasyExtractos.ConsultayExtractos(servicio, "CHROME", tipoIDEmpresa, numeroIDEmpresa,
						tipoIdentificación, idUsuario, tipoProduct, numeroProducto, false, null);
			}
		} catch (NoSuchSessionException e) {
			handleSessionLost("postAprobacionUnaFirma", e);
		} catch (Exception e) {
			handleCriticalError("postAprobacionUnaFirma", e);
		}
	}

	private String getParameter(String key) {
		return SettingsRun.getTestData().getParameter(key);
	}

	public String generarPlanoRCModificado(File archivoPlanoOriginal) throws IOException {
		Path inputPath = archivoPlanoOriginal.toPath();
		java.util.List<String> lineas = Files.readAllLines(inputPath, StandardCharsets.UTF_8);

		if (lineas.isEmpty()) {
			throw new IllegalArgumentException("El archivo plano está vacío.");
		}

		String lineaOriginal = lineas.get(0);
		StringBuilder padded = new StringBuilder(lineaOriginal);
		while (padded.length() < 170) {
			padded.append(' ');
		}
		String original = padded.toString();

		String codigoBanco = original.substring(44, 50);
		String valorTotal = original.substring(50, 68);
		String numeroTotal = original.substring(68, 74);
		String fechaProceso = original.substring(74, 82);
		String horaProceso = original.substring(82, 88);

		if (codigoBanco.trim().isEmpty()) {
			throw new IllegalArgumentException("Código de banco no existe en el plano original.");
		}

		StringBuilder rc = new StringBuilder();
		rc.append("RC");

		String numeroIDEmpresatr = Util.leftComplete(numeroIDEmpresa, 16, '0');
		rc.append(limpiar(numeroIDEmpresatr));
		rc.append(obtenerCodigoServicio(servicio));

		String numeroProductoOrigentr = Util.leftComplete(numeroProductoOrigen, 16, '0');
		rc.append(limpiar(numeroProductoOrigentr));

		rc.append(obtenerTipoCuenta(tipProductoOrigen));
		rc.append(codigoBanco);
		rc.append(valorTotal);
		rc.append(numeroTotal);
		rc.append(fechaProceso);
		rc.append(horaProceso);
		rc.append("0000");
		rc.append("9999");
		rc.append("00000000");
		rc.append("000000");
		rc.append("00");
		rc.append(obtenerTipoID(tipoIDEmpresa));
		rc.append("000000000000");
		rc.append("0000");
		rc.append(Util.repeat('0', 40));

		lineas.set(0, rc.toString());

		Path salida = Paths.get(ruta);
		Files.createDirectories(salida.getParent());
		Files.write(salida, lineas, StandardCharsets.UTF_8, StandardOpenOption.CREATE,
				StandardOpenOption.TRUNCATE_EXISTING);

		return salida.toAbsolutePath().toString();
	}

	private String obtenerTipoID(String cuenta) {
		if (cuenta == null)
			return "03";
		cuenta = cuenta.toLowerCase();
		if (cuenta.contains("cédula de ciudadanía") || cuenta.contains("cedula de ciudadania")) {
			return "01";
		}
		return "03";
	}

	private String obtenerCodigoServicio(String servicio) {
		if (servicio == null)
			return "PROVPROV";
		servicio = servicio.toLowerCase();
		if (servicio.contains("nomina") || servicio.contains("nómina")) {
			return "NOMINOMI";
		}
		return "PROVPROV";
	}

	private String obtenerTipoCuenta(String tipo) {
		if (tipo == null)
			return "CA";
		tipo = tipo.toLowerCase();
		if (tipo.contains("ahorro"))
			return "CA";
		if (tipo.contains("corriente"))
			return "CC";
		return "CA";
	}

	private String limpiar(String valor) {
		return valor == null ? "" : valor.replaceAll("[^0-9]", "");
	}
}
