package lauchTest;

import javax.swing.JOptionPane;
import java.util.Optional;

import dav.library.reporting.EvidencePdfFile;
import library.core.BaseTestNG_XBloque;
import library.reporting.Reporter;
import library.settings.SettingsRun;

/**
 * Launcher para pruebas de Transferencias Internacionales con soporte de bloques.
 * Gestiona el flujo de pruebas para portales PYME y Empresarial.
 */
public class LaunchTestBlock extends BaseTestNG_XBloque {

    // Constantes
    private static final String PARAM_TESTCONFIG = "testConfigId";
    private static final String PARAM_TIPO_CLIENTE = "Tipo Cliente";
    private static final String PARAM_VALIDAR_C360 = "ValidarC360";
    private static final String PARAM_NUMERO_ID_EMPRESA = "Numero ID Empresa";
    private static final String PARAM_INFORMES = "Informes";
    private static final String GLOBAL_STRATUS_KEY = "data.tipoValidacionStratus";
    private static final String PARAM_SIGUIENTE_BLOQUE = "Siguiente bloque";
    private static final String VALOR_FALLA = "Falla";

    private ControllerGeneralDivisas controllerGeneralDivisas;

    @Override
    public void launchData() {
        Reporter.initializeEvidenceType(new EvidencePdfFile());
        Reporter.writeTitle("\n*** PRUEBAS TRANSFERENCIAS INTERNACIONALES ***");

        SettingsRun.DEFAULT_HEADER = 3;
        SettingsRun.ARRAY_DATA_PARAMS = new String[] { PARAM_TESTCONFIG };

        this.setTotalBloques(3, "Trasa", "Global", "Comprobantes");
    }

    @Override
    public void initializeControllerAndConfiguration() throws Exception {
        ControllerGeneralDivisas.PortalType portalType = determinarTipoPortal();
        
        Reporter.reportEvent(Reporter.MIC_HEADER,
                "*** Ingreso al Portal: [" + obtenerNombrePortal(portalType) + "]");

        controllerGeneralDivisas = ControllerGeneralDivisas.getInstance(portalType);

        ejecutarStratusSiAplica();
        SettingsRun.getTestData().addParametersNotExist(PARAM_SIGUIENTE_BLOQUE);
    }

    @Override
    public void doingTest() throws Exception {
        if (validarC360SiAplica()) {
            controllerGeneralDivisas.inicializarSesion();
            controllerGeneralDivisas.transar();
            controllerGeneralDivisas.cerrarSesionDependiemdoPortal();
        }
    }

    public void doingTest2() throws Exception {
        Reporter.reportEvent(Reporter.MIC_INFO, "Proceso en Global");
        
        if (validarSiguienteBloque()) {
            return;
        }

        if (procesarGlobal()) {
            SettingsRun.exitCurrentBloque();
        } else {
            SettingsRun.exitTest("Proceso Global no completado, Fin de la ejecución");
        }
    }

    public void doingTest3() throws Exception {
        if (validarSiguienteBloque()) {
            return;
        }

        ejecutarInformesSiAplica();
        Reporter.write("Fin de la ejecución");
    }

    // ========================================================================
    // MÉTODOS PRIVADOS DE APOYO
    // ========================================================================

    private ControllerGeneralDivisas.PortalType determinarTipoPortal() {
        String tipoPortal = safeGetTestParam(PARAM_TIPO_CLIENTE);
        return "Empresarial".equalsIgnoreCase(tipoPortal)
                ? ControllerGeneralDivisas.PortalType.EMPRESARIAL
                : ControllerGeneralDivisas.PortalType.PYME;
    }

    private String obtenerNombrePortal(ControllerGeneralDivisas.PortalType portalType) {
        String tipoPortal = safeGetTestParam(PARAM_TIPO_CLIENTE);
        return tipoPortal.isEmpty() ? "PYME (Default)" : tipoPortal;
    }

    private void ejecutarStratusSiAplica() throws Exception {
        String stratus = SettingsRun.getGlobalData(GLOBAL_STRATUS_KEY);
        if ("True".equalsIgnoreCase(stratus)) {
            Reporter.reportEvent(Reporter.MIC_HEADER, "INICIO STRATUS");
            controllerGeneralDivisas.LoginStratus();
        }
    }

    private boolean validarC360SiAplica() throws Exception {
        String validarC360 = safeGetTestParam(PARAM_VALIDAR_C360);
        
        if ("SI".equalsIgnoreCase(validarC360)) {
            Reporter.reportEvent(Reporter.MIC_HEADER, "INICIO SESIÓN CLIENTE 360");
            controllerGeneralDivisas.logueoC360();

            String nitEmpre = safeGetTestParam(PARAM_NUMERO_ID_EMPRESA);
            controllerGeneralDivisas.ValidarCCIU(nitEmpre);

            Reporter.write("*** Termina la Validación CLIENTE 360 ***");
        }
        
        return true;
    }

    private boolean validarSiguienteBloque() throws Exception {
        String empresa = SettingsRun.getTestData().getParameter(PARAM_SIGUIENTE_BLOQUE);
        if (VALOR_FALLA.equalsIgnoreCase(empresa)) {
            SettingsRun.exitTestIteration();
            return true;
        }
        return false;
    }

    private boolean procesarGlobal() {
        String[] opciones = { "Completado", "No Completado" };
        int seleccion = JOptionPane.showOptionDialog(
                null,
                "Realizar proceso de Global:",
                "Validación",
                JOptionPane.DEFAULT_OPTION,
                JOptionPane.QUESTION_MESSAGE,
                null,
                opciones,
                opciones[0]
        );

        String resultado = (seleccion == 0) ? "Completado" : "No completado";
        JOptionPane.showMessageDialog(null, "Proceso " + resultado);

        return "Completado".equalsIgnoreCase(resultado);
    }

    private void ejecutarInformesSiAplica() throws Exception {
        String informe = safeGetTestParam(PARAM_INFORMES);
        if ("SI".equalsIgnoreCase(informe)) {
            controllerGeneralDivisas.ValidacionInformeInicial();
            controllerGeneralDivisas.cierreSesionMiddle();
        }
    }

    private String safeGetTestParam(String key) {
        return Optional.ofNullable(SettingsRun.getTestData().getParameter(key))
                .map(String::trim)
                .orElse("");
    }
}



















package lauchTest;

import library.core.BasePageWeb;
import library.core.Controller;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsRun;
import page.middlePymes.ControllerValiPymeMiddle1;
import page.middlePymes.PageUsuariosEmpresa1;
import library.common.Util;
import pages.FrontEmpresarial.ActualizacionDeDatos.PageActualizacionDeDatosEmpresarial;
import pages.actions.Divisas.*;
import pages.actions.FrontEmpresarial.*;
import pages.actios.Pyme.*;
import screens.actions.consulta.StratusProductos;

import java.io.File;

import dav.c360.PageInicioC360;
import dav.c360.PageLogin;
import dav.c360.moduloPersonas.PageEmpresas;
import dav.transversal.*;
import pages.actions.MiddleEmpresarial.*;
import dav.Controllers.*;

/**
 * Controlador General de Divisas para los portales PYME y Portal Empresarial.
 * Implementa patrón Singleton y gestiona operaciones de divisas de forma unificada.
 */
public class ControllerGeneralDivisas implements Controller {

    // ========================================================================
    // ENUMS Y CONSTANTES
    // ========================================================================

    public enum PortalType {
        PYME, EMPRESARIAL
    }

    // Constantes de flujo
    private static final String TP_LOGIN = "Login";
    private static final String TP_EN_LINEA = "Tx En Línea";
    private static final String TP_PEND_APR = "Tx Pend Aprobación";
    private static final String CN_APRO_PEND = "1";
    private static final String VALOR_FALLA = "Falla";
    private static final String PARAM_SIGUIENTE_BLOQUE = "Siguiente bloque";

    // Mensajes de confirmación
    private static final String[] ARR_MSG_BUSCAR_ESTADO = {
        PageConfirmacion1.MSG_EXITO_APROB,
        PageConfirmacion1.MSG_EXITO_PAGO,
        PageConfirmacion1.MSG_EXITO_ENV_OTP,
        PageConfirmacion1.MSG_EXITO_GUARD,
        PageConfirmacion1.MSG_EXITO_APROB_INTER
    };

    private static final String[] ARR_MSG_TX_DECLINADA = {
        PageConfirmacion1.MSG_EXITO_DECL1,
        PageConfirmacion1.MSG_EXITO_DECL2,
        PageConfirmacion1.MSG_EXITO_DECL3,
        PageConfirmacion1.MSG_EXITO_DECL5
    };

    // ========================================================================
    // INSTANCIA SINGLETON
    // ========================================================================

    private static ControllerGeneralDivisas instanciaUnica;
    private PortalType portalType;

    // ========================================================================
    // CONTROLADORES
    // ========================================================================

    private final ControllerGeneralMiddlesEmpresas controlMiddlesEmpresas = 
        ControllerGeneralMiddlesEmpresas.getInstanciaUnicaControllerMiddlesEmpresas();
    private final ControllerMiddleEmpresarial controlMiddleEmpresarial = 
        ControllerMiddleEmpresarial.getInstanciaUnicaControllerMiddleEmpresarial();
    private final ControllerMiddlePyme controlMiddlePyme = 
        ControllerMiddlePyme.getInstanciaUnicaControllerMiddlePyme();

    // ========================================================================
    // PÁGINAS - CLIENTE 360
    // ========================================================================

    private PageLogin pageLoginC360;
    private PageInicioC360 pageInicioC360;
    private PageEmpresas pageEmpresasC360;

    // ========================================================================
    // PÁGINAS - PYME
    // ========================================================================

    private PageLoginPymes1 loginFrontPyme;
    private ControllerValiPymeMiddle1 controllerValiPymeMiddle;
    private PageOrigen1 pageOrigenPyme;
    private PageAdminParametros1 pageAdminParametros;
    private PageActualizacionDeDatos pageActualizacionDeDatos;

    // ========================================================================
    // PÁGINAS - EMPRESARIAL
    // ========================================================================

    private PageLoginFrontEmpresarial loginFrontEmpresarial;
    private PageFrontEmpresarial frontEmpresarial;
    private PageActualizacionDeDatosEmpresarial actualizacionDeDatosFrontEmpresarial;
    private PageLoginMiddleEmpresarial loginMiddleEmpresarial;
    private PageMiddleEmpresarial middleEmpresarial;

    // ========================================================================
    // PÁGINAS - DIVISAS (COMUNES)
    // ========================================================================

    private PageDivisas pageDivisas;
    private PageEnviarTransInternacional pageEnviarTransInternacional;
    private PageRecibirTransferenciasInternacionales pageRecibirTransferenciasInternacionales;
    private PageDocumentos_Y_Formularios pageDocumentos_Y_Formularios;
    private PageConsultatxInternacional pageConsultatxInternacional;
    private PageAprobacionInter pageAprobInter;
    private PageConfirmacion1 pageConf;
    private PageInformesTransInternacionales pageInfoTransInter;

    // ========================================================================
    // VARIABLES DE DATOS
    // ========================================================================

    private String servicio, tipoPrueba, navegador, nombreEmpre, nitEmpre, tipoIdEm;
    private String numCta, tipoCta, referencia1, referencia2, uuid;
    private String valorsin, valorcon;
    private String numerodereferenciaExterna, riesgo, prioridaRiesgo, userAgent;
    private String valorTx, bancoDesTx, estadoTx, montoReal;
    private String cantidadTxPorTipoDestino;
    private String modena, concepTx, concepto, valorNumeral1, valorNumeral2;
    private String tipoEnvio, FechaEnvioFrecuente;
    private String nombreBene, paisDestino, ciudadDestino, direccionBene;
    private String cuentaBene, infoPago, referenciaPago;
    private String tipoCodigo, numeroCodigo, intermediario;
    private String tipoCodigoInter, numeroCodigoInter;

    // Variables de consulta
    private String fecha, hora, moneda;
    private String tipoConstaTxRealizadas, ordenanteBeneficiario, tipoTranferencia;
    private String estado, tipoMoneda, fechaTx, horaTx, fechaDesde, fechaHasta;

    // Variables de caché
    private String lastNumAprobaciones = "";
    private String lastIdusuario = "";
    private String lastempresa = "";

    // Variables estáticas compartidas
    public static String numAprobaciones;
    public static String tipoPruebaStatic;
    public static String numeroTx;

    // Variables Motor de Riesgo
    public static String[] cuentasDesMotor;
    public static String[] datoNumDestCuentas;
    public static String activityAmount;
    public static String bancoDesMotor;
    public static String riesgoBc;
    public static String riesgoEfm;

    // ========================================================================
    // CONSTRUCTOR SINGLETON
    // ========================================================================

    private ControllerGeneralDivisas(PortalType portalType) {
        this.portalType = portalType;
    }

    public static ControllerGeneralDivisas getInstance(PortalType portalType) {
        if (instanciaUnica == null) {
            instanciaUnica = new ControllerGeneralDivisas(portalType);
        }
        return instanciaUnica;
    }

    public static void resetInstance() {
        instanciaUnica = null;
    }

    // ========================================================================
    // CARGA DE DATOS GLOBALES
    // ========================================================================

    private void cargarDatosGlobales() {
        DataDriven td = SettingsRun.getTestData();
        
        this.servicio = getParam(td, "Servicio");
        this.tipoPrueba = getParam(td, "Tipo prueba");
        this.navegador = BasePageWeb.CHROME;
        this.nombreEmpre = getParam(td, "Nombre Empresa");
        this.nitEmpre = getParam(td, "Numero ID Empresa");
        this.tipoIdEm = getParam(td, "Tipo ID Empresa");
        this.tipoCta = getParam(td, "Tipo producto origen");
        this.numCta = getParam(td, "Número producto origen");
        this.referencia1 = getParam(td, "Tipo producto origen");
        this.referencia2 = getParam(td, "Tipo Producto Destino");
        this.valorsin = getParam(td, "Valor a Pagar / Transferir");
        this.valorcon = td.getParameter("Valor a Pagar / Transferir");

        cargarDatosTransferencia(td);
        cargarDatosConsulta(td);
    }

    private void cargarDatosTransferencia(DataDriven td) {
        this.tipoMoneda = getParam(td, "Tipo Moneda");
        this.numerodereferenciaExterna = getParam(td, "Número de referencia Externa");
        this.modena = getParam(td, "Tipo Moneda");
        this.concepTx = getParam(td, "Concepto de la transferencia");
        this.concepto = td.getParameter("Concepto de la transferencia");
        this.valorNumeral1 = getParam(td, "Valor numeral cambiario 1");
        this.valorNumeral2 = getParam(td, "Valor numeral cambiario 2");
        this.tipoEnvio = getParam(td, "Tipo de Envio");
        this.FechaEnvioFrecuente = getParam(td, "Fecha envío frecuente", "dd/mm/yyyy");
        
        this.nombreBene = getParam(td, "Ordenante / Nombre del beneficiario en el exterior");
        this.paisDestino = getParam(td, "País de destino de la transferencia");
        this.ciudadDestino = getParam(td, "Ciudad y país donde está ubicado el beneficiario");
        this.direccionBene = getParam(td, "Dirección del beneficiario");
        this.cuentaBene = getParam(td, "Número de cuenta, IBAN o CLABE");
        this.infoPago = getParam(td, "Información para el beneficiario");
        this.referenciaPago = getParam(td, "Información para el beneficiario Numero");
        
        this.tipoCodigo = getParam(td, "Tipo de código");
        this.numeroCodigo = getParam(td, "Número de código");
        this.intermediario = getParam(td, "Requiere un banco intermediario");
        this.tipoCodigoInter = getParam(td, "Tipo de código Intermediario");
        this.numeroCodigoInter = getParam(td, "Número de código Intermediario");
    }

    private void cargarDatosConsulta(DataDriven td) {
        this.tipoConstaTxRealizadas = getParam(td, "Tiempo de Consulta");
        this.fecha = getParam(td, "Fecha tx", "dd/mm/yyyy");
        this.hora = getParam(td, "Hora tx");
        this.moneda = getParam(td, "Tipo Moneda");
        
        this.ordenanteBeneficiario = getParam(td, "Ordenante / Nombre del beneficiario en el exterior");
        this.tipoTranferencia = getParam(td, "Tipo de Transferencia");
        this.fechaDesde = getParam(td, "Fecha Día Inicial  Desde (dd/mm/YYYY)", "dd/mm/yyyy");
        this.fechaHasta = getParam(td, "Fecha DÍa Final Hasta (dd/mm/YYYY)", "dd/mm/yyyy");
        this.estado = getParam(td, "Estado");
        this.fechaTx = td.getParameter("Fecha tx");
        this.horaTx = td.getParameter("Hora tx");
    }

    private String getParam(DataDriven td, String key) {
        String value = td.getParameter(key);
        return value != null ? value.trim() : "";
    }

    private String getParam(DataDriven td, String key, String format) {
        return td.getParameter(key, format);
    }

    // ========================================================================
    // CONFIGURACIÓN DE COLUMNAS
    // ========================================================================

    private void setearNombreColumnasMiddlesEmpresa() {
        CommonMiddlesEmpresas.COL_TIPO_CLIENTE = "Tipo Cliente";
        CommonMiddlesEmpresas.COL_CLIENTE_EMPRESARIAL = "Cliente Empresarial";
        CommonMiddlesEmpresas.COL_TIPO_IDENTIFICACION_CLIENTE_EMPRESARIAL = "Tipo Identificación";
        CommonMiddlesEmpresas.COL_NUMERO_IDENTIFICACION_CLIENTE_EMPRESARIAL = "Id usuario";
        
        CommonMiddlesEmpresas.COL_NOMBRE_EMPRESA = "Nombre Empresa";
        CommonMiddlesEmpresas.COL_TIPO_IDENTIFICACION_EMPRESA = "Tipo ID Empresa";
        CommonMiddlesEmpresas.COL_NUMERO_IDENTIFICACION_EMPRESA = "Numero ID Empresa";
        
        CommonMiddlesEmpresas.COL_ESCENERIO_PRUEBA = "Escenario de prueba";
        CommonMiddlesEmpresas.COL_NUMERO_PRODUCTO_ORIGEN = "Número producto origen";
    }

    // ========================================================================
    // INICIALIZACIÓN DE SESIÓN
    // ========================================================================

    public void inicializarSesion() throws Exception {
        cargarDatosGlobales();

        if (portalType == PortalType.PYME) {
            inicializarSesionPymeCompleta();
        } else {
            inicializarSesionEmpresarialCompleta();
        }
    }

    private void inicializarSesionPymeCompleta() throws Exception {
        String contratacion = SettingsRun.getGlobalData("CONTRATACION");

        if ("SI".equalsIgnoreCase(contratacion)) {
            String msg = inicializarSesionPymeMiddle();
            if (msg == null) {
                setearNombreColumnasMiddlesEmpresa();
                ContratacionMiddlePyme();
            } else {
                reportarErrorYMarcarFalla("No se pudo Inicializar Middle");
                return;
            }
        }

        inicializarSesionPyme();
    }

    private void inicializarSesionEmpresarialCompleta() throws Exception {
        String contratacion = SettingsRun.getGlobalData("CONTRATACION");
        
        setearNombreColumnasMiddlesEmpresa();
        
        if ("SI".equalsIgnoreCase(contratacion)) {
            ContratacionMiddleEmpresarial();
        }
        
        inicializarSesionEmpresarial();
    }

    // ========================================================================
    // INICIALIZACIÓN PYME MIDDLE
    // ========================================================================

    private String inicializarSesionPymeMiddle() throws Exception {
        String nombreAmbiente = SettingsRun.getGlobalData("data.ambienteMiddlePyme", "PROYECTOS_NUBE");
        normalizarAmbiente(nombreAmbiente);

        cargarDatosLoginMiddlePyme();
        
        String[] datosLogin = DatosEmpresarial.getLoginData();
        Reporter.reportEvent(Reporter.MIC_INFO,
                "*** Datos de Logueo Middle: [" + Util.arrayToString(datosLogin, " - ") + "]");

        reportarDatosIniciales();
        validarTipoPrueba();

        PageLoginPymes1.datosMidell(datosLogin[0], datosLogin[1], datosLogin[2], 
                                     datosLogin[3], datosLogin[4], datosLogin[5]);
        PageUsuariosEmpresa1.datosMidellToke(datosLogin[5]);

        String evidenceDir = SettingsRun.RESULT_DIR + File.separator + "Temp";
        this.loginFrontPyme = new PageLoginPymes1("CHROME", evidenceDir);
        String msgError = this.loginFrontPyme.loginMiddle();
        this.loginFrontPyme.selecionambienteClose("SI");

        return msgError;
    }

    private void cargarDatosLoginMiddlePyme() {
        DatosEmpresarial.loadLoginDataFija(
            "0",
            SettingsRun.getGlobalData("data.tipoIdPyme"),
            SettingsRun.getGlobalData("data.numIdPyme"),
            SettingsRun.getGlobalData("data.clavepersonalPyme"),
            SettingsRun.getGlobalData("data.tipoTkPyme"),
            SettingsRun.getGlobalData("data.tokenEstaticoPyme")
        );
    }

    private void reportarDatosIniciales() {
        DataDriven td = SettingsRun.getTestData();
        
        Reporter.reportEvent(Reporter.MIC_INFO, 
            "*** Cliente Empresarial: [" + getParam(td, "Cliente Empresarial") + "]");
        Reporter.reportEvent(Reporter.MIC_INFO,
            String.format("*** Tipo Identificación Usuario: [%s] - Id Usuario: [%s]",
                getParam(td, "Tipo Identificación"), getParam(td, "Id usuario")));
        Reporter.reportEvent(Reporter.MIC_INFO,
            "*** Tipo Servicio a contratar: [" + this.servicio + "]");
        Reporter.reportEvent(Reporter.MIC_INFO,
            "*** Empresa a contratar: [" + getParam(td, "Nombre Empresa") + "]");
        Reporter.reportEvent(Reporter.MIC_INFO,
            String.format("*** Tipo Identificación Empresa: [%s] - Numero: [%s]",
                getParam(td, "Tipo ID Empresa"), getParam(td, "Numero ID Empresa")));
    }

    private void validarTipoPrueba() throws Exception {
        if (this.tipoPrueba == null || this.tipoPrueba.trim().isEmpty()) {
            Reporter.write("Falta Ingresar Datos de Tipo Prueba, Campo es Obligatorio");
            SettingsRun.exitTestIteration();
        }
    }

    // ========================================================================
    // CONTRATACIÓN MIDDLE PYME
    // ========================================================================

    public void ContratacionMiddlePyme() throws Exception {
        this.controllerValiPymeMiddle = new ControllerValiPymeMiddle1(this.loginFrontPyme);
        this.numAprobaciones = getParam(SettingsRun.getTestData(), "Números de Aprobaciones");

        boolean unaFirma = CN_APRO_PEND.equals(this.numAprobaciones);
        int numfirm = Integer.parseInt(this.numAprobaciones);

        if (!unaFirma) {
            ejecutarContratacionMultiplesFirmas(numfirm);
        } else {
            controllerValiPymeMiddle.ValidacionMiddlefirmas(1);
        }

        this.loginFrontPyme.CerrarSesionMiddle();
    }

    private void ejecutarContratacionMultiplesFirmas(int numfirm) throws Exception {
        controllerValiPymeMiddle.ValidacionMiddlefirmas(1);
        
        for (int contador = 2; contador <= numfirm; contador++) {
            controllerValiPymeMiddle.ValidacionMiddlefirmas(contador);
        }
    }

    // ========================================================================
    // INICIALIZACIÓN PYME FRONT
    // ========================================================================

    private void inicializarSesionPyme() throws Exception {
        cargarDatosLoginFrontPyme();
        
        String nombreAmbiente = SettingsRun.getGlobalData("data.ambienteFrontPyme", "PROYECTOS_NUBE");
        normalizarAmbiente(nombreAmbiente);

        String evidenceDir = SettingsRun.RESULT_DIR + File.separator + "Temp";
        loginFrontPyme = new PageLoginPymes1(this.navegador, evidenceDir);

        String msgError = loginFrontPyme.loginFront();
        if (msgError != null) {
            reportarErrorYMarcarFalla(msgError);
            loginFrontPyme.terminarIteracion();
            return;
        }

        loginFrontPyme.selecionambienteClose("NO");
        Util.wait(5);

        validarVentanaEmergente();
        
        loginFrontPyme.closeCurrentBrowser();
        loginFrontPyme.changeWindow(loginFrontPyme.accedioAlPortal());
        loginFrontPyme.maximizeBrowser();
        
        seleccionarEmpresaPyme();
        configurarParametrosGeneralesPyme();
        actualizarDatosEmpresaPymeSiRequiere();
        inicializarPaginasDivisas(loginFrontPyme);
    }

    private void cargarDatosLoginFrontPyme() {
        DatosEmpresarial.loadLoginData(
            "Cliente Empresarial",
            "Tipo Identificación",
            "Id usuario",
            "Clave personal o CVE",
            "Tipo Token",
            "Semilla / Valor Estático / Celular"
        );

        String[] datosLogin = DatosEmpresarial.getLoginData();
        Reporter.reportEvent(Reporter.MIC_INFO, "*** Navegador: [" + this.navegador + "]");
        Reporter.reportEvent(Reporter.MIC_INFO,
                "*** Datos de Logueo Front: [" + Util.arrayToString(datosLogin, " - ") + "]");
    }

    private void validarVentanaEmergente() throws Exception {
        boolean isWindowOpened = this.loginFrontPyme.WaitForNumberOfWindos();
        if (!isWindowOpened) {
            reportarErrorYMarcarFalla("No se abrió La ventana emergente");
            this.loginFrontPyme.terminarIteracion();
        } else {
            Reporter.reportEvent(Reporter.MIC_PASS, "La ventana emergente se abrió correctamente");
        }
    }

    private void seleccionarEmpresaPyme() throws Exception {
        pageOrigenPyme = new PageOrigen1(loginFrontPyme);
        String empresa = getParam(SettingsRun.getTestData(), "Nombre Empresa");
        String msgError = pageOrigenPyme.seleccionarEmpresa(empresa);
        
        if (msgError != null) {
            reportarErrorYMarcarFalla(msgError);
            pageOrigenPyme.terminarIteracion();
        }
    }

    // ========================================================================
    // VALIDACIÓN DE INFORMES
    // ========================================================================

    public void ValidacionInformeInicial() throws Exception {
        if (portalType == PortalType.PYME) {
            validarInformeMiddlePyme();
        } else {
            validarInformeMiddleEmpresa();
        }
    }

    private void validarInformeMiddlePyme() throws Exception {
        String msg = inicializarSesionPymeMiddle();
        if (msg == null) {
            ValidacionInformeMiddlePyme();
        } else {
            reportarErrorYMarcarFalla("No se pudo Inicializar Middle");
        }
    }

    private void validarInformeMiddleEmpresa() throws Exception {
        String msg = inicializarSesionMiddleEmpresarial();
        if (msg == null) {
            ValidacionInformeMiddleEmpresa();
        } else {
            reportarErrorYMarcarFalla("No se pudo Inicializar Middle Empresarial");
        }
    }

    private void ValidacionInformeMiddlePyme() throws Exception {
        this.controllerValiPymeMiddle = new ControllerValiPymeMiddle1(this.loginFrontPyme);
        controllerValiPymeMiddle.ValidacionInformeTransInternacional();
    }

    private void ValidacionInformeMiddleEmpresa() throws Exception {
        pageInfoTransInter = new PageInformesTransInternacionales(loginMiddleEmpresarial);
        
        String tipoIDUser = getParam(SettingsRun.getTestData(), "Tipo Identificación");
        String numIdUser = getParam(SettingsRun.getTestData(), "Id usuario");
        String idEmpresa = this.nitEmpre;
        
        pageInfoTransInter.irAOpcionTransFerenciasInDivisas(true);
        String msg = pageInfoTransInter.InformeTransInter(this.servicio, tipoIDUser, numIdUser, idEmpresa);
        
        if (msg != null) {
            if (SettingsRun.esIteracionFinal()) {
                cierreSesionMiddle();
            }
            SettingsRun.exitTestIteration();
        }
    }

    // ========================================================================
    // NORMALIZACIÓN DE AMBIENTE
    // ========================================================================

    private void normalizarAmbiente(String nombreAmbiente) {
        String ambienteNormalizado = normalizarNombreAmbiente(nombreAmbiente);
        
        if (ambienteNormalizado.isEmpty()) {
            reportarErrorYMarcarFalla("Nombre del ambiente seleccionado inválido: " + nombreAmbiente);
        } else {
            Reporter.reportEvent(Reporter.MIC_HEADER, 
                "Nombre del ambiente seleccionado: Portal - " + ambienteNormalizado);
            DatosEmpresarial.AMBIENTE_TEST = ambienteNormalizado;
        }
    }

    private String normalizarNombreAmbiente(String nombreAmbiente) {
        switch (nombreAmbiente) {
            case "1": case "PROYECTOS": return "PROYECTOS";
            case "2": case "CONTENCION": return "CONTENCION";
            case "3": case "OBSOLESCENCIA": return "OBSOLESCENCIA";
            case "4": case "ONPREMISE": return "ONPREMISE";
            case "5": case "POST_NUBE": return "POST_NUBE";
            case "6": case "CONTENCION_NUBE": return "CONTENCION_NUBE";
            case "7": case "PROYECTOS_NUBE": return "PROYECTOS_NUBE";
            case "8": case "MEJORAS": return "MEJORAS";
            default: return "";
        }
    }

    // ========================================================================
    // INICIALIZACIÓN MIDDLE EMPRESARIAL
    // ========================================================================

    private String inicializarSesionMiddleEmpresarial() throws Exception {
        loginMiddleEmpresarial = new PageLoginMiddleEmpresarial(BasePageWeb.CHROME);
        middleEmpresarial = new PageMiddleEmpresarial(loginMiddleEmpresarial);

        String tipoDocumento = SettingsRun.getGlobalData("data.tipoIdEmp").trim();
        String numeroDocumento = SettingsRun.getGlobalData("data.numIdEmp").trim();
        String numeroClienteEmpresarial = SettingsRun.getGlobalData("data.numClieEmp").trim();
        String clavePersonal = SettingsRun.getGlobalData("data.clavepersonalEmp").trim();
        String token = SettingsRun.getGlobalData("data.tokenEstaticoEmp").trim();

        return loginMiddleEmpresarial.realizarLoginMiddleEmpresarial(
            tipoDocumento, numeroDocumento, numeroClienteEmpresarial, clavePersonal, token);
    }

    public void cierreSesionMiddle() {
        if (portalType == PortalType.PYME) {
            if (loginFrontPyme != null) {
                loginFrontPyme.CerrarSesionMiddle();
            }
        } else {
            if (middleEmpresarial != null) {
                middleEmpresarial.cierreSesion();
                CommonMiddleEmpresarial.ESTA_LOGUEADO = false;
            }
        }
    }

    // ========================================================================
    // CONTRATACIÓN MIDDLE EMPRESARIAL
    // ========================================================================

    public void ContratacionMiddleEmpresarial() throws Exception {
        this.numAprobaciones = getParam(SettingsRun.getTestData(), "Números de Aprobaciones");
        CommonMiddleEmpresarial.ESTADO_PARAMETRO_NUMERO_FIRMAS = this.numAprobaciones;

        String[] datoDivisas = { "Internacionales" };
        controlMiddleEmpresarial.realizarParametrizacionMiddleEmpresarial(
            datoDivisas, SettingsRun.getCurrentIteration(), "Parametrizacion Contratar Servicio");
        controlMiddleEmpresarial.cierreSesionMiddleEmpresarial();
    }

    // ========================================================================
    // INICIALIZACIÓN EMPRESARIAL FRONT
    // ========================================================================

    private void inicializarSesionEmpresarial() throws Exception {
        cargarDatosLoginFrontEmpresarial();

        String evidenceDir = SettingsRun.RESULT_DIR + File.separator + "Temp";
        loginFrontEmpresarial = new PageLoginFrontEmpresarial(BasePageWeb.CHROME, evidenceDir);

        String msgError = realizarLoginEmpresarial();
        if (msgError != null) {
            terminarIteracionXError(msgError);
            return;
        }

        CommonFrontEmpresarial.ESTA_LOGUEADO = true;
        frontEmpresarial = new PageFrontEmpresarial(loginFrontEmpresarial);

        seleccionarEmpresaEmpresarial();
        actualizarDatosEmpresaSiRequiere();
        inicializarPaginasDivisas(frontEmpresarial);

        msgError = seleccionarTransferenciasInternacionales();
        if (msgError != null) {
            reportarErrorYMarcarFalla(msgError);
            SettingsRun.exitTestIteration();
        }
    }

    private void cargarDatosLoginFrontEmpresarial() {
        DatosEmpresarial.loadLoginData(
            "Cliente Empresarial",
            "Tipo Identificación",
            "Id usuario",
            "Clave personal o CVE",
            "Tipo Token",
            "Semilla / Valor Estático / Celular"
        );

        String[] datosLogin = DatosEmpresarial.getLoginData();
        Reporter.reportEvent(Reporter.MIC_INFO, "*** Navegador: [" + this.navegador + "]");
        Reporter.reportEvent(Reporter.MIC_INFO,
                "*** Datos de Logueo Front: [" + Util.arrayToString(datosLogin, " - ") + "]");
    }

    private String realizarLoginEmpresarial() throws Exception {
        DataDriven td = SettingsRun.getTestData();
        return loginFrontEmpresarial.realizarLogin(
            getParam(td, "Cliente Empresarial"),
            getParam(td, "Tipo Identificación"),
            getParam(td, "Id usuario"),
            obtenerTipoAutenticacion(),
            getParam(td, "Clave personal o CVE"),
            getParam(td, "Semilla / Valor Estático / Celular")
        );
    }

    private void seleccionarEmpresaEmpresarial() throws Exception {
        String empresa = getParam(SettingsRun.getTestData(), "Nombre Empresa");
        String msgError = frontEmpresarial.seleccionarEmpresa(empresa);
        
        if (msgError != null) {
            reportarErrorYMarcarFalla(msgError);
            frontEmpresarial.cerrarSesionFrontEmpresarial();
            SettingsRun.exitTestIteration();
        }
    }

    private String obtenerTipoAutenticacion() {
        String tipoToken = getParam(SettingsRun.getTestData(), "Tipo Token");
        switch (tipoToken) {
            case "ESTATICO": return "Token Estatica";
            case "FISICO": return "Token Fisica";
            case "OTP": return "Clave Virtual";
            default: return tipoToken;
        }
    }

    private String obtenerTipoAutenticacionFrima(int firma) {
        String tipoToken = getParam(SettingsRun.getTestData(), "Tipo Token " + firma);
        switch (tipoToken) {
            case "ESTATICO": return "Token Estatica";
            case "FISICO": return "Token Fisica";
            case "OTP": return "Clave Virtual";
            default: return tipoToken;
        }
    }

    // ========================================================================
    // ACTUALIZACIÓN DE DATOS
    // ========================================================================

    private void actualizarDatosEmpresaSiRequiere() throws Exception {
        if (!requiereActualizacionDatos()) {
            return;
        }

        String codigoCIIU = getParam(SettingsRun.getTestData(), "Validar CIIU");
        if (!"SI".equalsIgnoreCase(codigoCIIU)) {
            return;
        }

        Util.wait(3);
        actualizacionDeDatosFrontEmpresarial = new PageActualizacionDeDatosEmpresarial(frontEmpresarial);
        
        String infoTipoEmpresa = getParam(SettingsRun.getTestData(), "Tipo de empresa");
        String infoCodigoCIIU = getParam(SettingsRun.getTestData(), "Código CIIU");
        
        String msgError = actualizacionDeDatosFrontEmpresarial.InicioActualizacionDatos(
            infoTipoEmpresa, infoCodigoCIIU);

        procesarResultadoActualizacion(msgError);
    }

    private void actualizarDatosEmpresaPymeSiRequiere() throws Exception {
        if (!requiereActualizacionDatos()) {
            return;
        }

        String codigoCIIU = getParam(SettingsRun.getTestData(), "Validar CIIU");
        if (!"SI".equalsIgnoreCase(codigoCIIU)) {
            return;
        }

        Util.wait(3);
        pageActualizacionDeDatos = new PageActualizacionDeDatos(loginFrontPyme);
        String msgError = pageActualizacionDeDatos.InicioActualizacionDatos(false);
        
        if (msgError != null && !"Se actualizaron exitosamente los datos de su empresa".equals(msgError)) {
            msgError = pageActualizacionDeDatos.MsgAlertaActualizacionDatos();
        } else {
            Reporter.reportEvent(Reporter.MIC_PASS, msgError);
        }
    }

    private boolean requiereActualizacionDatos() {
        return this.servicio.contains("Tx Internacionales Recibir desde el exterior") ||
               this.servicio.contains("Tx Internacionales Enviar al exterior");
    }

    private void procesarResultadoActualizacion(String msgError) throws Exception {
        if (msgError == null) {
            return;
        }

        if (msgError.equals("Se actualizaron exitosamente los datos de su empresa")) {
            Reporter.reportEvent(Reporter.MIC_PASS, msgError);
        } else if (msgError.contains("No se encuentra el modulo: Actualización de datos")) {
            this.terminarIteracionXError(msgError);
        } else if (msgError.contains("No se relizo la actualizacion de los datos")) {
            Reporter.reportEvent(Reporter.MIC_INFO, msgError);
        }
    }

    // ========================================================================
    // CONFIGURACIÓN DE PARÁMETROS
    // ========================================================================

    private void configurarParametrosGeneralesPyme() throws Exception {
        DataDriven td = SettingsRun.getTestData();
        String numAprobaciones = getParam(td, "Números de Aprobaciones");
        String Idusuario = getParam(td, "Id usuario");
        String empresa = getParam(td, "Nombre Empresa");

        if (parametrosYaConfigurados(numAprobaciones, Idusuario, empresa)) {
            return;
        }

        pageAdminParametros = new PageAdminParametros1(loginFrontPyme);
        String msgError = pageAdminParametros.hacerConfiguracion(numAprobaciones, "", "");

        if (msgError != null && !msgError.contains("exitosa")) {
            reportarErrorYMarcarFalla(msgError);
            throw new Exception("Configuración de parámetros generales fallida: " + msgError);
        }

        actualizarCacheParametros(numAprobaciones, Idusuario, empresa);
    }

    private boolean parametrosYaConfigurados(String numAprobaciones, String idUsuario, String empresa) {
        return idUsuario.equals(lastIdusuario) && 
               empresa.equals(lastempresa) && 
               numAprobaciones.equals(lastNumAprobaciones);
    }

    private void actualizarCacheParametros(String numAprobaciones, String idUsuario, String empresa) {
        lastNumAprobaciones = numAprobaciones;
        lastIdusuario = idUsuario;
        lastempresa = empresa;
    }

    // ========================================================================
    // INICIALIZACIÓN DE PÁGINAS DIVISAS
    // ========================================================================

    private void inicializarPaginasDivisas(BasePageWeb parentPage) {
        pageDivisas = new PageDivisas(parentPage);
        pageEnviarTransInternacional = new PageEnviarTransInternacional(parentPage);
        pageRecibirTransferenciasInternacionales = new PageRecibirTransferenciasInternacionales(parentPage);
        pageDocumentos_Y_Formularios = new PageDocumentos_Y_Formularios(parentPage);
        pageConsultatxInternacional = new PageConsultatxInternacional(parentPage);
        pageAprobInter = new PageAprobacionInter(parentPage);
        pageConf = new PageConfirmacion1(parentPage);
    }

    public String seleccionarTransferenciasInternacionales() throws Exception {
        String msgError = pageDivisas.seleDivisasEmpresarial("Transferencias Internacionales");
        
        if (msgError != null) {
            Reporter.reportEvent(Reporter.MIC_NOT_COMPLETED,
                    "Modulo de Servicio: [Transferencias Internacionales] No Encontrada");
            frontEmpresarial.cerrarSesionFrontEmpresarial();
            CommonFrontEmpresarial.ESTA_LOGUEADO = false;
        }
        
        pageDivisas.ErrorSesionExpirada();
        return msgError;
    }

    // ========================================================================
    // LOGIN POR FIRMAS
    // ========================================================================

    public void loginPorFirmas(int firma) throws Exception {
        if (portalType == PortalType.PYME) {
            loginPorFirmasPyme(firma);
        } else {
            loginPorFirmasEmpresarial(firma);
        }
    }

    private void loginPorFirmasPyme(int firma) throws Exception {
        cargarDatosLoginFirma(firma);

        loginFrontPyme = new PageLoginPymes1(this.navegador);
        String msgError = loginFrontPyme.loginFrontFirmas();
        
        loginFrontPyme.selecionambienteClose("NO");
        loginFrontPyme.maximizeBrowser();
        loginFrontPyme.changeWindow(loginFrontPyme.accedioAlPortal());

        pageOrigenPyme = new PageOrigen1(loginFrontPyme);
        String empresa = getParam(SettingsRun.getTestData(), "Nombre Empresa");
        msgError = pageOrigenPyme.seleccionarEmpresa(empresa);
        
        if (msgError != null) {
            reportarErrorYMarcarFalla(msgError);
            pageOrigenPyme.terminarIteracion();
        }
    }

    private void loginPorFirmasEmpresarial(int firma) throws Exception {
        cargarDatosLoginFirma(firma);

        String[] datosLogin = DatosEmpresarial.getLoginData();
        Reporter.reportEvent(Reporter.MIC_INFO, 
            "*** Datos de Logueo Front usuario #" + firma + ": [" + 
            Util.arrayToString(datosLogin, " - ") + "]");

        loginFrontEmpresarial = new PageLoginFrontEmpresarial(BasePageWeb.CHROME);
        
        DataDriven td = SettingsRun.getTestData();
        String msgError = loginFrontEmpresarial.realizarLogin(
            getParam(td, "Cliente Empresarial"),
            getParam(td, "Tipo Identificación " + firma),
            getParam(td, "Id usuario " + firma),
            obtenerTipoAutenticacionFrima(firma),
            getParam(td, "Clave personal o CVE " + firma),
            getParam(td, "Semilla / Valor Estático / Celular " + firma)
        );

        CommonFrontEmpresarial.ESTA_LOGUEADO = true;

        if (msgError != null) {
            reportarErrorYMarcarFalla(msgError);
            SettingsRun.exitTestIteration();
            return;
        }

        frontEmpresarial = new PageFrontEmpresarial(loginFrontEmpresarial);
        String empresa = getParam(td, "Nombre Empresa");
        msgError = frontEmpresarial.seleccionarEmpresa(empresa);
        
        if (msgError != null) {
            reportarErrorYMarcarFalla(msgError);
            frontEmpresarial.cerrarSesionFrontEmpresarial();
            SettingsRun.exitTestIteration();
            return;
        }

        inicializarPaginasDivisas(frontEmpresarial);
        
        msgError = seleccionarTransferenciasInternacionales();
        if (msgError != null) {
            reportarErrorYMarcarFalla(msgError);
            SettingsRun.exitTestIteration();
        }
    }

    private void cargarDatosLoginFirma(int firma) {
        DatosEmpresarial.loadLoginData(
            "Cliente Empresarial",
            "Tipo Identificación " + firma,
            "Id usuario " + firma,
            "Clave personal o CVE " + firma,
            "Tipo Token " + firma,
            "Semilla / Valor Estático / Celular " + firma
        );
    }

    // ========================================================================
    // OPERACIONES DE TRANSFERENCIAS INTERNACIONALES
    // ========================================================================

    public void Recibirdinerodelexterior(boolean soloGuardar) throws Exception {
        NotificacionSMS.TIPO_NOTIFICACION = NotificacionSMS.TIPO_NOTIF_PYMES_TRANS_RECIBIR;

        validarCamposRecibir();

        if (portalType == PortalType.PYME) {
            this.inicioCrearTx();
        }

        if (!pageRecibirTransferenciasInternacionales.switchToFrameDivisas()) {
            return;
        }

        String msg = pageRecibirTransferenciasInternacionales.seleccionarTransferencia("Recibir");
        if (msg != null && !msg.isEmpty()) {
            this.terminarIteracionXError(msg);
            return;
        }

        ejecutarFlujoRecibir(soloGuardar);
    }

    private void validarCamposRecibir() {
        String numCambiario1 = Util.left(getParam(SettingsRun.getTestData(), "Numeral cambiario 1"), 4);
        String numCambiario2 = Util.left(getParam(SettingsRun.getTestData(), "Numeral cambiario 2"), 4);

        StringBuilder mensaje = new StringBuilder("Los siguientes campos están vacíos: ");
        boolean hayErrores = false;

        if (this.numerodereferenciaExterna.isEmpty()) {
            mensaje.append("Numero de referencia Externa, ");
            hayErrores = true;
        }
        if (this.modena.isEmpty()) {
            mensaje.append("Tipo Moneda, ");
            hayErrores = true;
        }
        if (this.concepTx.isEmpty()) {
            mensaje.append("Concepto de la transferencia, ");
            hayErrores = true;
        }
        if (numCambiario1.isEmpty()) {
            mensaje.append("Numeral cambiario 1, ");
            hayErrores = true;
        }
        if (numCambiario2.isEmpty()) {
            mensaje.append("Numeral cambiario 2, ");
            hayErrores = true;
        }
        if (this.valorNumeral1.isEmpty()) {
            mensaje.append("Valor numeral cambiario 1, ");
            hayErrores = true;
        }
        if (this.valorNumeral2.isEmpty()) {
            mensaje.append("Valor numeral cambiario 2, ");
            hayErrores = true;
        }

        if (hayErrores) {
            String mensajeError = mensaje.substring(0, mensaje.length() - 2);
            reportarErrorYMarcarFalla(mensajeError);
        }
    }

    private void ejecutarFlujoRecibir(boolean soloGuardar) throws Exception {
        String numCambiario1 = Util.left(getParam(SettingsRun.getTestData(), "Numeral cambiario 1"), 4);
        String numCambiario2 = Util.left(getParam(SettingsRun.getTestData(), "Numeral cambiario 2"), 4);

        String msgError = pageRecibirTransferenciasInternacionales.TxInternacionalesOrigen(
            this.numerodereferenciaExterna, this.modena, this.concepTx,
            numCambiario1, numCambiario2, this.valorNumeral1, this.valorNumeral2
        );

        if (msgError != null) {
            this.terminarIteracionXError(msgError);
            return;
        }

        msgError = pageRecibirTransferenciasInternacionales.seleccionarCuenta(
            this.tipoIdEm, this.nitEmpre, this.referencia1, this.referencia2);
        if (msgError != null) {
            this.terminarIteracionXError(msgError);
            return;
        }

        msgError = pageRecibirTransferenciasInternacionales.Cotizacion();
        if (msgError != null) {
            this.terminarIteracionXError(msgError);
            return;
        }

        msgError = pageRecibirTransferenciasInternacionales.Confirmacion();
        if (msgError != null) {
            this.terminarIteracionXError(msgError);
            return;
        }

        this.accionConfirmarInternacional(soloGuardar);

        validarSaldosStratusRecibir();
        pageRecibirTransferenciasInternacionales.setTime(pageConf.getFechaHoraTx());
    }

    private void validarSaldosStratusRecibir() {
        if (!DatosDavivienda.IS_RISKMOTOR && DatosDavivienda.STRATUS != null) {
            this.pageRecibirTransferenciasInternacionales.validacionSaldosStratus(
                this.tipoIdEm, this.nitEmpre, this.referencia1, this.referencia2, false);
            
            guardarSaldosStratus(pageRecibirTransferenciasInternacionales);
        }
    }

    // ========================================================================
    // ENVIAR TRANSFERENCIAS INTERNACIONALES
    // ========================================================================

    public void EnviarTransferenciasInternacionales(boolean soloGuardar) throws Exception {
        NotificacionSMS.TIPO_NOTIFICACION = NotificacionSMS.TIPO_NOTIF_PYMES_TRANS_ENVIADAS;

        normalizarTipoCuenta();

        if (portalType == PortalType.PYME) {
            Util.wait(2);
        }
        
        this.inicioCrearTx();

        if (!pageEnviarTransInternacional.switchToFrameDivisas()) {
            return;
        }

        Util.wait(2);
        String msg = pageEnviarTransInternacional.seleccionarTransferencia("Enviar");
        if (msg != null && !msg.isEmpty()) {
            this.terminarIteracionXError(msg);
            return;
        }

        ejecutarFlujoEnviar(soloGuardar);
    }

    private void ejecutarFlujoEnviar(boolean soloGuardar) throws Exception {
        String msg = pageEnviarTransInternacional.closeActiveIntAlert();
        if (msg != null && !msg.isEmpty() && !msg.contains("Para enviar o recibir transferencias")) {
            this.terminarIteracionXError(msg);
            return;
        }

        msg = pageEnviarTransInternacional.seleccionarCuenta(
            this.servicio, this.tipoIdEm, this.nitEmpre, this.tipoCta, this.numCta);
        if (!msg.isEmpty()) {
            this.terminarIteracionXError(msg);
            return;
        }

        String numeral1 = Util.left(getParam(SettingsRun.getTestData(), "Numeral cambiario 1"), 4);
        String numeral2 = Util.left(getParam(SettingsRun.getTestData(), "Numeral cambiario 2"), 4);

        msg = pageEnviarTransInternacional.ingresarValores(
            this.tipoMoneda, this.valorcon, this.concepto,
            numeral1, numeral2, this.valorNumeral1, this.valorNumeral2, this.tipoEnvio
        );

        if (msg != null && !msg.isEmpty()) {
            this.terminarIteracionXError(msg);
            return;
        }

        procesarTipoEnvio(soloGuardar);
    }

    private void procesarTipoEnvio(boolean soloGuardar) throws Exception {
        String msg;
        
        if ("Nuevo Envio".equals(this.tipoEnvio)) {
            msg = procesarNuevoEnvio();
        } else if ("Envio Frecuente".equals(this.tipoEnvio)) {
            msg = procesarEnvioFrecuente();
        } else {
            return;
        }

        if (msg != null && !msg.isEmpty()) {
            this.terminarIteracionXError(msg);
            return;
        }

        finalizarEnvio(soloGuardar);
    }

    private String procesarNuevoEnvio() throws Exception {
        String msg = pageEnviarTransInternacional.ingresarBeneficiario(
            this.nombreBene, this.paisDestino, this.ciudadDestino, this.direccionBene,
            this.cuentaBene, this.infoPago, this.referenciaPago, this.tipoEnvio
        );

        if (msg != null && !msg.isEmpty()) {
            return msg;
        }

        return pageEnviarTransInternacional.datosDestino(
            this.tipoCodigo, this.numeroCodigo, this.intermediario,
            this.tipoCodigoInter, this.numeroCodigoInter
        );
    }

    private String procesarEnvioFrecuente() throws Exception {
        String msg = pageEnviarTransInternacional.SeleccionarBeneficiario(
            this.nombreBene, this.paisDestino, this.cuentaBene, this.FechaEnvioFrecuente
        );

        if (msg != null && !msg.isEmpty()) {
            return msg;
        }

        msg = pageEnviarTransInternacional.ValidarBeneficiario(
            this.nombreBene, this.paisDestino, this.ciudadDestino, this.direccionBene,
            this.cuentaBene, this.infoPago, this.referenciaPago
        );

        if (msg != null && !msg.isEmpty()) {
            return msg;
        }

        return pageEnviarTransInternacional.ValidaciondatosSelecDestino(
            this.tipoCodigo, this.numeroCodigo, this.intermediario,
            this.tipoCodigoInter, this.numeroCodigoInter
        );
    }

    private void finalizarEnvio(boolean soloGuardar) throws Exception {
        String msg = pageEnviarTransInternacional.cotizacion();
        if (msg != null && !msg.isEmpty()) {
            this.terminarIteracionXError(msg);
            return;
        }

        msg = pageEnviarTransInternacional.confirmacion(intermediario);
        if (msg != null && !msg.isEmpty()) {
            this.terminarIteracionXError(msg);
            return;
        }

        this.accionConfirmarInternacional(soloGuardar);
        validarSaldosStratusEnviar();
        pageDivisas.setTime(pageConf.getFechaHoraTx());
    }

    private void validarSaldosStratusEnviar() {
        if (!DatosDavivienda.IS_RISKMOTOR && DatosDavivienda.STRATUS != null) {
            String tipoProd = normalizarTipoProductoStratus(this.tipoCta);
            
            this.pageEnviarTransInternacional.validacionSaldosStratus(
                this.servicio, this.tipoIdEm, this.nitEmpre, tipoProd, this.numCta, false);
            
            guardarSaldosStratus(pageEnviarTransInternacional);
        }
    }

    private void guardarSaldosStratus(Object page) {
        String saldoIni, saldodis, saldoFin, saldoDispoFin;
        
        if (page instanceof PageRecibirTransferenciasInternacionales) {
            PageRecibirTransferenciasInternacionales pageRecibir = 
                (PageRecibirTransferenciasInternacionales) page;
            saldoIni = pageRecibir.getSaldoTotalInicialOrigen();
            saldodis = pageRecibir.getSaldoDispoInicialOrigen();
            saldoFin = pageRecibir.getSaldoTotalFinalOrigen();
            saldoDispoFin = pageRecibir.getSaldoTotalFinalOrigen();
        } else {
            PageEnviarTransInternacional pageEnviar = (PageEnviarTransInternacional) page;
            saldoIni = pageEnviar.getSaldoTotalInicialOrigen();
            saldodis = pageEnviar.getSaldoDispoInicialOrigen();
            saldoFin = pageEnviar.getSaldoTotalFinalOrigen();
            saldoDispoFin = pageEnviar.getSaldoTotalFinalOrigen();
        }

        this.pageConsultatxInternacional.setSaldoTotalInicial(saldoIni);
        this.pageConsultatxInternacional.setSaldoDisInicial(saldodis);
        this.pageConsultatxInternacional.setSaldoTotalFinal(saldoFin);
        this.pageConsultatxInternacional.setSaldoDisponibleFinal(saldoDispoFin);
    }

    private void normalizarTipoCuenta() {
        String tipoCuentaUpper = this.tipoCta.toUpperCase();
        
        if (tipoCuentaUpper.contains("AHORRO")) {
            this.tipoCta = "CUENTA AHORROS";
        } else if (tipoCuentaUpper.contains("CORRIENTE")) {
            this.tipoCta = "CUENTA CORRIENTE";
        }
    }

    private String normalizarTipoProductoStratus(String tipoCta) {
        String tipoCuentaUpper = tipoCta.toUpperCase();
        
        if (tipoCuentaUpper.contains("AHORROS")) {
            return "AHORROS";
        } else if (tipoCuentaUpper.contains("CORRIENTE")) {
            return "CORRIENTE";
        }
        return " ";
    }

    // ========================================================================
    // ENVIAR PENDIENTE APROBACIÓN
    // ========================================================================

    public void EnviarTransferenciasInternacionalesPendAprobacion() throws Exception {
        NotificacionSMS.TIPO_NOTIFICACION = NotificacionSMS.TIPO_NOTIF_PYMES_TRANS_ENVIADAS;

        normalizarTipoCuenta();

        if (portalType == PortalType.PYME) {
            this.inicioCrearTx();
        }

        Util.wait(5);

        String msg = pageEnviarTransInternacional.seleccionarTransferencia("Enviar");
        if (!msg.isEmpty()) {
            this.terminarIteracionXError(msg);
            return;
        }

        pageRecibirTransferenciasInternacionales.closeActiveIntAlert();

        msg = pageEnviarTransInternacional.seleccionarCuenta(
            this.servicio, this.tipoIdEm, this.nitEmpre, this.tipoCta, this.numCta);
        if (!msg.isEmpty()) {
            this.terminarIteracionXError(msg);
            return;
        }

        ejecutarFlujoPendienteAprobacion();
    }

    private void ejecutarFlujoPendienteAprobacion() throws Exception {
        String numeral1 = Util.left(getParam(SettingsRun.getTestData(), "Numeral cambiario 1"), 4);
        String numeral2 = Util.left(getParam(SettingsRun.getTestData(), "Numeral cambiario 2"), 4);

        String msg = pageEnviarTransInternacional.ingresarValores(
            this.tipoMoneda, this.valorcon, this.concepto,
            numeral1, numeral2, this.valorNumeral1, this.valorNumeral2, this.tipoEnvio
        );

        if (!msg.isEmpty()) {
            reportarErrorYMarcarFalla(msg);
            return;
        }

        pageEnviarTransInternacional.ingresarBeneficiario(
            this.nombreBene, this.paisDestino, this.ciudadDestino, this.direccionBene,
            this.cuentaBene, this.infoPago, this.referenciaPago, this.tipoEnvio
        );

        pageEnviarTransInternacional.datosDestino(
            this.tipoCodigo, this.numeroCodigo, this.intermediario,
            this.tipoCodigoInter, this.numeroCodigoInter
        );

        pageEnviarTransInternacional.cotizacion();
        pageEnviarTransInternacional.confirmacion(intermediario);

        this.accionGuardarSinAprobarInternacional();
        pageRecibirTransferenciasInternacionales.setTime(pageConf.getFechaHoraTx());
    }

    // ========================================================================
    // INICIO CREAR TRANSACCIÓN
    // ========================================================================

    public void inicioCrearTx() throws Exception {
        pageOrigenPyme = new PageOrigen1(loginFrontPyme);
        String pagoyTx = this.pageOrigenPyme.getTextMid();

        String msgError = navegarACrearTransaccion(pagoyTx);
        if (msgError != null) {
            this.terminarIteracionXError(msgError);
            return;
        }

        msgError = this.pageOrigenPyme.irAServicio("Transferencias Internacionales");
        if (msgError != null) {
            this.terminarIteracionXError(msgError);
            return;
        }

        this.riesgo = this.prioridaRiesgo;
    }

    private String navegarACrearTransaccion(String pagoyTx) throws Exception {
        String menuPrincipal = determinarMenuPrincipal(pagoyTx);
        
        if (this.navegador.contains("CHROME")) {
            return this.pageOrigenPyme.irAOpcion(
                "Crear Transacción", menuPrincipal, "Crear Transacción");
        } else {
            return this.pageOrigenPyme.irAOpcionMoZilla(
                "Crear Transacción", menuPrincipal, "Crear Transacción", null, null);
        }
    }

    private String determinarMenuPrincipal(String pagoyTx) {
        String pagoyTxLower = pagoyTx.toLowerCase();
        
        if (pagoyTxLower.contains("pagos, transferencias y otros")) {
            return "Pagos, Transferencias y otros";
        } else if (pagoyTxLower.contains("pagos, transferencias e inscripciones")) {
            return "Pagos, Transferencias e Inscripciones";
        } else {
            return "Pagos y Transferencias";
        }
    }

    // ========================================================================
    // ACCIONES DE CONFIRMACIÓN Y GUARDADO
    // ========================================================================

    private void accionGuardarSinAprobarInternacional() throws Exception {
        String msgRta = pageConf.guardarSinAprobarInternacional();
        if (msgRta != null) {
            this.terminarIteracionXError(msgRta);
        }
    }

    private void accionConfirmarInternacional(boolean soloGuardar) throws Exception {
        this.estadoTx = null;

        if (!this.servicio.contains("Recibir") && DatosDavivienda.IS_RISKMOTOR) {
            capturarDatosMotorRiesgo();
        }

        if (soloGuardar) {
            ejecutarGuardarSinAprobar();
        } else {
            ejecutarAprobarTransaccion();
        }

        procesarResultadoTransaccion();
    }

    private void capturarDatosMotorRiesgo() {
        this.valorTx = pageConf.getValorFinalTx();
        if (this.valorTx != null) {
            SetActivityAmount(this.valorTx.replace("$", "").replace(" ", ""));
        }

        this.bancoDesTx = pageConf.getBancoDesTx();
        if (this.bancoDesTx != null) {
            SetBancoDesTx(this.bancoDesTx);
        }
    }

    private void ejecutarGuardarSinAprobar() throws Exception {
        String msgRta = pageConf.guardarSinAprobarInternacional();
        pageRecibirTransferenciasInternacionales.setTime(pageConf.getFechaHoraTx());

        if (msgRta != null && !msgRta.contains("guardada")) {
            this.terminarIteracionXError(msgRta);
        }
    }

    private void ejecutarAprobarTransaccion() throws Exception {
        int numRetosFalla = 0;
        if (DatosDavivienda.IS_RISKMOTOR) {
            numRetosFalla = Integer.valueOf(getParam(SettingsRun.getTestData(), "Ingresos Fallidos"));
        }

        String msgRta = pageConf.aprobarTx(numRetosFalla, true);

        procesarRespuestaAprobacion(msgRta);
    }

    private void procesarRespuestaAprobacion(String msgRta) throws Exception {
        if (esTransferenciaInternacional()) {
            msgRta = procesarMensajeInternacional(msgRta);
        }

        if (DatosDavivienda.IS_RISKMOTOR) {
            procesarEstadoMotorRiesgo(msgRta);
        }

        validarMensajeAprobacion(msgRta);
    }

    private boolean esTransferenciaInternacional() {
        return this.servicio.contains("Tx Internacionales Enviar al exterior") ||
               this.servicio.contains("Tx Internacionales Enviar al exterior Pendiente Aprobación") ||
               this.servicio.contains("Tx Internacionales Recibir desde el exterior");
    }

    private String procesarMensajeInternacional(String msgRta) throws Exception {
        if (msgRta != null && (!msgRta.contains("Transacción recibida") &&
            !msgRta.contains("No se habilito el campo del código de confirmación") &&
            !msgRta.contains("no podemos atender su solicitud"))) {
            
            msgRta = pageConf.closeActiveIntAlert();
        } else if (msgRta == null) {
            this.numeroTx = pageConf.getNumeroDocumentoInterna();
            if (this.numeroTx == null) {
                msgRta = pageConf.closeActiveIntAlert();
                pageRecibirTransferenciasInternacionales.setTime(pageConf.getFechaHoraTx());
            }
        }
        return msgRta;
    }

    private void procesarEstadoMotorRiesgo(String msgRta) throws Exception {
        this.estadoTx = msgRta;
        this.SetEstado(msgRta);

        if (msgRta != null && Util.itemContainsAnyArrayItem(msgRta, ARR_MSG_BUSCAR_ESTADO)) {
            this.estadoTx = "Transferencia Realizada";
        } else if (msgRta != null && Util.itemContainsAnyArrayItem(msgRta, ARR_MSG_TX_DECLINADA)) {
            procesarTransaccionDeclinada(msgRta);
        }
    }

    private void procesarTransaccionDeclinada(String msgRta) throws Exception {
        this.estadoTx = "DECLINADA";
        this.riesgo = this.prioridaRiesgo;
        
        if ("ALTO".equals(this.riesgo)) {
            this.numeroTx = pageConf.getNumeroDocumentoInterna();
        }
        
        this.terminarIteracionXError(msgRta);
    }

    private void validarMensajeAprobacion(String msgRta) throws Exception {
        if (msgRta == null) {
            return;
        }

        String[] mensajesValidos = {
            PageConfirmacion1.MSG_EXITO_GUARD,
            PageConfirmacion1.MSG_EXITO_PAGO,
            PageConfirmacion1.MSG_EXITO_APROB_INTER,
            PageConfirmacion1.MSG_EXITO_APROB_INTER2,
            PageConfirmacion1.MSG_EXITO_APROB_INTER3,
            PageConfirmacion1.MSG_EXITO_DOC_Y_FOR_INTER,
            PageConfirmacion1.MSG_EXITO_DOC_Y_FOR_COMPLETE_INF_INTER
        };

        boolean mensajeValido = false;
        for (String mensajeValidoItem : mensajesValidos) {
            if (msgRta.contains(mensajeValidoItem)) {
                mensajeValido = true;
                break;
            }
        }

        if (!mensajeValido) {
            this.terminarIteracionXError(msgRta);
        }
    }

    private void procesarResultadoTransaccion() throws Exception {
        String msgRta = pageConf.closeActiveIntAlert();

        if (msgRta != null && !msgRta.contains("recibida") && TP_EN_LINEA.equals(this.tipoPrueba)) {
            procesarDocumentosYFormularios(msgRta);
        } else {
            procesarNumeroDocumento();
        }
    }

    private void procesarDocumentosYFormularios(String msgRta) throws Exception {
        if (msgRta.contains(PageConfirmacion1.MSG_EXITO_DOC_Y_FOR_COMPLETE_INF_INTER)) {
            irAModuloDocumentosYFormularios();
        } else {
            ejecutarModuloDocumentosYFormularios();
        }

        String msg = completarDocumentosYFormularios();
        if (msg != null && !msg.isEmpty()) {
            this.terminarIteracionXError(msg);
        }
    }

    private void irAModuloDocumentosYFormularios() throws Exception {
        validarFechaHora();
        
        String msg = this.pageDocumentos_Y_Formularios.IralModuloDocumetosYFormularios(
            this.tipoPrueba, this.servicio, this.fecha, this.hora, this.moneda);
        
        if (msg != null && !msg.isEmpty()) {
            this.terminarIteracionXError(msg);
        }
    }

    private void ejecutarModuloDocumentosYFormularios() throws Exception {
        validarFechaHora();
        
        String msg = this.pageDocumentos_Y_Formularios.ModuloDocumetosYFormularios(
            this.tipoPrueba, this.servicio, this.fecha, this.hora, this.moneda);
        
        if (msg != null && 
            !msg.contains("En este módulo puede visualizar las operaciones") &&
            !msg.contains("Los campos que no se presentan en la declaración de cambio serán autocompletados")) {
            this.terminarIteracionXError(msg);
        }
    }

    private void validarFechaHora() {
        if (this.fecha == null || this.fecha.trim().isEmpty() ||
            this.hora == null || this.hora.trim().isEmpty()) {
            this.fecha = getParam(SettingsRun.getTestData(), "Fecha tx");
            this.hora = getParam(SettingsRun.getTestData(), "Hora tx");
        }
    }

    private String completarDocumentosYFormularios() throws Exception {
        cargarDatosDocumentosYFormularios();
        completarEmpresaReceptoraEInversionista();
        
        return this.pageDocumentos_Y_Formularios.DatosDocumetosYFormularios(
            obtenerParametrosDocumentosYFormularios()
        );
    }

    private void cargarDatosDocumentosYFormularios() {
        // Este método centraliza la carga de todos los parámetros necesarios
        // para documentos y formularios
    }

    private void completarEmpresaReceptoraEInversionista() throws Exception {
        DataDriven td = SettingsRun.getTestData();
        
        // Empresa Receptora
        this.pageDocumentos_Y_Formularios.EmpresaReceptora(
            getParam(td, "Empresa receptora - Tipo de identificación"),
            getParam(td, "Empresa receptora - Número de identificación"),
            getParam(td, "Empresa receptora - Dígito de verificación"),
            getParam(td, "Empresa receptora - Nombre o razón social"),
            getParam(td, "Empresa receptora - Código país"),
            getParam(td, "Empresa receptora - Código departamento"),
            getParam(td, "Empresa receptora - Código ciudad"),
            getParam(td, "Empresa receptora - Código CIIU"),
            getParam(td, "Empresa receptora - Teléfono"),
            getParam(td, "Empresa receptora - Dirección"),
            getParam(td, "Empresa receptora - Correo electrónico"),
            getParam(td, "Empresa receptora - Sector"),
            getParam(td, "Empresa receptora - Tipo de empresa"),
            getParam(td, "Empresa receptora - Superintendencia de vigilancia"),
            getParam(td, "Empresa receptora - Actividad"),
            getParam(td, "Empresa receptora - Tipo de régimen"),
            getParam(td, "Empresa receptora  - Naturaleza")
        );

        // Inversionista
        String telefonoInversionista = td.parameterExist("Identificación del inversionista - Teléfono") ?
            getParam(td, "Identificación del inversionista - Teléfono") : "";
        String direccionInversionista = td.parameterExist("Identificación del inversionista - Dirección") ?
            getParam(td, "Identificación del inversionista - Dirección") : "";

        this.pageDocumentos_Y_Formularios.Inversionista(
            getParam(td, "Identificación del inversionista - Tipo de identificación"),
            getParam(td, "Identificación del inversionista - Número de identificación"),
            getParam(td, "Identificación del inversionista - Dígito de verificación"),
            getParam(td, "Identificación del inversionista - Nombre o razón social"),
            getParam(td, "Identificación del inversionista - Código país"),
            getParam(td, "Identificación del inversionista - Código departamento"),
            getParam(td, "Identificación del inversionista - Código ciudad"),
            getParam(td, "Identificación del inversionista - Código CIIU"),
            getParam(td, "Identificación del inversionista - Correo electrónico"),
            getParam(td, "Identificación del inversionista - Sector"),
            getParam(td, "Identificación del inversionista - Tipo de empresa"),
            getParam(td, "Identificación del inversionista - Superintendencia de vigilancia"),
            getParam(td, "Identificación del inversionista - Naturaleza"),
            telefonoInversionista,
            direccionInversionista
        );
    }

    private Object[] obtenerParametrosDocumentosYFormularios() {
        DataDriven td = SettingsRun.getTestData();
        
        String numCambiario1 = Util.left(getParam(td, "Numeral cambiario 1"), 4);
        String numCambiario2 = Util.left(getParam(td, "Numeral cambiario 2"), 4);
        
        String cargueDocu = getParam(td, "Cargue Archivo Documentos");
        String[] rutaArch = cargueDocu.split(",");

        return new Object[] {
            this.concepTx,
            getParam(td, "Tipo de operación"),
            getParam(td, "Destino de la inversión"),
            getParam(td, "Opción de inversión"),
            this.valorsin,
            numCambiario1,
            this.valorNumeral1,
            numCambiario2,
            this.valorNumeral2,
            getParam(td, "Deducciones"),
            getParam(td, "Cambiar Concepto de la transferencia"),
            getParam(td, "Concepto de la transferencia A Cambiar"),
            getParam(td, "Número de depósito 1"),
            getParam(td, "Número de declaración 1"),
            getParam(td, "Cambiar Numeral cambiario 1"),
            getParam(td, "Numeral cambiario A Cambiar 1"),
            getParam(td, "Cambiar Datos Descripción de la operación"),
            getParam(td, "Número del préstamo o aval"),
            getParam(td, "Nombre del acreedor o el deudor o avalista"),
            getParam(td, "Nombre del deudor o acreedor / Avalado o beneficiario residente"),
            getParam(td, "Tipo de identificación del deudor"),
            getParam(td, "Número de identificación del deudor"),
            getParam(td, "Dígito de verificación"),
            getParam(td, "Moneda estipulada"),
            getParam(td, "Valor moneda estipulada"),
            getParam(td, "Tasa de cambio moneda"),
            getParam(td, "Cambiar Valor numeral cambiario 1"),
            getParam(td, "Valor numeral cambiario A Cambiar 1"),
            getParam(td, "Validar Numerales"),
            getParam(td, "Validacion - DIAN"),
            rutaArch
        };
    }

    private void procesarNumeroDocumento() throws Exception {
        if (this.numeroTx == null) {
            this.numeroTx = pageConf.getNumeroDocumentoInterna();
        }
        
        if (this.numeroTx == null) {
            this.terminarIteracionXError("No se encontró el Número de Documento de la transacción");
            return;
        }

        SettingsRun.getTestData().setParameter("Número Aprobación", this.numeroTx);
        this.pageConsultatxInternacional.SetNumAprInterna(this.numeroTx);
    }

    // ========================================================================
    // APROBAR TRANSACCIÓN PENDIENTE
    // ========================================================================

    public String aprobarTxPendienteIntern(boolean desdeDetalle) throws Exception {
        validarFechaHora();

        this.pageAprobInter.inicioAprobaciones(
            this.tipoPrueba, this.servicio, this.fecha, this.hora, this.moneda);

        int numRetosFalla = 0;
        if (DatosDavivienda.IS_RISKMOTOR) {
            numRetosFalla = Integer.valueOf(getParam(SettingsRun.getTestData(), "Ingresos Fallidos"));
        }

        String msgRta = pageConf.aprobarTx(numRetosFalla, desdeDetalle);

        validarRespuestaAprobacionPendiente(msgRta);
        procesarEstadoAprobacion(msgRta);

        return procesarPostAprobacion(msgRta);
    }

    private void validarRespuestaAprobacionPendiente(String msgRta) throws Exception {
        if (msgRta == null) {
            return;
        }

        String[] mensajesValidos = {
            PageConfirmacion1.MSG_EXITO_GUARD,
            PageConfirmacion1.MSG_EXITO_PAGO,
            PageConfirmacion1.MSG_EXITO_ENV_OTP,
            PageConfirmacion1.MSG_EXITO_APROB,
            PageConfirmacion1.MSG_EXITO_APROB_INTER,
            PageConfirmacion1.MSG_EXITO_APROB_INTER2,
            PageConfirmacion1.MSG_EXITO_APROB_INTER3,
            PageConfirmacion1.MSG_EXITO_DOCYFOR
        };

        boolean mensajeValido = false;
        for (String mensajeValidoItem : mensajesValidos) {
            if (msgRta.contains(mensajeValidoItem)) {
                mensajeValido = true;
                break;
            }
        }

        if (!mensajeValido) {
            this.terminarIteracionXError(msgRta);
        }
    }

    private void procesarEstadoAprobacion(String msgRta) {
        if (!DatosDavivienda.IS_RISKMOTOR) {
            return;
        }

        this.estadoTx = msgRta;
        this.SetEstado(msgRta);

        if (msgRta != null && Util.itemContainsAnyArrayItem(msgRta, ARR_MSG_BUSCAR_ESTADO)) {
            this.estadoTx = "Transferencia Realizada";
        } else if (msgRta != null && Util.itemContainsAnyArrayItem(msgRta, ARR_MSG_TX_DECLINADA)) {
            this.estadoTx = "DECLINADA";
        }
    }

    private String procesarPostAprobacion(String msgRta) throws Exception {
        if (msgRta != null && msgRta.contains(PageConfirmacion1.MSG_EXITO_DOCYFOR)) {
            return procesarDocumentosYFormulariosAprobacion(msgRta);
        } else {
            return procesarAprobacionExitosa(msgRta);
        }
    }

    private String procesarDocumentosYFormulariosAprobacion(String msgRta) throws Exception {
        String msg = this.pageDocumentos_Y_Formularios.closeActiveIntAlert();

        if (msgRta.contains(PageConfirmacion1.MSG_EXITO_DOCYFOR)) {
            Reporter.reportEvent(Reporter.MIC_INFO,
                "Tiene al menos una operación que requiere adjuntar documentos.");
        }

        msg = this.pageDocumentos_Y_Formularios.ModuloDocumetosYFormularios(
            this.tipoPrueba, this.servicio, this.fecha, this.hora, this.moneda);

        if (msg != null && 
            !msg.contains("En este módulo puede visualizar las operaciones") &&
            !msg.contains("Los campos que no se presentan en la declaración de cambio serán autocompletados")) {
            this.terminarIteracionXError(msg);
        }

        completarEmpresaReceptoraEInversionista();
        
        msg = this.pageDocumentos_Y_Formularios.DatosDocumetosYFormularios(
            obtenerParametrosDocumentosYFormularios());

        if (msg != null) {
            if (msg.contains("Para continuar debe completar la información solicitada")) {
                msg = "Para continuar debe completar la información solicitada";
            }
            this.terminarIteracionXError(msg);
        }

        return msgRta;
    }

    private String procesarAprobacionExitosa(String msgRta) throws Exception {
        if (!msgRta.contains(PageConfirmacion1.MSG_EXITO_APROB_INTER3)) {
            this.numeroTx = pageConf.getNumeroDocumentoInterna();

            if (this.numeroTx == null || this.numeroTx.isEmpty()) {
                this.terminarIteracionXError("No se encontró el Número de Documento de la transacción");
            }

            SettingsRun.getTestData().setParameter("Número Aprobación", this.numeroTx);
            this.pageDivisas.SetNumAprInterna(this.numeroTx);
            this.pageConsultatxInternacional.SetNumAprInterna(this.numeroTx);

            msgRta = this.pageConsultatxInternacional.closeActiveIntAlert();
        } else {
            pageDivisas.closeActiveIntAlert();
        }

        return msgRta;
    }

    // ========================================================================
    // MÉTODO PRINCIPAL TRANSAR
    // ========================================================================

    public String transar() throws Exception {
        boolean primeroGuardar = TP_PEND_APR.equals(this.tipoPrueba);

        switch (this.servicio) {
            case "Tx Internacionales Recibir desde el exterior":
                this.Recibirdinerodelexterior(primeroGuardar);
                break;

            case "Tx Internacionales Enviar al exterior":
                this.EnviarTransferenciasInternacionales(primeroGuardar);
                break;

            case "Tx Internacionales Enviar al exterior Pendiente Aprobación":
                if (portalType == PortalType.PYME) {
                    this.inicioCrearTx();
                }
                this.EnviarTransferenciasInternacionalesPendAprobacion();
                break;

            case "Divisas Documentos y Formularios":
                ejecutarDivisasDocumentosYFormularios();
                break;

            case "Consulta Tx Internacionales Validar Estado":
                ejecutarConsultaValidarEstado();
                break;

            default:
                this.terminarIteracionXError("Servicio no soportado en flujo Divisas: " + this.servicio);
                throw new UnsupportedOperationException("Servicio no soportado: " + this.servicio);
        }

        return procesarAprobacionesMultiples(primeroGuardar);
    }

    // ========================================================================
    // DOCUMENTOS Y FORMULARIOS
    // ========================================================================

    private void ejecutarDivisasDocumentosYFormularios() throws Exception {
        if (portalType == PortalType.PYME) {
            this.inicioCrearTx();
        }

        this.pageDocumentos_Y_Formularios = new PageDocumentos_Y_Formularios(this.pageDivisas);

        if (!this.pageDivisas.switchToFrameDivisas()) {
            return;
        }

        String msg = this.pageDocumentos_Y_Formularios.IralModuloDocumetosYFormularios(
            this.tipoPrueba, this.servicio, this.fechaTx, this.horaTx, this.tipoMoneda);

        if (msg != null && !msg.isEmpty()) {
            reportarErrorYMarcarFalla(msg);
            this.terminarIteracionXError(msg);
            return;
        }

        completarEmpresaReceptoraEInversionista();

        msg = this.pageDocumentos_Y_Formularios.DatosDocumetosYFormularios(
            obtenerParametrosDocumentosYFormularios());

        validarResultadoDocumentosYFormularios(msg);
    }

    private void validarResultadoDocumentosYFormularios(String msg) throws Exception {
        if (msg == null) {
            return;
        }

        if (!msg.contains("Documentos enviados exitosamente. Davivienda validará la información recibida y en caso de presentar inconsistencias informará vía correo electrónico. Por favor haga seguimiento de su operación en la opción de consultas y verifique el estado de su trámite.")) {
            this.terminarIteracionXError(msg);
        }
    }

    // ========================================================================
    // CONSULTA VALIDAR ESTADO
    // ========================================================================

    private void ejecutarConsultaValidarEstado() throws Exception {
        if (portalType == PortalType.PYME) {
            this.inicioCrearTx();
        }

        pageDivisas.numAprova = getParam(SettingsRun.getTestData(), "Número Aprobación");

        String msg = this.pageConsultatxInternacional.ConsultaNumtx(
            this.tipoPrueba, this.nombreEmpre, this.servicio,
            tipoConstaTxRealizadas, this.ordenanteBeneficiario,
            this.tipoTranferencia, this.estado, this.tipoMoneda,
            this.fechaTx, this.horaTx, this.fechaDesde, this.fechaHasta, this.valorsin
        );

        if (msg != null) {
            this.terminarIteracionXError(msg);
        }
    }

    // ========================================================================
    // PROCESAMIENTO DE APROBACIONES MÚLTIPLES
    // ========================================================================

    private String procesarAprobacionesMultiples(boolean primeroGuardar) throws Exception {
        inicializarEstadoSiEsNulo();

        if (this.estado.contains("Pendiente de Aprobación")) {
            if (primeroGuardar) {
                this.aprobarTxPendienteIntern(true);
            }
        } else {
            procesarAprobacionPendiente(primeroGuardar);
        }

        return ejecutarFlujoPorNumeroFirmas(primeroGuardar);
    }

    private void inicializarEstadoSiEsNulo() {
        if (this.estado == null) {
            this.estado = "Todas";
        }
    }

    private void procesarAprobacionPendiente(boolean primeroGuardar) throws Exception {
        boolean requiereAprobacion = primeroGuardar && 
                                      this.servicio.contains("Internacionales") && 
                                      !this.servicio.contains("Aprobación");
        
        boolean requiereAprobacionMotorRiesgo = primeroGuardar && 
                                                 this.servicio.contains("Internacionales") && 
                                                 DatosDavivienda.IS_RISKMOTOR;

        if (requiereAprobacion || requiereAprobacionMotorRiesgo) {
            this.aprobarTxPendienteIntern(true);
        }
    }

    private String ejecutarFlujoPorNumeroFirmas(boolean primeroGuardar) throws Exception {
        this.numAprobaciones = getParam(SettingsRun.getTestData(), "Números de Aprobaciones");

        boolean unaFirma = CN_APRO_PEND.equals(this.numAprobaciones);
        int numfirm = Integer.parseInt(this.numAprobaciones);

        if (!unaFirma) {
            return procesarMultiplesFirmas(numfirm, primeroGuardar);
        } else {
            return procesarUnicaFirma(primeroGuardar);
        }
    }

    private String procesarMultiplesFirmas(int numfirm, boolean primeroGuardar) throws Exception {
        this.cerrarSesionDependiemdoPortal();
        String msg = null;

        for (int contador = 2; contador <= numfirm; contador++) {
            loginPorFirmas(contador);

            if (this.servicio.contains("Internacionales")) {
                Util.wait(5);
                this.aprobarTxPendienteIntern(primeroGuardar);

                if (contador == numfirm) {
                    msg = ejecutarConsultaFinal();
                }
            }

            this.cerrarSesionDependiemdoPortal();
        }

        return msg;
    }

    private String procesarUnicaFirma(boolean primeroGuardar) throws Exception {
        if (!debeEjecutarConsulta()) {
            return null;
        }

        this.pageConsultatxInternacional = new PageConsultatxInternacional(this.pageDivisas);
        validarFechaHora();

        this.estado = getParam(SettingsRun.getTestData(), "Estado");

        String msg = this.pageConsultatxInternacional.ConsultaNumtx(
            this.tipoPrueba, this.nombreEmpre, this.servicio,
            tipoConstaTxRealizadas, this.ordenanteBeneficiario,
            this.tipoTranferencia, this.estado, this.tipoMoneda,
            this.fechaTx, this.horaTx, this.fechaDesde, this.fechaHasta, this.valorsin
        );

        if (msg != null) {
            this.terminarIteracionXError(msg);
        }

        if (DatosDavivienda.STRATUS != null) {
            this.pageConsultatxInternacional.ValidacionesStratusConsulta();
        }

        this.pageConsultatxInternacional.getDriver().switchTo().defaultContent();

        return msg;
    }

    private boolean debeEjecutarConsulta() {
        boolean esInternacionalODivisas = 
            (this.servicio.contains("Internacionales") || this.servicio.contains("Divisas"));
        
        boolean noEsAprobacionNiValidar = 
            !this.servicio.contains("Aprobación") && !this.servicio.contains("Validar");

        return esInternacionalODivisas && noEsAprobacionNiValidar;
    }

    private String ejecutarConsultaFinal() throws Exception {
        this.pageConsultatxInternacional = new PageConsultatxInternacional(this.pageDivisas);
        validarFechaHora();

        this.estado = getParam(SettingsRun.getTestData(), "Estado");

        String msg = this.pageConsultatxInternacional.ConsultaNumtx(
            this.tipoPrueba, this.nombreEmpre, this.servicio,
            tipoConstaTxRealizadas, this.ordenanteBeneficiario,
            this.tipoTranferencia, this.estado, this.tipoMoneda,
            this.fechaTx, this.horaTx, this.fechaDesde, this.fechaHasta, this.valorsin
        );

        this.pageConsultatxInternacional.getDriver().switchTo().defaultContent();
        return msg;
    }

    // ========================================================================
    // CIERRE DE SESIÓN
    // ========================================================================

    public void cerrarSesionDependiemdoPortal() throws Exception {
        if (portalType == PortalType.PYME) {
            cerrarSesionPyme();
        } else {
            cerrarSesionEmpresarial();
        }
    }

    private void cerrarSesionPyme() {
        if (loginFrontPyme != null) {
            loginFrontPyme.closeSession();
            Util.cleanBrowserDrivers();
        }
    }

    private void cerrarSesionEmpresarial() {
        if (frontEmpresarial != null) {
            frontEmpresarial.cerrarSesionFrontEmpresarial();
            CommonFrontEmpresarial.ESTA_LOGUEADO = false;
            frontEmpresarial.closeAllBrowsers();
            frontEmpresarial = null;
            Util.cleanBrowserDrivers();
        }
    }

    // ========================================================================
    // MANEJO DE ERRORES
    // ========================================================================

    private void terminarIteracionXError(String msgError) throws Exception {
        if (msgError == null) {
            msgError = "Error_1";
        }
        
        Reporter.write(msgError);
        guardarEvidenciaError(msgError);

        if (DatosDavivienda.IS_RISKMOTOR) {
            Reporter.reportEvent(Reporter.MIC_FAIL, "No se adiciona a MR >>> " + msgError);
            marcarFalla();
            Reporter.write("No se adiciona a MR >>> " + msgError);
        } else {
            reportarErrorYMarcarFalla(msgError);
        }

        finalizarIteracion();
    }

    private void guardarEvidenciaError(String msgError) {
        String evidenceName = msgError.replace(" ", "")
                                      .replaceAll("[\\\\/:*?\"<>|¡!\\.]", "")
                                      .replaceAll("\\s+", "_");

        if (frontEmpresarial != null) {
            Evidence.save(evidenceName, frontEmpresarial);
        } else if (loginFrontPyme != null) {
            Evidence.save(evidenceName, loginFrontPyme);
        }
    }

    private void finalizarIteracion() throws Exception {
        if (frontEmpresarial != null) {
            cerrarSesionDependiemdoPortal();
            SettingsRun.exitTestIteration();
        } else if (loginFrontPyme != null) {
            loginFrontPyme.terminarIteracion();
        } else {
            SettingsRun.exitTestIteration();
        }
    }

    private void reportarErrorYMarcarFalla(String mensaje) {
        Reporter.reportEvent(Reporter.MIC_FAIL, mensaje);
        marcarFalla();
    }

    private void marcarFalla() {
        SettingsRun.getTestData().setParameter(PARAM_SIGUIENTE_BLOQUE, VALOR_FALLA);
    }

    // ========================================================================
    // UTILIDADES Y HELPERS
    // ========================================================================

    public String getTransaccion(String tipoPrueba, String servicio) throws Exception {
        String transaccion = tipoPrueba;

        if (TP_PEND_APR.equals(tipoPrueba)) {
            if (TP_PEND_APR.equals(this.tipoPrueba)) {
                transaccion = MotorRiesgo.TX_EMP_APROB_TX;
            }

            if (TP_PEND_APR.equals(this.tipoPrueba)) {
                tipoPrueba = TP_EN_LINEA;
            }

            if ("Retiro sin Tarjeta".equals(servicio)) {
                transaccion = MotorRiesgo.TX_PYM_APROB_RET;
            }
        }

        if (TP_EN_LINEA.equals(tipoPrueba)) {
            transaccion = determinarTransaccionPorServicio(servicio);
        }

        return transaccion;
    }

    private String determinarTransaccionPorServicio(String servicio) {
        switch (servicio) {
            case "Nómina":
            case "Pago de Nóminas":
                return MotorRiesgo.TX_EMP_PAGO_NOMI;
            case "Pago a Proveedores":
            case "Proveedores":
                return MotorRiesgo.TX_EMP_PAGO_PROV;
            case "Pago de Servicios":
            case "Servicios":
                return MotorRiesgo.TX_EMP_PAGO_SERVIC;
            case "Transferencia NIT Propio":
            case "Mismo NIT":
                return MotorRiesgo.TX_EMP_TF_MISMONIT;
            case "Transferencias Cuenta Inscrita":
            case "Cuenta Inscrita":
                return MotorRiesgo.TX_EMP_TF_TERCEROS;
            case "Transferencias Cuenta No Inscrita":
            case "Cuenta No Inscrita":
                return MotorRiesgo.TX_EMP_TF_CTANO;
            case "Tx Internacionales Enviar al exterior":
                return MotorRiesgo.TX_PYM_ENVIAR_AL_EXTERIOR;
            case "Tx Internacionales Recibir desde el exterior":
                return MotorRiesgo.TX_PYM_RECIBIR_DESDE_EL_EXTERIOR;
            default:
                return servicio;
        }
    }

    public String TipoProd(String tipoProdUpper) {
        String tipoProd = "No Aplica";
        String tipoProdLower = tipoProdUpper.toLowerCase();

        if (tipoProdLower.contains("ahorro")) {
            tipoProd = "Cuenta Ahorros";
        } else if (tipoProdLower.contains("corriente")) {
            tipoProd = "Cuenta Corriente";
        } else if (tipoProdLower.contains("crédito") || tipoProdLower.contains("credito")) {
            tipoProd = "Tarjeta Crédito";
        }

        return tipoProd;
    }

    // ========================================================================
    // STRATUS
    // ========================================================================

    public void LoginStratus() throws Exception {
        String strusu = SettingsRun.getGlobalData("data.usuarioStratus");
        String strpass = SettingsRun.getGlobalData("data.claveStratus");

        if (DatosDavivienda.STRATUS == null) {
            DatosDavivienda.STRATUS = new StratusProductos(strusu, strpass);
            Reporter.writeErr("Se cargan datos para logueo de Stratus");
        }
        
        Reporter.reportEvent(Reporter.MIC_INFO, "Se cargan datos para logueo de Stratus");
    }

    // ========================================================================
    // CLIENTE 360
    // ========================================================================

    public PageInicioC360 logueoC360() throws Exception {
        Reporter.write("*** Validar CLIENTE 360 ***");
        
        this.pageLoginC360 = new PageLogin(BasePageWeb.CHROME);
        this.pageInicioC360 = new PageInicioC360(pageLoginC360);
        this.pageEmpresasC360 = new PageEmpresas(pageLoginC360);
        
        this.pageLoginC360.login360(
            SettingsRun.getGlobalData("data.c360User"),
            SettingsRun.getGlobalData("data.c360Pwd")
        );
        
        return this.pageInicioC360;
    }

    public void ValidarCCIU(String numeroIDEmpresa) throws Exception {
        this.pageInicioC360.irAModulo(PageInicioC360.MOD_PAGINA_INICIAL);

        String reportMsg = this.pageEmpresasC360.buscarEmpresaC360(numeroIDEmpresa);

        if (!reportMsg.isEmpty() && 
            !reportMsg.contains("El cliente no ha actualizado") && 
            !reportMsg.contains("ACTUALIZADO")) {
            this.pageInicioC360.terminarIteracion(Reporter.MIC_NOEXEC, "[ERROR DATA] " + reportMsg);
            return;
        }

        Reporter.reportEvent(Reporter.MIC_PASS,
            "Se ha encontrado la empresa con el número de identificación [" + numeroIDEmpresa + "]");

        this.pageInicioC360.guardar();
        this.pageInicioC360.existDialog();
        
        Util.wait(2);

        String msgPopup = procesarDialogoC360();

        if (msgPopup == null) {
            this.pageInicioC360.cerrarSesion();
            this.pageInicioC360 = null;
        }
    }

    private String procesarDialogoC360() {
        if (!this.pageInicioC360.existDialog()) {
            return null;
        }

        String msgPopup = this.pageInicioC360.getMessageDialog();
        this.pageInicioC360.acceptDialog();

        if (msgPopup != null && !msgPopup.isEmpty() && 
            msgPopup.contains("Dígito de verificación no válido")) {
            
            Reporter.reportEvent(Reporter.MIC_INFO,
                "No se relizo la actualizacion de los datos en cliente 360: " + msgPopup);
            this.pageInicioC360.closeAllBrowsers();
            this.pageInicioC360 = null;
        }

        return msgPopup;
    }

    // ========================================================================
    // MÉTODOS DE MOTOR DE RIESGO
    // ========================================================================

    public void SetPrioridaMr(String riesgo) {
        this.prioridaRiesgo = riesgo;
    }

    public void SetuserAgent(String user) {
        this.userAgent = user;
    }

    public void SetActivityAmount(String activityAmountx) {
        this.activityAmount = activityAmountx;
    }

    public void SetBancoDesTx(String bancoDes) {
        this.bancoDesMotor = bancoDes;
    }

    public void SetEstado(String estado) {
        this.estado = estado;
    }

    public String[] getCuentasMotor() {
        return cuentasDesMotor;
    }

    // ========================================================================
    // DESTRUCTOR
    // ========================================================================

    public void destroy() {
        if (loginFrontPyme != null) {
            try {
                loginFrontPyme.closeAllBrowsers();
            } catch (Exception e) {
                System.err.println("Error cerrando navegador Pyme: " + e.getMessage());
            }
        }

        if (frontEmpresarial != null) {
            try {
                frontEmpresarial.closeAllBrowsers();
            } catch (Exception e) {
                System.err.println("Error cerrando navegador Empresarial: " + e.getMessage());
            }
        }

        if (middleEmpresarial != null) {
            try {
                middleEmpresarial.closeAllBrowsers();
            } catch (Exception e) {
                System.err.println("Error cerrando navegador Middle: " + e.getMessage());
            }
        }
    }
}



