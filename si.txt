package ControllerPyme;

import java.io.File;
import java.io.IOException;
import java.nio.charset.StandardCharsets;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.nio.file.StandardOpenOption;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import dav.Consultas_Y_Extractos.PageConsultasyExtractos;
import dav.library.common.DatosEmpresarial;
import dav.pymes.PageLoginPymes;
import dav.pymes.PagePortalPymes;
import dav.pymes.moduloCrearTx.ControllerCrearTx;
import dav.pymes.moduloTx.PageOrigen;
import library.common.Util;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsRun;

public class ControllerTestNomProve implements Controller {

	private PageLoginPymes pageLoginPyme;
	private PagePortalPymes pagePortalPymes;
	private PageOrigen pageOrigen;
	private ControllerCrearTx controller;
	private PageConsultasyExtractos pageConsultasyExtractos;

	private String clienteEmpresarial, tipoIdentificación, idUsuario, clavePersonaloCVE, tipoToken, Semilla,
			tipoIDEmpresa, numeroIDEmpresa, nombreEmpresa, servicio, tipProductoOrigen, numeroProductoOrigen,
			archivoDestinostxt;

	private String msgError, ruta;
	private boolean sessionActive = false;
	private String mainWindowHandle = null;

	private static final String[] LOGIN_KEYS = { "Cliente Empresarial", "Tipo Identificación", "Id usuario",
			"Clave personal o CVE", "Tipo Token", "Semilla / Valor Estático / Celular" };

	private static final String[] FLUJO_KEYS = { "Tipo ID Empresa", "Numero ID Empresa", "Nombre Empresa", "Servicio",
			"Tipo producto origen / Franquicia", "Número producto origen", "Archivo Destinos txt" };

	@Override
	public void destroy() {
		try {
			if (sessionActive && pageLoginPyme != null && pageLoginPyme.getDriver() != null) {
				pageLoginPyme.changeToDefaultFrame();
				pageLoginPyme.CerrarSesionFront();
			}
		} catch (Exception e) {
			Reporter.write("Error al cerrar sesión: " + e.getMessage());
		} finally {
			sessionActive = false;
		}
	}

	public void cargarDatosNom() throws Exception {
		ruta = Evidence.getNbEvidenceDirectory() + File.separator + "ArchPlanoClone.txt";
		clienteEmpresarial = getParameter(LOGIN_KEYS[0]);
		tipoIdentificación = getParameter(LOGIN_KEYS[1]);
		idUsuario = getParameter(LOGIN_KEYS[2]);
		clavePersonaloCVE = getParameter(LOGIN_KEYS[3]);
		tipoToken = getParameter(LOGIN_KEYS[4]);
		Semilla = getParameter(LOGIN_KEYS[5]);

		tipoIDEmpresa = getParameter(FLUJO_KEYS[0]);
		numeroIDEmpresa = getParameter(FLUJO_KEYS[1]);
		nombreEmpresa = getParameter(FLUJO_KEYS[2]);
		servicio = getParameter(FLUJO_KEYS[3]);
		tipProductoOrigen = getParameter(FLUJO_KEYS[4]);
		numeroProductoOrigen = getParameter(FLUJO_KEYS[5]);
		archivoDestinostxt = getParameter(FLUJO_KEYS[6]);

		DatosEmpresarial.AMBIENTE_TEST = mapAmbiente(SettingsRun.getGlobalData("AMBIENTE_PYME"));
	}

	public void doingTest() throws Exception {
		cargarDatosNom();
		File archivo = new File(archivoDestinostxt);
		generarPlanoRCModificado(archivo);
		flujoSoloFront();
	}

	public void flujoSoloFront() throws Exception {
		loadLoginFrontDataAndReport();

		// Inicializar página de login
		if (pageLoginPyme == null) {
			pageLoginPyme = new PageLoginPymes();
		}

		// Verificar si necesita hacer login
		int hojaActual = SettingsRun.getTestData().getCurrentExec();
		int hojaSiguiente = hojaActual + 1;
		String siguienteID = SettingsRun.getTestData().getParameterByExec("Id usuario", hojaSiguiente);

		boolean necesitaLogin = !siguienteID.contentEquals(idUsuario) || SettingsRun.esIteracionInicial();

		if (necesitaLogin) {
			Reporter.write("Ejecutando login para usuario: " + idUsuario);
			
			// Guardar el handle de la ventana principal ANTES del login
			mainWindowHandle = pageLoginPyme.getDriver().getWindowHandle();
			Reporter.write("Ventana principal guardada: " + mainWindowHandle);
			
			// Ejecutar login
			msgError = pageLoginPyme.loginFront();
			
			if (msgError != null && !msgError.isEmpty()) {
				Reporter.reportEvent(Reporter.MIC_FAIL, "Error en login: " + msgError);
				SettingsRun.exitTestIteration();
				return;
			}
			
			sessionActive = true;
			
			// CRÍTICO: Esperar a que se abra la nueva ventana y cambiar a ella
			if (!esperarYCambiarANuevaVentana()) {
				Reporter.reportEvent(Reporter.MIC_FAIL, "No se pudo cambiar a la ventana de la aplicación");
				SettingsRun.exitTestIteration();
				return;
			}
		} else {
			Reporter.write("Reutilizando sesión existente para usuario: " + idUsuario);
		}

		// Verificar que estamos en una ventana válida
		if (!isSessionValid()) {
			Reporter.reportEvent(Reporter.MIC_FAIL, "La sesión no es válida después del login");
			SettingsRun.exitTestIteration();
			return;
		}

		// Ejecutar flujo transaccional
		flujoFrontTransaccional();
	}

	private String[] loadLoginFrontDataAndReport() throws Exception {
		DatosEmpresarial.loadLoginData(LOGIN_KEYS[0], LOGIN_KEYS[1], LOGIN_KEYS[2], LOGIN_KEYS[3], LOGIN_KEYS[4],
				LOGIN_KEYS[5]);
		String[] datosLogin = DatosEmpresarial.getLoginData();
		Reporter.write("Datos de Logueo Front: [" + Util.arrayToString(datosLogin, " - ") + "]");
		return datosLogin;
	}

	/**
	 * Espera a que se abra una nueva ventana después del login y cambia a ella,
	 * cerrando la ventana de login si es necesario
	 */
	private boolean esperarYCambiarANuevaVentana() {
		try {
			Reporter.write("Esperando apertura de nueva ventana...");
			
			// Esperar hasta 30 segundos a que aparezca una segunda ventana
			int intentos = 0;
			int maxIntentos = 30;
			Set<String> handles = null;
			
			while (intentos < maxIntentos) {
				Util.wait(1);
				handles = pageLoginPyme.getDriver().getWindowHandles();
				
				if (handles.size() >= 2) {
					Reporter.write("Nueva ventana detectada después de " + intentos + " segundos");
					break;
				}
				intentos++;
			}
			
			if (handles == null || handles.size() < 2) {
				Reporter.write("ADVERTENCIA: Solo se detectó " + (handles != null ? handles.size() : 0) + " ventana(s)");
				// Si solo hay una ventana, continuar con ella
				if (handles != null && handles.size() == 1) {
					String ventanaActual = new ArrayList<>(handles).get(0);
					pageLoginPyme.getDriver().switchTo().window(ventanaActual);
					Reporter.write("Continuando con ventana única: " + ventanaActual);
					return true;
				}
				return false;
			}

			List<String> ventanas = new ArrayList<>(handles);
			Reporter.write("Total de ventanas abiertas: " + ventanas.size());
			
			// Identificar la ventana nueva (la que NO es mainWindowHandle)
			String ventanaApp = null;
			for (String ventana : ventanas) {
				if (!ventana.equals(mainWindowHandle)) {
					ventanaApp = ventana;
					break;
				}
			}
			
			if (ventanaApp == null) {
				Reporter.write("No se pudo identificar la ventana de la aplicación");
				// Usar la última ventana como fallback
				ventanaApp = ventanas.get(ventanas.size() - 1);
			}
			
			Reporter.write("Ventana de aplicación identificada: " + ventanaApp);
			
			// Cambiar a la ventana de la aplicación
			pageLoginPyme.getDriver().switchTo().window(ventanaApp);
			Util.wait(2);
			
			// Intentar cerrar la ventana de login si todavía existe
			try {
				Set<String> handlesActuales = pageLoginPyme.getDriver().getWindowHandles();
				if (handlesActuales.contains(mainWindowHandle) && handlesActuales.size() > 1) {
					Reporter.write("Cerrando ventana de login...");
					pageLoginPyme.getDriver().switchTo().window(mainWindowHandle);
					pageLoginPyme.getDriver().close();
					// Volver a la ventana de la aplicación
					pageLoginPyme.getDriver().switchTo().window(ventanaApp);
					Reporter.write("Ventana de login cerrada exitosamente");
				}
			} catch (Exception e) {
				Reporter.write("No se pudo cerrar ventana de login (posiblemente ya cerrada): " + e.getMessage());
				// Asegurar que estamos en la ventana correcta
				pageLoginPyme.getDriver().switchTo().window(ventanaApp);
			}
			
			// Actualizar el handle principal
			mainWindowHandle = ventanaApp;
			
			// Verificar que estamos en la ventana correcta
			String tituloVentana = pageLoginPyme.getDriver().getTitle();
			Reporter.write("Ventana activa - Título: " + tituloVentana);
			
			return true;
			
		} catch (Exception e) {
			Reporter.write("Error al cambiar ventanas: " + e.getMessage());
			e.printStackTrace();
			return false;
		}
	}

	/**
	 * Verifica si la sesión de Selenium sigue activa
	 */
	private boolean isSessionValid() {
		try {
			if (pageLoginPyme == null || pageLoginPyme.getDriver() == null) {
				Reporter.write("Validación: Driver no inicializado");
				return false;
			}
			
			// Verificar que hay al menos una ventana disponible
			Set<String> handles = pageLoginPyme.getDriver().getWindowHandles();
			if (handles.isEmpty()) {
				Reporter.write("Validación: No hay ventanas disponibles");
				return false;
			}
			
			// Asegurar que estamos en una ventana válida
			String currentHandle = pageLoginPyme.getDriver().getWindowHandle();
			if (!handles.contains(currentHandle)) {
				Reporter.write("Validación: Handle actual no está en la lista de ventanas");
				// Intentar cambiar a una ventana válida
				String primeraVentana = new ArrayList<>(handles).get(0);
				pageLoginPyme.getDriver().switchTo().window(primeraVentana);
				Reporter.write("Cambiado a primera ventana válida: " + primeraVentana);
			}
			
			// Intentar obtener el título como verificación final
			String titulo = pageLoginPyme.getDriver().getTitle();
			Reporter.write("Validación exitosa - Título: " + titulo);
			return true;
			
		} catch (Exception e) {
			Reporter.write("Sesión inválida detectada: " + e.getMessage());
			return false;
		}
	}

	/**
	 * Flujo transaccional dentro del Front: selección de empresa y transacciones.
	 */
	private void flujoFrontTransaccional() throws Exception {
		if (!isSessionValid()) {
			Reporter.reportEvent(Reporter.MIC_FAIL, "Sesión inválida al iniciar flujo transaccional");
			SettingsRun.exitTestIteration();
			return;
		}

		pageOrigen = new PageOrigen(pageLoginPyme);
		pagePortalPymes = new PagePortalPymes(pageLoginPyme);
		String localMsgError = null;

		try {
			pagePortalPymes.changeToDefaultFrame();
			localMsgError = pagePortalPymes.seleccionarEmpresa(nombreEmpresa);
			if (localMsgError != null) {
				Reporter.write(localMsgError);
			}
		} catch (Exception e) {
			Reporter.write("Intento alternativo de selección de empresa: " + e.getMessage());
			try {
				pagePortalPymes.changeToFirstFrame();
				localMsgError = pagePortalPymes.seleccionarEmpresa(nombreEmpresa);
				if (localMsgError != null) {
					Reporter.write(localMsgError);
				}
			} catch (Exception ex) {
				Reporter.reportEvent(Reporter.MIC_FAIL, "Error al seleccionar empresa: " + ex.getMessage());
				throw ex;
			}
		}

		transar();
	}

	public void transar() throws Exception {
		if (!isSessionValid()) {
			Reporter.reportEvent(Reporter.MIC_FAIL, "Sesión inválida al iniciar transacción");
			SettingsRun.exitTestIteration();
			return;
		}

		try {
			controller = new ControllerCrearTx(pageLoginPyme);
			controller.crearPagoNomina_Proveedores(false);

			pageLoginPyme.changeToDefaultFrame();
			
			Reporter.write("Transacción completada exitosamente");
		} catch (Exception e) {
			Reporter.reportEvent(Reporter.MIC_FAIL, "Error durante la transacción: " + e.getMessage());
			throw e;
		}
	}

	private String mapAmbiente(String raw) throws Exception {
		if (raw == null)
			return "";
		switch (raw) {
		case "1":
		case "PROYECTOS":
			return "PROYECTOS";
		case "2":
		case "CONTENCION":
			return "CONTENCION";
		case "3":
		case "OBSOLESCENCIA":
			return "OBSOLESCENCIA";
		case "4":
		case "ONPREMISE":
			return "ONPREMISE";
		case "5":
		case "POST_NUBE":
			return "POST_NUBE";
		case "6":
		case "CONTENCION_NUBE":
			return "CONTENCION_NUBE";
		case "7":
		case "PROYECTOS_NUBE":
			return "PROYECTOS_NUBE";
		case "8":
		case "PROYECTOS_SO":
			return "PROYECTOS_SO";
		case "9":
		case "MEJORAS":
			return "MEJORAS";
		default:
			Reporter.reportEvent(Reporter.MIC_FAIL, "Opción de ambiente no válida: " + raw);
			SettingsRun.exitTestIteration();
			return raw;
		}
	}

	public void postAprobacionUnaFirma() throws Exception {
		if (!isSessionValid()) {
			Reporter.write("Sesión no válida, saltando post-aprobación");
			return;
		}

		if (!servicio.contains("Internacionales") && !servicio.contains("Divisas")
				&& !servicio.contains("Pagos Automaticos") && !servicio.contains("ORPA")) {
			pageConsultasyExtractos = new PageConsultasyExtractos(pageLoginPyme);
			String tipoProduct = SettingsRun.getTestData().getParameter("Tipo producto origen / Franquicia").trim();
			String numeroProducto = SettingsRun.getTestData().getParameter("Número producto origen").trim();

			pageConsultasyExtractos.ConsultayExtractos(servicio, "CHROME", tipoIDEmpresa, numeroIDEmpresa,
					tipoIdentificación, idUsuario, tipoProduct, numeroProducto, false, null);
		}
	}

	private String getParameter(String key) {
		return SettingsRun.getTestData().getParameter(key);
	}

	public String generarPlanoRCModificado(File archivoPlanoOriginal) throws IOException {

		Path inputPath = archivoPlanoOriginal.toPath();
		java.util.List<String> lineas = Files.readAllLines(inputPath, StandardCharsets.UTF_8);

		if (lineas.isEmpty()) {
			throw new IllegalArgumentException("El archivo plano está vacío.");
		}

		String lineaOriginal = lineas.get(0);

		StringBuilder padded = new StringBuilder(lineaOriginal);
		while (padded.length() < 170) {
			padded.append(' ');
		}
		String original = padded.toString();

		String codigoBanco = original.substring(44, 50);
		String valorTotal = original.substring(50, 68);
		String numeroTotal = original.substring(68, 74);
		String fechaProceso = original.substring(74, 82);
		String horaProceso = original.substring(82, 88);

		if (codigoBanco.trim().isEmpty()) {
			throw new IllegalArgumentException("Código de banco no existe en el plano original.");
		}

		StringBuilder rc = new StringBuilder();

		rc.append("RC");

		String numeroIDEmpresatr = Util.leftComplete(numeroIDEmpresa, 16, '0');
		rc.append(limpiar(numeroIDEmpresatr));

		rc.append(obtenerCodigoServicio(servicio));

		String numeroProductoOrigentr = Util.leftComplete(numeroProductoOrigen, 16, '0');
		rc.append(limpiar(numeroProductoOrigentr));

		rc.append(obtenerTipoCuenta(tipProductoOrigen));
		rc.append(codigoBanco);
		rc.append(valorTotal);
		rc.append(numeroTotal);
		rc.append(fechaProceso);
		rc.append(horaProceso);
		rc.append("0000");
		rc.append("9999");
		rc.append("00000000");
		rc.append("000000");
		rc.append("00");
		rc.append("03");
		rc.append("000000000000");
		rc.append("0000");
		rc.append(Util.repeat('0', 40));

		lineas.set(0, rc.toString());

		Path salida = Paths.get(ruta);
		Files.createDirectories(salida.getParent());
		Files.write(salida, lineas, StandardCharsets.UTF_8, StandardOpenOption.CREATE,
				StandardOpenOption.TRUNCATE_EXISTING);

		return salida.toAbsolutePath().toString();
	}

	private String obtenerCodigoServicio(String servicio) {
		if (servicio == null)
			return "PROVPROV";
		servicio = servicio.toLowerCase();

		if (servicio.contains("nomina") || servicio.contains("nómina")) {
			return "NOMINOMI";
		}
		return "PROVPROV";
	}

	private String obtenerTipoCuenta(String tipo) {
		if (tipo == null)
			return "CA";
		tipo = tipo.toLowerCase();

		if (tipo.contains("ahorro"))
			return "CA";
		if (tipo.contains("corriente"))
			return "CC";

		return "CA";
	}

	private String limpiar(String valor) {
		return valor == null ? "" : valor.replaceAll("[^0-9]", "");
	}
}
