package launchTest;

import java.util.*;
import java.io.File;
import java.io.IOException;
import java.nio.file.*;
import java.util.stream.Collectors;

import org.openqa.selenium.By;
import org.openqa.selenium.support.ui.ExpectedConditions;
import org.openqa.selenium.support.ui.WebDriverWait;

import dav.ActualizacionDeDatos.PageActualizacionDeDatos;
import dav.CobrosMiddle.ControllerMiddleCobros;
import dav.CobrosMiddle.PageAdminCombosCobros;
import dav.Consultas_Y_Extractos.PageConsultasyExtractos;
import dav.TransaccionesProgramadas.PageTransaccionesProgramadas;
import dav.c360.PageInicioC360;
import dav.c360.PageLogin;
import dav.divisas.PageAprobacionInter;
import dav.divisas.PageConsultatxInternacional;
import dav.divisas.PageDivisas;
import dav.divisas.PageDocumentos_Y_Formularios;

import dav.library.common.DatosEmpresarial;
import dav.library.reporting.EvidencePdfFile;

import dav.middlePymes.ControllerValiPymeMiddle;
import dav.middlePymes.PageUsuariosEmpresa;

import dav.pymes.PageLoginPymes;
import dav.pymes.PagePortalPymes;
import dav.pymes.moduloCrearTx.ControllerCrearTx;
import dav.pymes.moduloCrearTx.ControllerDestinosMasivos;
import dav.pymes.moduloTx.PageAdminParametros;
import dav.pymes.moduloTx.PageOrigen;

import dav.transversal.DatosDavivienda;
import dav.transversal.MotorRiesgo;
import dav.transversal.Stratus;

import dxc.util.DXCUtil;

import library.common.Util;
import library.core.BasePageWeb;
import library.core.BaseTestNG;
import library.reporting.Evidence;
import library.reporting.Reporter;
import library.settings.SettingsRun;
import screens.actions.consulta.StratusProductos;

public class LaunchTestPyme extends BaseTestNG {

    // ============================== Páginas / Controladores ==============================
    PageLoginPymes pageLoginPyme;
    PagePortalPymes pagePortalPymes;
    PageOrigen pageOrigen;
    PageDivisas pageDivisas;
    PageUsuariosEmpresa pageUsuariosEmpresa;
    PageAdminParametros pageAdminParametros;
    PageConsultasyExtractos pageConsultasyExtractos;
    ControllerCrearTx controller;
    ControllerDestinosMasivos controllerDestinosMasivos;
    ControllerValiPymeMiddle controllerValiPymeMiddle;
    PageAprobacionInter pageAprobInter;
    PageConsultatxInternacional pageConsultatxInternacional;
    PageDocumentos_Y_Formularios pageDocumentos_Y_Formularios;
    PageTransaccionesProgramadas pageTransaccionesProgramadas;
    ControllerMiddleCobros controllerMiddleCobros;
    PageAdminCombosCobros pageAdminCombosCobros;
    PageActualizacionDeDatos pageActualizacionDeDatos;
    PageLogin pageLoginC360;
    PageInicioC360 pageInicioC360;

    StratusProductos instanciaStratus;

    // ============================== Constantes / Tipos prueba ============================
    final String TP_LOGIN     = "Login";
    final String TP_EN_LINEA  = "Tx En Línea";
    final String TP_PEND_APR  = "Tx Pend Aprobación";
    final String CN_APRO_PEND = "1";
    final String DE_El_DETALLE = "SI";

    // ============================== Datos globales ======================================
    String transaccion = MotorRiesgo.TX_EMP_LOGIN_SUCC; // default
    String nombreAmbiente, usuario, contratacion, cobros, stratus, tipoPrueba, desde_el_Detalle, servicio;
    String riesgoBc, riesgoEfm, riesgo, userAgent, empresa, tipoIDEmpresa, numeroIDEmpresa, tipoIdentificacion, Idusuario;
    String numAprobaciones, informe, numCliEmp, tipoDoc, numDoc, clave, tipoTok, datoTok;
    String Motorna = "N/A";
    public static String realizarMR, ipPublica;
    Date fechaHoraLogMR;

    // Consulta comprobantes
    String tipoConstaTxRealizadas, ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda, fechaTx, horaTx, fechaDesde, fechaHasta, valorTx;

    // Re-uso de últimos valores
    private String lastNumAprobaciones = "";
    private String lastTipoAbono = "";
    private String lastCtaInscrita = "";
    private String lastIdusuario = "";
    private String lastempresa = "";

    // Locators
    By log30       = By.xpath("/html/body/h2[1]/p");
    By locCmEmpresa= By.xpath("//select[@id='dropMasterEmpresa']");
    By cerrarSesion= By.xpath("//*[@id='CerrarSesion']");
    By cmCerrSes   = By.cssSelector("a[id='CerrarSesion']");
    By xpahtfecha  = By.xpath("//*[@id='tabla-top']/tbody/tr[1]/td[1]");
    By ip          = By.xpath("/html/body/pre");

    // Cobros / Stratus
    List<HashMap<String, String>> resultsMiddle = new ArrayList<>();
    HashMap<String, Double> segmentosStratus = new HashMap<>();
    double[] validacionDescuento;
    String[] estadotxFinal;
    String validarCliente = "";

    // ============================== LaunchData ==========================================
    @Override
    public void launchData() {
        Reporter.initializeEvidenceType(new EvidencePdfFile());
        SettingsRun.DEFAULT_HEADER = 4;
    }

    // ============================== Helpers =============================================
    private static String g(String key)                 { return SettingsRun.getGlobalData(key); }
    private static String p(String key)                 { return SettingsRun.getTestData().getParameter(key).trim(); }
    private static boolean has(String key)              { return SettingsRun.getTestData().parameterExist(key); }
    private static void info(String msg)                { Reporter.reportEvent(Reporter.MIC_INFO, msg); }
    private static void pass(String msg)                { Reporter.reportEvent(Reporter.MIC_PASS, msg); }
    private static void fail(String msg)                { Reporter.reportEvent(Reporter.MIC_FAIL, msg); }
    private static void noexec(String msg)              { Reporter.reportEvent(Reporter.MIC_NOEXEC, msg); }
    private static void header(String msg)              { Reporter.reportEvent(Reporter.MIC_HEADER, msg); }

    private boolean eq(String a, String b)              { return a != null && a.equals(b); }
    private boolean contains(String a, String needle)   { return a != null && a.contains(needle); }

    private void requireFileOrExit(String absolutePath, String humanName) {
        if (!DXCUtil.ArchivoExist(absolutePath)) {
            noexec("El sistema no puede encontrar el archivo " + humanName + ": " + absolutePath);
            closeAllIfAny();
            SettingsRun.exitTestIteration();
        }
    }

    private void closeAllIfAny() {
        if (pageLoginPyme != null && ThereareOpenWindows()) pageLoginPyme.closeAllBrowsers();
    }

    private String normalizeAmbiente(String raw) {
        if (raw == null) return "";
        switch (raw) {
            case "1": case "PROYECTOS":        return "PROYECTOS";
            case "2": case "CONTENCION":       return "CONTENCION";
            case "3": case "OBSOLESCENCIA":    return "OBSOLESCENCIA";
            case "4": case "ONPREMISE":        return "ONPREMISE";
            case "5": case "POST_NUBE":        return "POST_NUBE";
            case "6": case "CONTENCION_NUBE":  return "CONTENCION_NUBE";
            case "7": case "PROYECTOS_NUBE":   return "PROYECTOS_NUBE";
            case "8": case "MEJORAS":          return "MEJORAS";
            default: fail("Opción no válida");  return raw;
        }
    }

    private void cargarLoginMiddleFijoDesdeGlobal() {
        DatosEmpresarial.loadLoginDataFija("0",
                g("MIDDLE.tipoDoc"),
                g("MIDDLE.numeroDeId"),
                g("MIDDLE.clavePersonal"),
                g("MIDDLE.tipoToken"),
                g("MIDDLE.numeroToken"));
        String[] datosLogin = DatosEmpresarial.getLoginData();
        info("*** Datos de Logueo Middle: [" + Util.arrayToString(datosLogin, " - ") + "]");
        numCliEmp = datosLogin[0];
        tipoDoc   = datosLogin[1];
        numDoc    = datosLogin[2];
        clave     = datosLogin[3];
        tipoTok   = datosLogin[4];
        datoTok   = datosLogin[5];
        PageLoginPymes.datosMidell(numCliEmp, tipoDoc, numDoc, clave, tipoTok, datoTok);
        PageUsuariosEmpresa.datosMidellToke(datoTok);
    }

    private void prepararMR() throws Exception {
        if (!"SI".equals(realizarMR)) return;

        riesgoBc = p("Nivel de Riesgo BC");
        // EFM sólo si no es escenario divisas internacional
        if (!servicio.equals("Tx Internacionales Recibir desde el exterior")
                && !servicio.equals("Tx Internacionales Enviar al exterior")) {
            riesgoEfm = p("Nivel de Riesgo SAS EFM");
        }

        if (isNullOrEmpty(riesgoBc) || (riesgoEfm == null && !servicio.contains("Internacionales"))) {
            fail("Falta Ingresar Datos de MR");
            if (pagePortalPymes != null) pagePortalPymes.terminarIteracion();
            launchClose();
        }

        DatosDavivienda.IS_RISKMOTOR = true;
        String nbArchivo = MotorRiesgo.preguntarPorArchivoMR();
        final boolean esDivisas = servicio.equals("Tx Internacionales Recibir desde el exterior")
                || servicio.equals("Tx Internacionales Enviar al exterior");

        if (!esDivisas) {
            DatosDavivienda.RISKMOTOR = (nbArchivo == null)
                    ? new MotorRiesgo(DatosDavivienda.CANAL_PYME_FRONT)
                    : new MotorRiesgo(DatosDavivienda.CANAL_PYME_FRONT, nbArchivo);
        } else {
            DatosDavivienda.RISKMOTOR = (nbArchivo == null)
                    ? new MotorRiesgo(DatosDavivienda.CANAL_PYME_FRONT_DIVISAS)
                    : new MotorRiesgo(DatosDavivienda.CANAL_PYME_FRONT_DIVISAS, nbArchivo);
        }
    }

    private static boolean isNullOrEmpty(String s) { return s == null || s.trim().isEmpty(); }

    private void prepararAmbienteYFlags() {
        nombreAmbiente = normalizeAmbiente(g("AMBIENTE_PYME"));
        if (isNullOrEmpty(nombreAmbiente)) {
            fail("Nombre del ambiente seleccionado: Portal - " + nombreAmbiente);
        } else {
            header("Nombre del ambiente seleccionado: Portal - " + nombreAmbiente);
        }
        DatosEmpresarial.AMBIENTE_TEST = nombreAmbiente;

        contratacion = g("CONTRATACION");
        realizarMR   = g("MOTOR.motorDeRiesgo");

        if ("NO".equals(realizarMR)) {
            cobros  = g("VALIDACION.COBROS");
            stratus = g("VALIDAR.STRATUS");
        } else {
            cobros = "NO";
            stratus = "NO";
        }
        servicio = p("Servicio");
    }

    private void cargarParametrosConsultaComprobantes() {
        if (has("Tiempo de Consulta")) tipoConstaTxRealizadas = p("Tiempo de Consulta");
        if (has("Ordenante / Nombre del beneficiario en el exterior"))
            ordenanteBeneficiario = p("Ordenante / Nombre del beneficiario en el exterior");
        if (has("Tipo de Transferencia")) tipoTranferencia = p("Tipo de Transferencia");
        if (has("Fecha Día Inicial  Desde (dd/mm/YYYY)")) { /* originalmente comentado */ }
        if (has("Fecha DÍa Final Hasta (dd/mm/YYYY)"))    { /* originalmente comentado */ }
        if (has("Estado"))          estado    = p("Estado");
        if (has("Tipo Moneda"))     tipoMoneda= p("Tipo Moneda");
        if (has("Fecha tx"))        fechaTx   = p("Fecha tx");
        if (has("Hora tx"))         horaTx    = p("Hora tx");

        valorTx = p("Valor a Pagar / Transferir");
        usuario = p("Nombre de Usuario");
    }

    private void decidirRiesgoUsado() {
        if (!"SI".equals(realizarMR)) return;

        if (!servicio.contains("Tx Internacionales")) {
            riesgoBc = p("Nivel de Riesgo BC");
            riesgoEfm = p("Nivel de Riesgo SAS EFM");
            if (g("MOTOR.tipoMotor").contains("EFM")) riesgo = riesgoEfm;
            else if (g("MOTOR.tipoMotor").contains("BC")) riesgo = riesgoBc;
        } else { // internacionales
            riesgoBc = p("Nivel de Riesgo BC");
            riesgo   = riesgoBc;
        }
    }

    // ============================== initializeControllerAndConfiguration =================
    public void initializeControllerAndConfiguration() throws Exception {
        Reporter.writeTitle("\n*** PRUEBAS PORTAL PYME ***");
        DXCUtil.startWinAppDriver();

        SettingsRun.ARRAY_DATA_PARAMS = new String[] { "Selección", "Tx Finalizada", "Tx FAIL" };
        SettingsRun.getTestData().addParametersNotExist(SettingsRun.ARRAY_DATA_PARAMS);

        prepararAmbienteYFlags();
        cargarParametrosConsultaComprobantes();
        prepararMR();
    }

    // ============================== doingTest ===========================================
    @Override
    public void doingTest() throws Exception {
        // Selección de riesgo efectivo
        decidirRiesgoUsado();

        // Datos Middle fijos
        DatosEmpresarial.loadLoginDataFija("0", g("MIDDLE.tipoDoc"), g("MIDDLE.numeroDeId"),
                g("MIDDLE.clavePersonal"), g("MIDDLE.tipoToken"), g("MIDDLE.numeroToken"));

        String[] datosLogin = DatosEmpresarial.getLoginData();
        if ("SI".equals(contratacion) || "SOLO".equals(contratacion))
            info("*** Datos de Logueo Middle: [" + Util.arrayToString(datosLogin, " - ") + "]");

        numCliEmp = datosLogin[0];
        tipoDoc   = datosLogin[1];
        numDoc    = datosLogin[2];
        clave     = datosLogin[3];
        tipoTok   = datosLogin[4];
        datoTok   = datosLogin[5];
        PageLoginPymes.datosMidell(numCliEmp, tipoDoc, numDoc, clave, tipoTok, datoTok);
        PageUsuariosEmpresa.datosMidellToke(datoTok);

        // Parámetros del caso
        servicio          = p("Servicio");
        tipoPrueba        = p("Tipo prueba");
        desde_el_Detalle  = p("Desde_el_Detalle");
        empresa           = p("Nombre Empresa");
        String clienteEmpresarial = p("Cliente Empresarial");
        Idusuario         = p("Id usuario");
        tipoIdentificacion= p("Tipo Identificación");
        tipoIDEmpresa     = p("Tipo ID Empresa");
        numeroIDEmpresa   = p("Numero ID Empresa");

        if (isNullOrEmpty(tipoPrueba)) {
            Reporter.write("Falta Ingresar Datos de Tipo Prueba, Campo es Obligatorio ");
            SettingsRun.exitTestIteration();
        }

        if (servicio.contains("Tx Internacionales Recibir desde el exterior")
                || servicio.contains("Tx Internacionales Enviar al exterior")) {
            validarCliente = p("ValidarC360");
        }

        // MR: inicializar valores temp si aplica
        if ("SI".equals(realizarMR)) {
            if ((!isNullOrEmpty(riesgoBc) || !isNullOrEmpty(riesgoEfm)))
                DatosDavivienda.RISKMOTOR.inicializaValoresTemp();
        }

        // Contratación
        if ("SI".equals(contratacion)) {
            flujoContratacionCompleta();
        } else if ("SOLO".equals(contratacion)) {
            flujoSoloMiddle();
        } else if ("NO".equals(contratacion)) {
            flujoSoloFront(datosLogin, clienteEmpresarial, tipoIdentificacion);
        } else if ("Informe".equals(contratacion)) {
            flujoInforme();
        }
    }

    // ============================== Flujos de contratación ==============================
    private void flujoContratacionCompleta() throws Exception {
        String msgError;
        pageLoginPyme = new PageLoginPymes();
        msgError = pageLoginPyme.loginMiddle();
        pageLoginPyme.selecionambienteClose("SI");

        if (msgError == null) {
            controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);
            numAprobaciones = p("Números de Aprobaciones");
            int firmas = Integer.parseInt(numAprobaciones);

            // Firma 1 + resto
            controllerValiPymeMiddle.ValidacionMiddlefirmas(1);
            for (int i = 2; i <= firmas; i++) {
                controllerValiPymeMiddle.ValidacionMiddlefirmas(i);
            }

            if ("SI".equals(cobros)) {
                controllerMiddleCobros = new ControllerMiddleCobros(pageLoginPyme);
                resultsMiddle = controllerMiddleCobros.consultarCombos();
            }

            pageLoginPyme.CerrarSesionMiddle();

            if ("SI".equals(cobros) && "NO".equals(realizarMR)) {
                LoginStratus();
            }
            Front();
        }
    }

    private void flujoSoloMiddle() throws Exception {
        String msgError;
        pageLoginPyme = new PageLoginPymes();
        msgError = pageLoginPyme.loginMiddle();
        pageLoginPyme.selecionambienteClose("SI");

        if (msgError == null) {
            controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);
            numAprobaciones = p("Números de Aprobaciones");
            int firmas = Integer.parseInt(numAprobaciones);

            controllerValiPymeMiddle.ValidacionMiddlefirmas(1);
            for (int i = 2; i <= firmas; i++) {
                controllerValiPymeMiddle.ValidacionMiddlefirmas(i);
            }

            pageLoginPyme.CerrarSesionMiddle();
        }
    }

    private void flujoSoloFront(String[] datosLogin, String clienteEmpresarial, String tipoIdentificacion) throws Exception {
        String msgError = null;

        if ("NO".equals(realizarMR) && "SI".equals(cobros)) {
            LoginStratus();
            info("*** Datos de Logueo Middle: [" + Util.arrayToString(datosLogin, " - ") + "]");
            info("*** Cliente Empresarial: [" + clienteEmpresarial + "]");
            info("*** Tipo Identificación Usuario: [" + tipoIdentificacion + "] - Tipo Identificación Usuario: [" + Idusuario + "]");
            info("*** Tipo Servicio a contratar: [" + servicio + "]");
            info("*** Empresa a contratar: [" + empresa + "]");
            info("*** Tipo Identificación Empresa: [" + tipoIDEmpresa + "] - Numero Identificación Empresa: [" + numeroIDEmpresa + "]");

            String combo = p("Combos");
            String tipoCobro = p("Tipo Prueba Cobros");
            info("*** COMBO SELECIONADO: " + combo);
            info("*** TIPO COBRO SELECIONADO: " + tipoCobro);

            pageLoginPyme = new PageLoginPymes();
            msgError = pageLoginPyme.loginMiddle();
            pageLoginPyme.selecionambienteClose("SI");

            controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);
            controllerMiddleCobros = new ControllerMiddleCobros(pageLoginPyme);
            resultsMiddle = controllerMiddleCobros.consultarCombos();
            pageLoginPyme.CerrarSesionMiddle();
        }

        Front();
    }

    private void flujoInforme() throws Exception {
        pageLoginPyme = new PageLoginPymes();
        String msgError = pageLoginPyme.loginMiddle();
        pageLoginPyme.selecionambienteClose("SI");

        if (msgError == null) {
            controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);
            numAprobaciones = p("Números de Aprobaciones");
            controllerValiPymeMiddle.ValidacionInformeTransInternacional();
        }
    }

    // ============================== FRONT (login y transacciones) =======================
    public void Front() throws Exception {

        // Pre-validaciones de archivos según el servicio
        switch (servicio) {
            case "Nómina":
            case "Pago de Nómina":
            case "Pago de Nóminas":
            case "Pago a Proveedores":
            case "Pagos a proveedores":
            case "Pagos proveedores":
            case "Proveedores":
            case "AFC":
            case "Pago a Créditos de Terceros":
            case "Pagos a créditos de terceros":
            case "Crédito.3ros":
                requireFileOrExit(p("Archivo Destinos"), "destino");
                break;

            case "Tx Internacionales Recibir desde el exterior":
            case "Tx Internacionales Enviar al exterior":
            case "Tx Internacionales Enviar al exterior Pendiente Aprobación":
            case "Divisas Documentos y Formularios":
            case "Consulta Tx Internacionales Enviar al exterior Validar Estado":
                String cargue = p("Cargue Archivo Documentos");
                String[] rutas = cargue.split(",");
                boolean ok = true;
                for (String r : rutas) {
                    if (!DXCUtil.ArchivoExist(r)) {
                        info("El sistema no puede encontrar el archivo Cargue de documento especificado: " + r);
                        ok = false;
                    }
                }
                if (!ok) {
                    noexec("El sistema no puede encontrar el archivo Cargue especificado: " + cargue);
                    closeAllIfAny();
                    SettingsRun.exitTestIteration();
                }
                break;
            default:
                // sin pre-validación
        }

        if ("NO".equals(realizarMR)) {
            LoginStratus();
            if ("SI".equals(cobros)) {
                String plano = SettingsRun.getParentResultDir() + "Archivo_Segmentos.txt";
                if (DXCUtil.ArchivoExist(plano) && DXCUtil.archivoCreadoOModificadoHoy(plano)) {
                    if (controllerDestinosMasivos == null) controllerDestinosMasivos = new ControllerDestinosMasivos(null);
                    segmentosStratus = controllerDestinosMasivos.LeerArchivoPlano();
                } else {
                    info("Validacion Segmento en Stratus");
                    segmentosStratus = DatosDavivienda.STRATUS.irTablaValores(resultsMiddle.get(0).get("Segmento"));
                    if (controllerDestinosMasivos == null) controllerDestinosMasivos = new ControllerDestinosMasivos(null);
                    controllerDestinosMasivos.CrearArchivoPlano_Segmentos(segmentosStratus);
                }
            }
        }

        DXCUtil.Movercursor();

        String msgError;
        int intento = 0;

        // Datos de login Front
        DatosEmpresarial.loadLoginData("Cliente Empresarial", "Tipo Identificación", "Id usuario",
                "Clave personal o CVE", "Tipo Token", "Semilla / Valor Estático / Celular");

        String[] datosLogin = DatosEmpresarial.getLoginData();
        info("*** Navegador: [" + p("Navegador") + "]");
        info("*** Datos de Logueo Front: [" + Util.arrayToString(datosLogin, " - ") + "]");
        numAprobaciones = p("Números de Aprobaciones");
        info("*** Números de firmas: [" + numAprobaciones + "]");

        if ("SI".equals(realizarMR) && (!isNullOrEmpty(riesgoBc) || !isNullOrEmpty(riesgoEfm))) {
            String msgInicio;
            if (g("MOTOR.tipoMotor").contains("EFM"))
                msgInicio = "*** Tipo de Motor de riesgo : [SAS " + g("MOTOR.tipoMotor") + "]";
            else
                msgInicio = "*** Motor de riesgo : [" + g("tipoMotor") + "]";
            info(msgInicio);
            info("*** Riesgo BC: [" + riesgoBc + "]");
            if (!servicio.equals("Tx Internacionales Recibir desde el exterior")
                    && !servicio.equals("Tx Internacionales Enviar al exterior")) {
                info("*** Riesgo EFM: [" + riesgoEfm + "]");
            }
        }

        reportTipoPrueba();

        // Login front con reintento por log30
        do {
            pageLoginPyme = isConsultaValidarEstado(servicio) ? new PageLoginPymes(Evidence.getNbEvidenceDirectory())
                                                              : new PageLoginPymes();
            msgError = pageLoginPyme.loginFront();
            fechaHoraLogMR = pageLoginPyme.getFechaHoraLogMR();
            pageLoginPyme.selecionambienteClose("NO");

            if (DatosDavivienda.IS_RISKMOTOR && msgError != null && !TP_LOGIN.equals(tipoPrueba)) {
                fail(" *** No se adiciona a MR >>>" + msgError);
            }
            if (pageLoginPyme.element(log30) != null) {
                pageLoginPyme.NavegadorFront(pageLoginPyme.URL_FRONT);
                intento++;
            }

            // Reglas MR si era sólo login
            if ("SI".equals(realizarMR) && (!isNullOrEmpty(riesgoBc) || !isNullOrEmpty(riesgoEfm))) {
                if (tipoPrueba.contains("Login") && msgError != null && msgError.contains("Acceso denegado.En un momento")) {
                    DatosDavivienda.RISKMOTOR.setTemporalTime(pageLoginPyme.getFechaHoraLogMR());
                    DatosDavivienda.RISKMOTOR.setTemporalMonto("0");
                    if (riesgo.equals("Bajo") || riesgo.equals("Medio")) fail("Se esperaba Ingreso al portal");
                    adicionarRegistroMR("Error en Login");
                    pageLoginPyme.closeAllBrowsers();
                    SettingsRun.exitTestIteration();
                }
            }

        } while (pageLoginPyme.element(log30) != null && intento < 3);

        // Post-login
        if (msgError == null) {
            if ("SI".equals(realizarMR) && (TP_EN_LINEA.equals(tipoPrueba) || TP_PEND_APR.equals(tipoPrueba))) {
                if (!isNullOrEmpty(riesgoBc) || !isNullOrEmpty(riesgoEfm)) {
                    DatosDavivienda.RISKMOTOR.setTemporalTime(pageLoginPyme.getFechaHoraLogMR());
                    DatosDavivienda.RISKMOTOR.setTemporalMonto("0");
                }
            }

            Util.wait(5);
            boolean isPopup = this.WaitForNumberOfWindos();
            if (isPopup) pass("La ventana emergente se abrió correctamente");
            else {
                fail("No se abrió La ventana emergente");
                pagePortalPymes.terminarIteracion();
            }

            pageLoginPyme.closeCurrentBrowser();
            pageLoginPyme.changeWindow(pageLoginPyme.accedioAlPortal());
            Util.wait(3);
            pageLoginPyme.maximizeBrowser();

            if (TP_EN_LINEA.equals(tipoPrueba) || TP_PEND_APR.equals(tipoPrueba)) {
                flujoTransaccional();
            } else if (TP_LOGIN.equals(tipoPrueba)) {
                flujoSoloLogin();
            }

            pageLoginPyme.closeAllBrowsers();
        }
    }

    private void reportTipoPrueba() {
        if (TP_EN_LINEA.equals(tipoPrueba) || TP_PEND_APR.equals(tipoPrueba)) {
            if (!"SOLO".equals(contratacion)) {
                info("*** Tipo Prueba: [" + tipoPrueba + "]");
                info("*** Tipo transaccion: [" + servicio + "]");
                info("*** Empresa: [" + empresa + "]");
                info("*** Aprobar Desde el detalle: [" + desde_el_Detalle + "]");
            }
        } else if (TP_LOGIN.equals(tipoPrueba)) {
            if (!"SOLO".equals(contratacion)) info("*** Tipo Prueba: [" + tipoPrueba + "]");
        }
    }

    private boolean isConsultaValidarEstado(String servicio) {
        return "Consulta Tx Internacionales Enviar al exterior Validar Estado".equals(servicio);
    }

    private void flujoSoloLogin() {
        do {
            boolean visible = pageLoginPyme.isDisplayed(cmCerrSes);
            visible = pageLoginPyme.isDisplayed(cerrarSesion);
            visible = pageLoginPyme.isDisplayed(xpahtfecha);
            Util.wait(1);
        } while (pageLoginPyme.element(xpahtfecha) == null);

        if (pageLoginPyme.isDisplayed(cerrarSesion) && pageLoginPyme.isDisplayed(xpahtfecha) && pageLoginPyme.isDisplayed(cmCerrSes)) {
            String script = "document.querySelector('a[id=\"CerrarSesion\"').click();";
            pageLoginPyme.getJse().executeScript(script);

            if ("SI".equals(realizarMR)) {
                DatosDavivienda.RISKMOTOR.setTemporalResultado("Exitosa");
                adicionarRegistroMR(riesgo.equals("Alto") ? "Error en Login" : "Login");
            }
        }
    }

    private void flujoTransaccional() throws Exception {
        pageOrigen = new PageOrigen(pageLoginPyme);
        pagePortalPymes = new PagePortalPymes(pageLoginPyme);

        String msgError = pagePortalPymes.seleccionarEmpresa(empresa);
        if (msgError != null) { fail(msgError); pagePortalPymes.terminarIteracion(); return; }

        String tipoAbono     = p("Tipo de abono");
        String ctaInscrita   = p("Cuentas Inscriptas");
        numAprobaciones      = p("Números de Aprobaciones");
        String _Idusuario    = p("Id usuario");

        if (debeReConfigurarParametros(_Idusuario, empresa, numAprobaciones, tipoAbono, ctaInscrita)) {
            if (!servicio.equals("Divisas Documentos y Formularios")
                    && !"Consulta Tx Internacionales Enviar al exterior Validar Estado".equals(servicio)) {
                pageAdminParametros = new PageAdminParametros(pageLoginPyme);
                msgError = pageAdminParametros.hacerConfiguracion(numAprobaciones, tipoAbono, ctaInscrita);
            } else {
                msgError = "Divisas";
            }
            guardarValoresParametros(_Idusuario, empresa, numAprobaciones, tipoAbono, ctaInscrita);
        } else {
            msgError = "Ya se configuro los Parámetros Generales";
        }

        if (servicio.contains("Tx Internacionales")) {
            String codigoCIIU = p("Validar CIIU");
            if ("SI".equals(codigoCIIU)) {
                Util.wait(3);
                pageActualizacionDeDatos = new PageActualizacionDeDatos(pageLoginPyme);
                String msg = pageActualizacionDeDatos.InicioActualizacionDatos(false);
                if (msg != null && !msg.equals("Se actualizaron exitosamente los datos de su empresa")) {
                    msg = pageActualizacionDeDatos.MsgAlertaActualizacionDatos();
                    pagePortalPymes.terminarIteracion(Reporter.MIC_FAIL, msg);
                    return;
                } else {
                    pass(msg);
                }
            }
            if ("SI".equals(validarCliente)) {
                pageInicioC360 = logueoC360();
                pageConsultatxInternacional = new PageConsultatxInternacional(pageInicioC360);
                pageConsultatxInternacional.ValidarCCIU(numeroIDEmpresa);
                Reporter.write("*** Termina la Validación CLIENTE 360 ***");
            }
        }

        if (msgError == null) { fail(msgError); pagePortalPymes.terminarIteracion(); return; }

        transar();
    }

    private boolean debeReConfigurarParametros(String id, String emp, String firmas, String tipoAbono, String cta) {
        return !Objects.equals(id, lastIdusuario)
                || !Objects.equals(emp, lastempresa)
                || !Objects.equals(firmas, lastNumAprobaciones)
                || !Objects.equals(tipoAbono, lastTipoAbono)
                || !Objects.equals(cta, lastCtaInscrita);
    }

    private void guardarValoresParametros(String id, String emp, String firmas, String tipoAbono, String cta) {
        lastIdusuario = id;
        lastempresa   = emp;
        lastNumAprobaciones = firmas;
        lastTipoAbono = tipoAbono;
        lastCtaInscrita = cta;
    }

    // ============================== Front (aprobaciones múltiples) ======================
    public void Frontfirmas(int firmas) throws Exception {
        String msgError; int intento = 0;
        DatosEmpresarial.loadLoginData("Cliente Empresarial", "Tipo Identificación " + firmas, "Id usuario " + firmas,
                "Clave personal o CVE " + firmas, "Tipo Token " + firmas, "Semilla / Valor Estático / Celular " + firmas);

        do {
            pageLoginPyme = new PageLoginPymes();
            msgError = pageLoginPyme.loginFrontFirmas();
            pageLoginPyme.selecionambienteClose("NO");
            if (pageLoginPyme.element(log30) != null) {
                pageLoginPyme.NavegadorFront(pageLoginPyme.URL_FRONT);
                intento++;
            }
        } while (pageLoginPyme.element(log30) != null && intento < 2);

        if (msgError == null) {
            Util.wait(7);
            boolean isPopup = this.WaitForNumberOfWindos();
            if (isPopup) pass("La ventana emergente se abrió correctamente");
            else { fail("No se abrió La ventana emergente"); pagePortalPymes.terminarIteracion(); }

            pageLoginPyme.closeCurrentBrowser();
            pageLoginPyme.changeWindow(pageLoginPyme.accedioAlPortal());
            pageLoginPyme.maximizeBrowser();

            pageOrigen = new PageOrigen(pageLoginPyme);
            pagePortalPymes = new PagePortalPymes(pageLoginPyme);
            msgError = pagePortalPymes.seleccionarEmpresa(empresa);
            if (msgError != null) { fail(msgError); pagePortalPymes.terminarIteracion(); }
        }
    }

    // ============================== Transaccional =======================================
    public void transar() throws Exception {
        controller = new ControllerCrearTx(pageLoginPyme);

        if ("SI".equals(realizarMR)) {
            controller.SetPrioridaMr(riesgo);
            String script = "return navigator.userAgent;";
            userAgent = (String) pageLoginPyme.getJse().executeScript(script);
        }

        final boolean primeroGuardar = TP_PEND_APR.equals(tipoPrueba);

        switch (servicio) {
            case "Nómina":
            case "Pago de Nómina":
            case "Pago de Nóminas":
            case "Pago a Proveedores":
            case "Pagos a proveedores":
            case "Pagos proveedores":
            case "Proveedores":
            case "AFC":
            case "Pago a Créditos de Terceros":
            case "Pagos a créditos de terceros":
            case "Crédito.3ros":
                controller.crearPagoNomina_Proveedores(primeroGuardar); break;

            case "Pago de Servicios":
            case "Servicios":
                controller.crearPagoServicios(primeroGuardar); break;

            case "Pagos Automaticos":
                controller.crearPagosAutomaticos(primeroGuardar); break;

            case "Transferencias Mismo NIT":
            case "Transferencia NIT Propio":
            case "Mismo NIT":
                controller.crearTranferenciaMismoNit(primeroGuardar); break;

            case "Transferencias Cuenta Inscrita":
            case "Cuenta Inscrita":
                controller.crearTransferenciaCtaInscrita(primeroGuardar); break;

            case "Transferencias Cuenta No Inscrita":
            case "Transferencias Cuenta NO Inscrita":
            case "Cuenta No Inscrita":
                controller.crearTransferenciaCtaNoInscrita(primeroGuardar); break;

            case "ORPA":
                controller.OrdenesDePago(); break;

            case "Pagos Propios":
                controller.crearPagosPropios(primeroGuardar); break;

            case "Avances Tarjeta de Crédito":
            case "Avance TC":
                controller.crearAvanceTC(primeroGuardar); break;

            case "Tx Internacionales Recibir desde el exterior":
                controller.Recibirdinerodelexterior(primeroGuardar); break;

            case "Tx Internacionales Enviar al exterior":
                controller.EnviarTransferenciasInternacionales(primeroGuardar); break;

            case "Tx Internacionales Enviar al exterior Pendiente Aprobación":
                controller.inicioCrearTx();
                controller.EnviarTransferenciasInternacionalesPendAprobacion(); break;

            case "Divisas Documentos y Formularios":
                flujoDivisasDocumentosYFormularios(primeroGuardar);
                break;

            case "Consulta Tx Internacionales Validar Estado":
                controller.inicioCrearTx();
                pageConsultatxInternacional = new PageConsultatxInternacional(pageLoginPyme);
                pageConsultatxInternacional.ConsultaNumtx(tipoPrueba, empresa, servicio, usuario, tipoConstaTxRealizadas,
                        ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda, fechaTx, horaTx, fechaDesde, fechaHasta, valorTx);
                break;
        }

        // Aprobaciones pendientes (no-internacionales)
        if (primeroGuardar && !servicio.contains("Internacionales") || (primeroGuardar && !servicio.contains("Internacionales") && DatosDavivienda.IS_RISKMOTOR)) {
            controller.aprobarTxPendiente(DE_El_DETALLE.equals(desde_el_Detalle));
        }

        // Aprobaciones pendientes internacionales
        if (primeroGuardar && servicio.contains("Internacionales") && !servicio.contains("Aprobación")
                || (primeroGuardar && servicio.contains("Internacionales") && DatosDavivienda.IS_RISKMOTOR)) {
            controller.aprobarTxPendienteIntern(DE_El_DETALLE.equals(desde_el_Detalle));
        }

        // Firma única / múltiples firmas y consultas
        posTransaccionYConsultas(primeroGuardar);

        // Cobros (si aplica)
        if ("SI".equals(cobros)) validarCobros();

        pageLoginPyme.changeToDefaultFrame();
        pageLoginPyme.CerrarSesionFront();
        pass("Transación exitosa");
        SettingsRun.exitTestIteration();
    }

    private void flujoDivisasDocumentosYFormularios(boolean primeroGuardar) throws Exception {
        String msg;
        controller.inicioCrearTx();
        pageDocumentos_Y_Formularios = new PageDocumentos_Y_Formularios(pageLoginPyme);
        pageDivisas = new PageDivisas(pageLoginPyme);

        if (pageDivisas.switchToFrameDivisas()) {
            msg = pageDocumentos_Y_Formularios.IralModuloDocumetosYFormularios(tipoPrueba, servicio, fechaTx, horaTx, tipoMoneda);
            if (msg != null && !msg.isEmpty()) { fail(msg); pagePortalPymes.terminarIteracion(); return; }

            // Datos
            String concepTx = p("Concepto de la transferencia");
            String numCambiario1 = Util.left(p("Numeral cambiario 1"), 4);
            String valorNumeral1 = p("Valor numeral cambiario 1");
            String numCambiario2 = Util.left(p("Numeral cambiario 2"), 4);
            String valorNumeral2 = p("Valor numeral cambiario 2");
            String tipoOperacion = p("Tipo de operación");
            String desInversion = p("Destino de la inversión");
            String opciondeinversion = p("Opción de inversión");
            String deducciones = p("Deducciones");
            String cambiarConcepto = p("Cambiar Concepto de la transferencia");
            String conceptoAcambiar = p("Concepto de la transferencia A Cambiar");
            String numeroDeposito = p("Número de depósito 1");
            String numeroFacturaoReferDeclaracion = p("Número de declaración 1");
            String cambiarlistnumeralOperacion_Numeral1 = p("Cambiar Numeral cambiario 1");
            String numeral1Acambiar = p("Numeral cambiario A Cambiar 1");
            String cambiarDatosDescripciondelaoperacion = p("Cambiar Datos Descripción de la operación");

            String tipodeidentificacionReceptora = p("Empresa receptora - Tipo de identificación");
            String numerodeidentificacionReceptora = p("Empresa receptora - Número de identificación");
            String digitodeverificacionReceptora = p("Empresa receptora - Dígito de verificación");
            String nombreorazonsocialReceptora = p("Empresa receptora - Nombre o razón social");
            String codigopaisReceptora = p("Empresa receptora - Código país");
            String codigodepartamentoReptora = p("Empresa receptora - Código departamento");
            String codigociudadReptora = p("Empresa receptora - Código ciudad");
            String codigoCIIUReptora = p("Empresa receptora - Código CIIU");
            String telefonoReptora = p("Empresa receptora - Teléfono");
            String direccionReptora = p("Empresa receptora - Dirección");
            String correoReptora = p("Empresa receptora - Correo electrónico");
            String sectorReptora = p("Empresa receptora - Sector");
            String tipodeempresaReptora = p("Empresa receptora - Tipo de empresa");
            String superintendenciaReptora = p("Empresa receptora - Superintendencia de vigilancia");
            String actividadReptora = p("Empresa receptora - Actividad");
            String tipoderegimenReptora = p("Empresa receptora - Tipo de régimen");
            String naturalezaReptora = p("Empresa receptora  - Naturaleza");

            pageDocumentos_Y_Formularios.EmpresaReceptora(tipodeidentificacionReceptora, numerodeidentificacionReceptora,
                    digitodeverificacionReceptora, nombreorazonsocialReceptora, codigopaisReceptora,
                    codigodepartamentoReptora, codigociudadReptora, codigoCIIUReptora, telefonoReptora, direccionReptora,
                    correoReptora, sectorReptora, tipodeempresaReptora, superintendenciaReptora, actividadReptora,
                    tipoderegimenReptora, naturalezaReptora);

            String identificacionInversionista = p("Identificación del inversionista - Tipo de identificación");
            String numerodeidentificacionInversionista = p("Identificación del inversionista - Número de identificación");
            String digitodeverificacionInversionista = p("Identificación del inversionista - Dígito de verificación");
            String nombreorazonsocialInversionista = p("Identificación del inversionista - Nombre o razón social");
            String codigoPaisInversionista = p("Identificación del inversionista - Código país");
            String codigoDepartamentoInversionista = p("Identificación del inversionista - Código departamento");
            String codigociudadInversionista = p("Identificación del inversionista - Código ciudad");
            String codigoCIIUInversionista = p("Identificación del inversionista - Código CIIU");
            String correoElectronicoInversionista = p("Identificación del inversionista - Correo electrónico");
            String sectorInversionista = p("Identificación del inversionista - Sector");
            String tipodeempresaInversionista = p("Identificación del inversionista - Tipo de empresa");
            String superintendenciaInversionista = p("Identificación del inversionista - Superintendencia de vigilancia");
            String naturalezaInversionista = p("Identificación del inversionista - Naturaleza");
            String telefonoInversionista = has("Identificación del inversionista - Teléfono") ? p("Identificación del inversionista - Teléfono") : "";
            String direccionInversionista = has("Identificación del inversionista - Dirección") ? p("Identificación del inversionista - Dirección") : "";

            pageDocumentos_Y_Formularios.Inversionista(identificacionInversionista, numerodeidentificacionInversionista,
                    digitodeverificacionInversionista, nombreorazonsocialInversionista, codigoPaisInversionista,
                    codigoDepartamentoInversionista, codigociudadInversionista, codigoCIIUInversionista, correoElectronicoInversionista,
                    sectorInversionista, tipodeempresaInversionista, superintendenciaInversionista, naturalezaInversionista,
                    telefonoInversionista, direccionInversionista);

            String numerodelprestamooaval = p("Número del préstamo o aval");
            String nombredelacreedoroeldeudoroavalista = p("Nombre del acreedor o el deudor o avalista");
            String nombredeldeudoroacreedorAvaladoobeneficiarioresidente = p("Nombre del deudor o acreedor / Avalado o beneficiario residente");
            String tipodeidentificacióndeldeudor = p("Tipo de identificación del deudor");
            String numerodeidentificaciondeldeudor = p("Número de identificación del deudor");
            String digitodeverificacion = p("Dígito de verificación");
            String monedaestipulada = p("Moneda estipulada");
            String valormonedaestipulada = p("Valor moneda estipulada");
            String tasadecambiomoneda = p("Tasa de cambio moneda");
            String cambiarValornumeralcambiario1 = p("Cambiar Valor numeral cambiario 1");
            String ValorNumeral1Camb = p("Valor numeral cambiario A Cambiar 1");
            String validacionAdicionar = p("Validar Numerales");
            String validacionDian = p("Validacion - DIAN");

            String[] rutaArch = p("Cargue Archivo Documentos").split(",");

            msg = pageDocumentos_Y_Formularios.DatosDocumetosYFormularios(concepTx, tipoOperacion, desInversion, opciondeinversion,
                    valorTx, numCambiario1, valorNumeral1, numCambiario2, valorNumeral2, deducciones, cambiarConcepto,
                    conceptoAcambiar, numeroDeposito, numeroFacturaoReferDeclaracion, cambiarlistnumeralOperacion_Numeral1,
                    numeral1Acambiar, cambiarDatosDescripciondelaoperacion, numerodelprestamooaval, nombredelacreedoroeldeudoroavalista,
                    nombredeldeudoroacreedorAvaladoobeneficiarioresidente, tipodeidentificacióndeldeudor,
                    numerodeidentificaciondeldeudor, digitodeverificacion, monedaestipulada, valormonedaestipulada,
                    tasadecambiomoneda, cambiarValornumeralcambiario1, ValorNumeral1Camb, validacionAdicionar, validacionDian, rutaArch);

            if (msg != null && !msg.contains("Documentos enviados exitosamente.")) {
                fail(msg);
                pagePortalPymes.terminarIteracion();
            }
        }
    }

    private void posTransaccionYConsultas(boolean primeroGuardar) throws Exception {
        numAprobaciones = p("Números de Aprobaciones");
        informe = p("Informes");
        boolean unaFirma = CN_APRO_PEND.equals(numAprobaciones);

        pageConsultasyExtractos = new PageConsultasyExtractos(pageLoginPyme);

        if (!unaFirma) {
            pageLoginPyme.CerrarSesionFront();
            int firmas = Integer.parseInt(numAprobaciones);
            for (int i = 2; i <= firmas; i++) {
                Frontfirmas(i);

                if (!servicio.contains("Internacionales") && !servicio.contains("Pagos Automaticos")) {
                    controller = new ControllerCrearTx(pageLoginPyme);
                    if ("SI".equals(realizarMR)) controller.SetPrioridaMr(riesgo);

                    Util.wait(10);
                    controller.aprobarTxPendiente(DE_El_DETALLE.equals(desde_el_Detalle));
                    if (i == firmas) controller.validacionSaldosStratus();

                    if (i == firmas) {
                        String tipoProduct = p("Tipo producto origen / Franquicia");
                        String numeroProducto = p("Número producto origen");
                        pageConsultasyExtractos.ConsultayExtractos(servicio, p("Navegador"), tipoIDEmpresa, numeroIDEmpresa,
                                tipoIdentificacion, Idusuario, tipoProduct, numeroProducto, primeroGuardar);
                    }
                } else if (servicio.contains("Pagos Automaticos")) {
                    pageTransaccionesProgramadas = new PageTransaccionesProgramadas(pageLoginPyme);
                    pageTransaccionesProgramadas.ConsultaPagosAutomatico();
                } else if (servicio.contains("Internacionales")) {
                    Util.wait(10);
                    controller.aprobarTxPendienteIntern(primeroGuardar);
                    if (i == firmas) {
                        pageConsultatxInternacional = new PageConsultatxInternacional(pageLoginPyme);
                        if (isNullOrEmpty(fechaTx) || isNullOrEmpty(horaTx)) {
                            fechaTx = p("Fecha tx"); horaTx = p("Hora tx");
                        }
                        estado = p("Estado");
                        pageConsultatxInternacional.ConsultaNumtx(tipoPrueba, empresa, servicio, usuario, tipoConstaTxRealizadas,
                                ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda, fechaTx, horaTx, fechaDesde, fechaHasta, valorTx);
                        pageConsultatxInternacional.getDriver().switchTo().defaultContent();
                    }
                }

                pageLoginPyme.CerrarSesionFront();

                if (i == firmas && DatosDavivienda.IS_RISKMOTOR) {
                    if (servicio.contains("Nómina") || servicio.contains("Pago a Proveedores")
                            || servicio.contains("AFC") || servicio.contains("Crédito.3ros")) {
                        controller.validarIngresoMRDestinosMasivo();
                    } else {
                        controller.validarIngresoMR();
                    }
                }
            }
        } else {
            boolean internacionales = false;

            if ((!servicio.contains("Internacionales") && !servicio.contains("Divisas"))
                    && !servicio.contains("Pagos Automaticos") && !servicio.contains("ORPA")) {
                String tipoProduct = p("Tipo producto origen / Franquicia");
                String numeroProducto = p("Número producto origen");
                String _estado = pageConsultasyExtractos.ConsultayExtractos(servicio, p("Navegador"), tipoIDEmpresa,
                        numeroIDEmpresa, tipoIdentificacion, Idusuario, tipoProduct, numeroProducto, primeroGuardar);

                if ("NO SE ENCONTRARON DATOS".equals(_estado)) {
                    if (DatosDavivienda.IS_RISKMOTOR) {
                        if (servicio.contains("Númina") || servicio.contains("Pago a Proveedores")
                                || servicio.contains("AFC") || servicio.contains("Crédito.3ros")) {
                            controller.validarIngresoMRDestinosMasivo();
                        } else {
                            controller.validarIngresoMR();
                        }
                    }
                    pagePortalPymes.terminarIteracion();
                }
                estadotxFinal = pageConsultasyExtractos.estadoFinalTx();
                if (servicio.contains("Nómina") || servicio.contains("Pago a Proveedores") || servicio.contains("AFC")
                        || servicio.contains("Crédito.3ros")) {
                    if (pagePortalPymes.CuentaDesMotor() != null) {
                        controller.cuentasDesMotor = pagePortalPymes.CuentaDesMotor();
                    }
                }
            } else if (servicio.contains("Pagos Automaticos")) {
                pageTransaccionesProgramadas = new PageTransaccionesProgramadas(pageLoginPyme);
                pageTransaccionesProgramadas.ConsultaPagosAutomatico();

            } else if ((servicio.contains("Internacionales") || servicio.contains("Divisas"))
                    && !servicio.contains("Aprobación") && !servicio.contains("Validar")) {
                pageConsultatxInternacional = new PageConsultatxInternacional(pageLoginPyme);
                if (isNullOrEmpty(fechaTx) || isNullOrEmpty(horaTx)) {
                    fechaTx = p("Fecha tx"); horaTx = p("Hora tx");
                }
                estado = p("Estado");

                pageConsultatxInternacional.ConsultaNumtx(tipoPrueba, empresa, servicio, usuario, tipoConstaTxRealizadas,
                        ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda, fechaTx, horaTx, fechaDesde, fechaHasta, valorTx);

                if ("SI".equals(stratus)) pageConsultatxInternacional.ValidacionesStratusConsulta();
                pageConsultatxInternacional.getDriver().switchTo().defaultContent();

                if ("SI".equals(informe)) {
                    // Re-uso Middle login para informe
                    DatosEmpresarial.loadLoginDataFija("0", numCliEmp, tipoDoc, numDoc, clave, datoTok);
                    String[] datosLogin = DatosEmpresarial.getLoginData();
                    Reporter.write("Datos de Logueo [" + Util.arrayToString(datosLogin, " - ") + "]");

                    pageLoginPyme = new PageLoginPymes();
                    String msgError = pageLoginPyme.loginMiddle();
                    pageLoginPyme.selecionambienteClose("SI");

                    if (msgError == null) {
                        controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);
                        numAprobaciones = p("Números de Aprobaciones");
                        controllerValiPymeMiddle.ValidacionInformeTransInternacional();
                    }
                } else {
                    pageOrigen.getDriver().switchTo().defaultContent();
                    internacionales = true;
                }
            } else if ((servicio.contains("Internacionales") || servicio.contains("Divisas"))
                    && servicio.contains("Aprobación") && !servicio.contains("Validar Estado")) {
                pageConsultatxInternacional = new PageConsultatxInternacional(pageLoginPyme);
                if (isNullOrEmpty(fechaTx) || isNullOrEmpty(horaTx)) {
                    fechaTx = p("Fecha tx"); horaTx = p("Hora tx");
                }
                estado = p("Estado");
                pageConsultatxInternacional.ConsultaNumtx(tipoPrueba, empresa, servicio, usuario, tipoConstaTxRealizadas,
                        ordenanteBeneficiario, tipoTranferencia, estado, tipoMoneda, fechaTx, horaTx, fechaDesde, fechaHasta, valorTx);
            }

            if (estado != null) controller.SetEstado(estado);

            if (DatosDavivienda.IS_RISKMOTOR) {
                if (servicio.contains("Nómina") || servicio.contains("Pago a Proveedores")
                        || servicio.contains("AFC") || servicio.contains("Crédito.3ros")) {
                    controller.validarIngresoMRDestinosMasivo();
                } else {
                    controller.validarIngresoMR();
                }
            }

            if ("SI".equals(cobros)) {
                pageAdminCombosCobros = new PageAdminCombosCobros(pageLoginPyme);
                validacionDescuento = controller.validacionDescuentoTx(resultsMiddle, segmentosStratus, estadotxFinal,
                        PageAdminCombosCobros.getInformacionConsultada());
            }
        }
    }

    private void validarCobros() throws Exception {
        double sumaCobros = 0;
        String tipoCobro = p("Tipo Prueba Cobros");
        String verificarCombo = resultsMiddle.get(0).get("Verificacion Combo");

        if (("COBROS CON COMBOS".equals(tipoCobro) && verificarCombo.contains("Empresa tiene combo"))
                || ("COBROS SIN COMBOS".equals(tipoCobro) && verificarCombo.contains("Empresa tiene combo"))) {

            int totalCantidadTx = Integer.parseInt(resultsMiddle.get(0).get("Cantidad Tx Acumuladas"));
            if (totalCantidadTx > 0) {
                // login middle para actualizar contadores
                DatosEmpresarial.loadLoginDataFija("0", g("MIDDLE.tipoDoc"), g("MIDDLE.numeroDeId"),
                        g("MIDDLE.clavePersonal"), g("MIDDLE.tipoToken"), g("MIDDLE.numeroToken"));

                String[] datosLogin = DatosEmpresarial.getLoginData();
                info("*** Datos de Logueo Middle: [" + Util.arrayToString(datosLogin, " - ") + "]");

                pageLoginPyme = new PageLoginPymes();
                String msgError = pageLoginPyme.loginMiddle();
                pageLoginPyme.selecionambienteClose("SI");

                controllerValiPymeMiddle = new ControllerValiPymeMiddle(pageLoginPyme);
                controllerMiddleCobros = new ControllerMiddleCobros(pageLoginPyme);

                int[] infoContador = ControllerCrearTx.getTotalContador();
                controllerMiddleCobros.contadorFinal(infoContador, verificarCombo);
                pageLoginPyme.CerrarSesionMiddle();

                info("*** Cobros realizados en esta transacción");
                for (int i = 0; i < validacionDescuento.length; i++) {
                    double v = validacionDescuento[i];
                    info("Valor de cobro " + (i + 1) + ": " + v);
                    sumaCobros += v;
                }
                info("*** Total cobros realizados: " + sumaCobros);
            } else {
                info("No se ha aplicado ninguna sumatoria de tx porque no se aplico ningun descuento");
            }
        } else {
            info("*** Cobros realizados en esta transacción - Los cobros sin combos no aplica contador");
            for (int i = 0; i < validacionDescuento.length; i++) {
                double v = validacionDescuento[i];
                info("Valor de cobro " + (i + 1) + ": " + v);
                sumaCobros += v;
            }
            info("*** Total cobros realizados: " + sumaCobros);
            SettingsRun.exitTestIteration();
        }
    }

    // ============================== Motor de riesgo =====================================
    public void adicionarRegistroMR(String tx) throws Exception {
        DatosDavivienda.RISKMOTOR.adicionarRegistro();
        DatosDavivienda.RISKMOTOR.setTemporalTime(fechaHoraLogMR);
        DatosDavivienda.RISKMOTOR.setTime();
        DatosDavivienda.RISKMOTOR.setCanal("WEB_PYME");
        DatosDavivienda.RISKMOTOR.setAmbienteDePruebas(nombreAmbiente);
        DatosDavivienda.RISKMOTOR.setMonto();
        DatosDavivienda.RISKMOTOR.setNumeroTx();
        DatosDavivienda.RISKMOTOR.setResultado();
        DatosDavivienda.RISKMOTOR.setObservacion();
        DatosDavivienda.RISKMOTOR.setObservacion(p("Desde_el_Detalle"));
        DatosDavivienda.RISKMOTOR.setHash(p("Hash"));

        if (controller == null && !TP_LOGIN.equals(tipoPrueba)) controller = new ControllerCrearTx(pageLoginPyme);
        servicio = p("Servicio");

        if (!TP_LOGIN.equals(tipoPrueba)) {
            DatosDavivienda.RISKMOTOR.setTransaccion(controller.getTransaccion(tipoPrueba, servicio));
        } else {
            DatosDavivienda.RISKMOTOR.setTransaccion("Login Exitoso");
        }

        String userType = DatosEmpresarial.TIPO_TOKEN.equals(DatosEmpresarial.TOKEN_OTP) ? "Virtual" : "Token";
        String intentos = p("Ingresos Fallidos");
        int intentosFall = Util.isInteger(intentos) ? Integer.parseInt(intentos) : 0;

        DatosDavivienda.RISKMOTOR.setUserType(userType);
        DatosDavivienda.RISKMOTOR.setRisk(riesgoBc);
        if (!servicio.equals("Tx Internacionales Recibir desde el exterior")
                && !servicio.equals("Tx Internacionales Enviar al exterior")) {
            DatosDavivienda.RISKMOTOR.setRiskEFM(riesgoEfm);
        }

        DatosDavivienda.RISKMOTOR.setNumRetosFallidos(intentosFall);
        DatosDavivienda.RISKMOTOR.setNavegador_SistemaOperativo(p("Navegador"));
        DatosDavivienda.RISKMOTOR.setCliente(DatosEmpresarial.CLI_EMPRESAR);
        DatosDavivienda.RISKMOTOR.setDocumento(DatosEmpresarial.TIPO_ID_LOGUEO, DatosEmpresarial.NUM_ID_LOGUEO);

        if ("Login".equals(tx)) {
            DatosDavivienda.RISKMOTOR.setCuentaOrigen(Motorna);
            DatosDavivienda.RISKMOTOR.setCuentaDestino(Motorna);
            DatosDavivienda.RISKMOTOR.setNumCuentaOrigen(Motorna);
            DatosDavivienda.RISKMOTOR.setNumCuentaDestino(Motorna);
            DatosDavivienda.RISKMOTOR.set_CtaOrigenODestMIGRADA(Motorna);
            DatosDavivienda.RISKMOTOR.setNumTxCanal(Motorna);
            DatosDavivienda.RISKMOTOR.setNumIdEmpresa(Motorna);
        }

        if ("Error en Login".equals(tx)) {
            if ("Bajo".equals(riesgo) || "Medio".equals(riesgo)) {
                DatosDavivienda.RISKMOTOR.setObservacion("El comportamiento de la prueba no es correcto para el tipo de riesgo - error en login");
            }
            DatosDavivienda.RISKMOTOR.setTemporalResultado("Declinada");
            DatosDavivienda.RISKMOTOR.setResultado();
        }

        pass("*** Se adiciona al MR");
    }

    // ============================== Stratus / C360 / Ventanas ===========================
    public void LoginStratus() throws Exception {
        if ("SI".equals(stratus)) {
            if (instanciaStratus == null) {
                instanciaStratus = new StratusProductos(g("STRATUS.usuario"), g("STRATUS.password"));
                info("Se cargan datos para logueo de Stratus");
            }
        }
    }

    public PageInicioC360 logueoC360() throws Exception {
        Reporter.write("*** Validar CLIENTE 360 ***");
        pageLoginC360 = new PageLogin(BasePageWeb.CHROME);
        pageInicioC360 = new PageInicioC360(pageLoginC360);
        pageLoginC360.login360(g("data.c360User"), g("data.c360Pwd"));
        return pageInicioC360;
    }

    public boolean ThereareOpenWindows() {
        try {
            Set<String> windowHandles = pageLoginPyme.getDriver().getWindowHandles();
            return !windowHandles.isEmpty();
        } catch (Exception e) {
            return false;
        }
    }

    public Boolean WaitForNumberOfWindos() {
        WebDriverWait wait = new WebDriverWait(pageLoginPyme.getDriver(), 30);
        return wait.until(ExpectedConditions.numberOfWindowsToBe(2));
    }

    // ============================== launchClose =========================================
    @Override
    public void launchClose() {
        SettingsRun.CREATE_FINAL_EVIDENCES_WHEN_NOPDF = false;

        if (DatosDavivienda.RISKMOTOR != null && SettingsRun.esIteracionFinal())
            DatosDavivienda.RISKMOTOR.cerrarMotorRiesgo();

        closeAllIfAny();

        if (instanciaStratus != null)
            instanciaStratus.closeStratus();
    }
}
